var selectionchange=function(e){function t(t){var n=t.onselectionchange;if(n!==e)try{return t.onselectionchange=0,null===t.onselectionchange}catch(e){}finally{t.onselectionchange=n}return!1}function n(){return"undefined"!=typeof WeakMap?new WeakMap:(console.error("selectionchange: WeakMap not supported"),null)}function i(e){var t=e.getSelection();return t.rangeCount?t.getRangeAt(0):null}function r(e,t,n){e.addEventListener(t,n,!0)}function a(e,t,n){e.removeEventListener(t,n,!0)}function o(e){C[e.target.tagName]||d(this,!0)}function s(e){var t=e.keyCode;(65===t&&e[v]&&!e.shiftKey&&!e.altKey||t>=35&&t<=40||e.ctrlKey&&p&&h.indexOf(t)>=0)&&(C[e.target.tagName]||setTimeout(d.bind(null,this),0))}function u(e){0===e.button&&(r(this,"mousemove",l),setTimeout(d.bind(null,this),0))}function l(e){1&e.buttons?d(this):a(this,"mousemove",l)}function c(e){0===e.button?setTimeout(d.bind(null,this),0):a(this,"mousemove",l)}function f(){setTimeout(d.bind(null,this.document),0)}function d(e,t){var n=i(e);!t&&g(n,m.get(e))||(m.set(e,n),setTimeout(e.dispatchEvent.bind(e,new Event("selectionchange")),0))}function g(e,t){return e===t||e&&t&&b.every(function(n){return e[n]===t[n]})}var m,p=/^Mac/.test(navigator.platform),h=[65,66,69,70,78,80],v=p?"metaKey":"ctrlKey",b=["startContainer","startOffset","endContainer","endOffset"],C={INPUT:1,TEXTAREA:1};return{start:function(e){var a=e||document;(m||!t(a)&&(m=n()))&&(m.has(a)||(m.set(a,i(a)),r(a,"input",o),r(a,"keydown",s),r(a,"mousedown",u),r(a,"mousemove",l),r(a,"mouseup",c),r(a.defaultView,"focus",f)))},stop:function(e){var t=e||document;m&&m.has(t)&&(m.delete(t),a(t,"input",o),a(t,"keydown",s),a(t,"mousedown",u),a(t,"mousemove",l),a(t,"mouseup",c),a(t.defaultView,"focus",f))},hasNativeSupport:function(e){return t(e)}}}();define("readium_plugin_nypl_private/private1/selection/lib/selectionchange-polyfill",[],function(){return selectionchange}),define("readium_plugin_nypl_private/private1/selection/selection",["jquery","underscore","readium_shared_js/globals","./lib/selectionchange-polyfill","readium_shared_js/helpers"],function(e,t,n,i,r){function a(a){function o(){b&&console.log.apply(console,arguments)}function s(){return/Android/i.test(navigator.userAgent)}function u(){return/iP(ad|od|hone)/i.test(navigator.userAgent)}function l(e){var t=e.cloneRange(),n=e.cloneRange();t.collapse(!0);var i=t.getBoundingClientRect();return n.collapse(!1),{start:i,end:n.getBoundingClientRect()}}function c(e){i.start(e);var n=e?e.getSelection():null,r=e?e.body.firstElementChild:null;if(n&&r){var a=e.createRange();a.setStartBefore(r),a.setEndBefore(r),n.addRange(a),n.removeAllRanges()}e.addEventListener("touchstart",function t(){y=!0,e.removeEventListener("touchstart",t)}),L=s()?p(e):u()?m(e):g(e),t.each(L,function(t,n){e.addEventListener(n,t)})}function f(e){i.stop(e);var n=e?e.getSelection():null;n&&n.removeAllRanges(),I(E.CLEARED),t.each(L,function(t,n){e.removeEventListener(n,t)})}function d(e,t){var n=h;if(!n)return null;var i=n.toString(),r=n.isCollapsed?null:n.getRangeAt(0),a={eventType:e,cfi:null,text:i,range:r,document:r?r.startContainer.ownerDocument:null,coordinates:null,isMobile:y,clear:t||function(){n.removeAllRanges()}};if(r){var o=r.cloneRange();Object.defineProperty(a,"cfi",{get:function(){return C.getRangeCfiFromDomRange(o)}}),Object.defineProperty(a,"coordinates",{get:function(){var e=l(o);return{start:{clientX:e.start.left,clientY:e.start.top,width:e.start.width,height:e.start.height},end:{clientX:e.end.right,clientY:e.end.bottom,width:e.end.width,height:e.end.height}}}})}return a}function g(e){function n(){o("selection cleared"),s=!0,h=null;var e=l?l.getSelection():null;e&&e.removeAllRanges(),I(E.CLEARED)}function i(){o("selection event"),u=!1;var e=!1;h||(e=!0);var t=l?l.getSelection():null;return t&&t.isCollapsed?(h=null,void(e||s||(s=!0,n()))):(h=t,s=!1,e?void r():void I(E.CHANGED,d(E.CHANGED)))}function r(){o("selection start"),I(E.START,d(E.START))}function a(){t.defer(function(){h||s?h&&!u&&(u=!0,o("selection end",h),I(E.END,d(E.END))):n()})}var s,u,l=e;return v=n,{selectionchange:i,dblclick:i,mouseup:a,keyup:a,touchend:a}}function m(e){var t,n=g(e),i=n.selectionchange;return n.selectionchange=function(){clearTimeout(t),i(),t=setTimeout(n.touchend,300)},n}function p(n){function i(e,t){return e.x>t.left&&e.x<t.right&&e.y>t.top&&e.y<t.bottom}function a(e,t,n){return{x:e.left+t,y:e.bottom+n}}function s(e,t){var n=t/2;return{left:e.x-n,right:e.x+n,top:e.y-n,bottom:e.y+n}}function u(e){return o("selectstart"),e.preventDefault(),!1}function c(e){return o("selectionchange","touch"),clearTimeout(O),e.preventDefault(),!1}function f(e){o("touchstart",e),A=setTimeout(function(){e=e.targetTouches[0],w(30),o("createInitialSelection");var t=e.clientX||e.pageX,n=e.clientY||e.pageY,i=D.caretRangeFromPoint(t,n),r=D.elementFromPoint(t,n);if(D.documentElement!==r){var a=D.getSelection();a.removeAllRanges(),a.addRange(i),a=D.getSelection(),S=P(a),""==S&&(S=i),p(),j=setTimeout(function(){C()},k-25)}},k),O=setTimeout(function(){b()},k-50),e.preventDefault()}function g(e){o("touchend","clearTimeout",e),clearTimeout(A)}function m(e){o("touchmove","clearTimeout",e),clearTimeout(O)}function p(){o("startSelection"),clearTimeout(A),D.addEventListener("touchstart",y),D.addEventListener("touchend",T),D.addEventListener("touchmove",_),h=D.getSelection(),N(h.getRangeAt(0)),I(E.START,d(E.START,b))}function b(){o("clearSelection"),D.getSelection().removeAllRanges(),S=null,D.removeEventListener("touchstart",y),D.removeEventListener("touchend",T),D.removeEventListener("touchmove",_),h=null,R=!0,F(),clearTimeout(j),I(E.CLEARED)}function C(){o("endSelection"),I(E.END,d(E.END,b))}function L(e,t){var n=l(t),r=s(a(n.start,10,10),35);return i(e,s(a(n.end,10,10),35))?"end":i(e,r)?"start":"none"}function y(e){o("updateSelectionStart",e);var t=e.changedTouches[0],n={x:t.clientX,y:t.clientY},i=L(n,h.getRangeAt(0));o("selTouchState",i),"none"!==i&&(clearTimeout(A),D.addEventListener("touchmove",_))}function T(e){o("updateSelectionEnd",e);var t=e.changedTouches[0],n={x:t.clientX,y:t.clientY},i=L(n,h.getRangeAt(0));o("selTouchState",i),R||"none"!==i||b(),R=!1,clearTimeout(A),D.removeEventListener("touchmove",_)}function _(e){o("updateSelection",e),e.preventDefault(),clearTimeout(A);var t=e.changedTouches[0],n={x:t.clientX,y:t.clientY};R||(n.y=n.y-x);var i=D.caretRangeFromPoint(n.x,n.y);if(!i)return void o("no focus");var r=new Range,a=1==S.compareBoundaryPoints(Range.START_TO_START,i);o("start",a?"focus":"selectionAnchor"),o("end",a?"selectionAnchor":"focus");var s=a?i:S,u=a?S:i;r.setStart(s.startContainer,s.startOffset),r.setEnd(u.startContainer,u.startOffset);var l=D.getSelection();l.removeAllRanges(),l.addRange(r),h=D.getSelection(),N(r),I(E.CHANGED,d(E.CHANGED,b)),clearTimeout(j),j=setTimeout(function(){C()},k-25)}function P(e){o("expandSelectionToWord"),e.collapse(e.anchorNode,e.anchorOffset),e.modify("move","forward","character"),e.modify("move","backward","word"),e.modify("extend","backward","character"),e.modify("extend","forward","word");var t="";return e.rangeCount>0&&(t=e.getRangeAt(0)),t}function N(t){var n=window.document,i=D.defaultView.frameElement.getBoundingClientRect();F();var r=l(t),a=e(n.createElement("div")),o=e(n.createElement("div"));a.appendTo(n.documentElement),o.appendTo(n.documentElement),a.addClass("rd-selection-handle left"),o.addClass("rd-selection-handle right");var s=a.width();x=a.height();a.css({position:"absolute",left:r.start.left+i.left-s,top:r.start.bottom+i.top}),o.css({position:"absolute",left:r.end.left+i.left,top:r.end.bottom+i.top})}function F(){e(".rd-selection-handle",window.document).remove()}var S,D=n,x=22,R=!0;r.polyfillCaretRangeFromPoint(D);var w=navigator.vibrate||navigator.webkitVibrate;w=w?t.bind(w,navigator):e.noop;var A,O,j,k=300;return v=b,{selectstart:u,selectionchange:c,touchstart:f,touchend:g,touchmove:m}}var h,v,b=!0,C=a.reader,I=t.bind(this.emit,this);this.getSelection=function(){return h},this.clearSelection=function(){v&&v()},this.hasSelection=function(){return!(!h||!h.toString().trim().length||h.isCollapsed)};var L,y=!1,E=this.Events={START:"start",CHANGED:"changed",END:"end",CLEARED:"cleared"};C.on(n.Events.CONTENT_DOCUMENT_LOADED,t.bind(function(e,t){c(e[0].contentDocument)},this)),C.on(n.Events.CONTENT_DOCUMENT_UNLOADED,t.bind(function(e,t){f(e[0].contentDocument)},this))}return a}),define("readium_plugin_nypl_private/private1/disablecopy",["jquery","underscore","readium_shared_js/globals"],function(e,t,n){function i(e){function i(e){return e.preventDefault(),!1}function r(e){s&&(e.contentDocument.addEventListener("copy",i),e.contentWindow.addEventListener("contextmenu",i))}function a(e){e.contentDocument.removeEventListener("copy",i),e.contentWindow.removeEventListener("contextmenu",i)}var o=e.reader,s=!0,u=new Set;this.start=function(){s=!0,u.forEach(function(e){r(e)})},this.stop=function(){s=!1,u.forEach(function(e){a(e)})},o.on(n.Events.CONTENT_DOCUMENT_LOADED,t.bind(function(e,t){r(e[0]),u.add(e[0])},this)),o.on(n.Events.CONTENT_DOCUMENT_UNLOADED,t.bind(function(e,t){a(e[0]),u.delete(e[0])},this))}return i}),define("readium_plugin_nypl_private/private1/accessibility/helpers",["jquery","underscore"],function(e,t){var n={};return n.supportsFocusScrollingProperly=function(){var t=document.createElement("div"),n=document.createElement("p"),i=document.createElement("p");e(t).css({position:"absolute",opacity:"0","font-size":"16px","line-height":"1","font-family":"Helvetica, sans-serif",overflow:"scroll",width:"250px",height:"250px","column-width":"250px","-moz-column-width":"250px","vertical-align":"baseline"}),n.textContent="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent quis feugiat leo, a pharetra magna. Curabitur volutpat nunc quam, eget commodo est placerat sed. Vivamus tellus metus, ultricies et auctor iaculis, viverra at elit. Donec eu facilisis est. Nam justo massa, malesuada quis neque id, tempus hendrerit est. Donec ac ultrices quam. Mauris consequat nisi vitae.lisis est.",t.appendChild(n),i.textContent="Vivamus tempor, felis quis tincidunt semper, leo arcu suscipit arcu, at molestie sem augue quis mauris. Curabitur ante dolor, malesuada semper est eu, facilisis efficitur ligula. Quisque sit amet nulla id augue lacinia molestie. Aliquam quis sem ut turpis laoreet tincidunt. Donec sit amet laoreet augue, eu accumsan nulla. Aliquam fringilla pellentesque turpis, ut fringilla lorem auctor in. Aenean tempus, orci id commodo fermentum, justo massa efficitur sapien, et egestas tortor elit id ante. Sed sit amet tristique mi. Curabitur vel lacinia leo. Etiam mattis, velit quis commodo elementum, dui risus ultrices mi, efficitur sodales mi nibh et orci. Donec tempor rhoncus tellus sit amet elementum. Curabitur dapibus at sapien non tempus.",t.appendChild(i),document.documentElement.appendChild(t),t.scrollLeft=250,i.setAttribute("tabindex","-1"),i.focus(),i.removeAttribute("tabindex","");var r=t.scrollLeft;return document.documentElement.removeChild(t),250===r},n.focusOnElement=function(e){e.attr("tabindex")?e.focus():(e[0].setAttribute("tabindex","-1"),e[0].setAttribute("data-rd-accessibility-focus-temp",""),t.defer(function(){e.focus(),e.one("blur",function(){e[0].removeAttribute("data-rd-accessibility-focus-temp")}),t.defer(function(){e[0].removeAttribute("tabindex")})}))},n}),define("readium_plugin_nypl_private/private1/accessibility/accessibility",["jquery","underscore","readium_shared_js/globals","readium_shared_js/helpers","./helpers"],function(e,t,n,i,r){function a(a){var o=a.reader;this.initialize=function(){var a=r.supportsFocusScrollingProperly();o.on(n.Events.CONTENT_DOCUMENT_LOAD_START,t.bind(function(e,t){e.attr("aria-busy","true")},this)),o.on(n.Events.CONTENT_DOCUMENT_LOADED,t.bind(function(e,t){e.focus();var r=i.createStyleSheet(e[0].contentDocument,"accessibility");o.once(n.Events.PAGINATION_CHANGED,function(){r.insertRule("[data-rd-accessibility-focus-temp]:focus {outline: none;}",0),e.attr("aria-busy","false")})},this)),o.on(n.Events.PAGINATION_CHANGED,function(t){if(a&&o.getCurrentViewType()===o.constructor.VIEW_TYPE_COLUMNIZED){var n=o.getCurrentView();if(!t.initiator||t.initiator!==n){var i;if(t.elementId)i=n._navigationLogic.getElementById(t.elementId);else if(t.elementCfi)try{i=n._navigationLogic.getElementByCfi(t.elementCfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message","MathJax_SVG_Hidden"])}catch(e){console.error(e)}else t.firstPage?i=e("body > :first-child",n._navigationLogic.getRootElement()):t.lastPage&&(i=e("body > :last-child",n._navigationLogic.getRootElement()));if(!i||!i.length){var s=o.getFirstVisibleCfi();if(s&&s.contentCFI){var u=o.getDomRangeFromRangeCfi(s),l=u.startContainer;if(l.nodeType===Node.TEXT_NODE&&0===u.startOffset)l=e(l).parent();else if(l.nodeType===Node.TEXT_NODE&&n._navigationLogic){var c=n._navigationLogic.getVisibleLeafNodes();e(c).length>0&&(l=e(c.element))}i=e(l)}}i&&i.length&&r.focusOnElement(i)}}})}}return a}),define("readium_plugin_nypl_private/private1/pagination/PagelistParser",["jquery","URIjs","readium_shared_js/globals","readium_js_plugins","readium_cfi_js","readium_shared_js/models/bookmark_data","underscore"],function(e,t,n,i,r,a,o){return function(n){function i(t){var n=d.getNcxDoc();d.getDomFromNav(n,function(n){if(n){var i=e("pageList>pageTarget",n);d.getPackageDOM(function(n){var r=o.map(i,function(t){var i=e(t);return s(i.attr("value")||i.attr("playOrder"),i.find("content").attr("src"),n)});t(r)})}})}function s(e,t,n){if(l(t)){var i=c(t,n);return i?{label:e,cfi:new a(i.idref,i.cfi)}:null}return{label:e,href:t}}function u(e,t,n){return e.getAttributeNS(t,n)||e.getAttribute(t+":"+n)}function l(e){return-1!==e.indexOf("#epubcfi(")}function c(e,t){var n=/#epubcfi\((.*?)\)/g.exec(e)[1],i=n.split("!"),a=r.getTargetElementWithPartialCFI("epubcfi("+i[0]+")",t),s=i[1],u=a.attr("idref"),l=f(),c=o.findWhere(l,{idref:u});return c?{idref:c.idref,cfi:s}:(console.warn("parseIntraPubCfiLink: cannot find spine entry with id",u),null)}function f(){return d.packageDocument.getSharedJsPackageData().spine.items}var d=this;this.packageDocument=n,this.generatePageListJSON=function(t){var n=this,r=this.getNavDoc();r?this.getDomFromNav(r,function(r){if(r){var a=e([]),l=e("nav",r);if(l.length<1&&"string"==typeof r){var c=e(r);l=o.filter(c,function(e){return"nav"===e.nodeName.toLowerCase()})}l=o.filter(l,function(e){return"page-list"===u(e,"epub","type")}),l.length>=1&&(a=e("ol>li",l[0])),a.length>0?n.getPackageDOM(function(n){var i=o.map(a,function(t){var i=e(t).children().first();return s(i.text(),i.attr("href"),n)});t(i)}):i(t)}}):i(t)},this.getNavDocHref=function(){var e=this.getNavDoc();return e?e.href:null},this.getNavDoc=function(){var e=this.packageDocument.manifest.getNavItem();return e||null},this.getNcxDoc=function(){var e=this.packageDocument.getMetadata().ncx;return e&&e.length>0?this.packageDocument.manifest.getManifestItemByIdref(e):null},this.getDomFromNav=function(e,t){this.packageDocument.resourceFetcher.relativeToPackageFetchFileContents(e.href,"text",function(e){t(e)},function(n){console.error("ERROR fetching NAV from ["+e+"]:"),console.error(n),t(void 0)})},this.navDocIsNCX=function(e){var n=e.href;return"ncx"===new t(n).suffix()};var g;this.getPackageDOM=function(e){if(g)return void e(g);this.packageDocument.resourceFetcher.getPackageDom(function(t){g=t,e(g)},function(t){console.error("ERROR fetching Package Document"),console.error(t),e(void 0)})}}}),define("readium_plugin_nypl_private/private1/pagination/PaginationHelpers",["jquery","readium_shared_js/globals","readium_js_plugins","readium_shared_js/models/bookmark_data","./PagelistParser","underscore"],function(e,t,n,i,r,a){return function(e,t){var n,o=new r(t);this.resolveHref=function(e){if(e){var t=o.getNavDocHref();return this.resolveContentUrl(e,t)}},this.goToHref=function(t){if(t){var n=o.getNavDocHref();e.reader.openContentUrl(t,n)}},this.goToCfi=function(t){if(t){var n=a.isString(t)?this.cfiStringToObj(t):t;if(n)return"**dummy**"===n.idref||"**dummy**"===n.contentCFI?void e.reader.openSpineIndexPage(-1,-1):void e.reader.openSpineItemElementCfi(n.idref,n.contentCFI)}},this.getCurrentSpineItems=function(){return e.reader.getLoadedSpineItems()},this.isVisibleCFI=function(t){var n=t;if(a.isString(n)&&(n=this.cfiStringToObj(n)),!n||!n.contentCFI)return!1;try{return e.reader.isVisibleSpineItemElementCfi(n.idref,n.contentCFI)}catch(e){return console.error(e),!1}},this.cfiStringToObj=function(e){if(!a.isString(e))return console.error("[EpubViewerHandler::CFIStringToObj] null input"),null;if(e.match(/^epubcfi\(/))return console.error("Absolute CFI used: Conversion from absolute CFIs to partial CFIs is no longer supported."),{idref:null,contentCFI:null};try{return i.fromString(e)}catch(e){return console.warn("Unable to get bookmark data from cfi!"),null}},this.contentCfiComparator=function(e,t){var n,i;if(null===e||void 0===e)return-1;if(null===t||void 0===t)return 1;n=a.partition(this.formatForComparison(this.parseContentCfi(e)),function(e){return a.isString(e)}),i=a.partition(this.formatForComparison(this.parseContentCfi(t)),function(e){return a.isString(e)});var r,o=n[1],s=i[1],u=n[0],l=i[0],c=Math.min(o.length,s.length);for(r=0;r<c;r++){if(o[r]>s[r])return 1;if(o[r]<s[r])return-1}if(o.length<s.length)return-1;if(s.length<o.length)return 1;u=u.map(function(e){return e.split(/:/)}),l=l.map(function(e){return e.split(/:/)});var f,d,g,m,p=Math.min(u.length,l.length);for(r=0;r<p;r++){if(f=u[r],d=l[r],f[0]>d[0])return 1;if(f[0]<d[0])return-1;if(f[0]===d[0])return g=parseInt(f[1]),m=parseInt(d[1]),Math.abs(g-m)<=20?0:g>m?1:-1}return-1},this.parseContentCfi=function(e){if(e){return e.replace(/\[(.*?)\]/,"").split(/[\/,]/).map(function(e){return a.includes(e,":")?e:parseInt(e)}).filter(function(e){return!a.isNaN(e)})}},this.formatForComparison=function(e){var t=e.length;a.isString(e[t-1])||e.push("1:0");var n,i=[e[0]],r=e[0];for(n=1;n<e.length;n++)r===e[n]&&2===r||(i.push(e[n]),r=e[n]);return i},this.formatLabelItems=function(e){var t=[];return e.forEach(function(e){if(typeof e.cfi===i)t.push(e);else{var n={cfi:{idref:e.cfi.idref,contentCFI:e.cfi.contentCFI},label:{label:e.label.label,index:e.label.index}};t.push(n)}}),t},this.resolveContentUrl=function(e,t,i){var r,a,o=this.resolveContentRefHelper(e,t),s=o.indexOf("#");s>=0?(r=o.substr(0,s),a=o.substr(s+1)):(r=o,a=void 0),n||(n=this.getSpine());var u=n.getItemByHref(r);if(!u){console.warn("spineItem "+r+" not found");var l=decodeURIComponent(r);if(!(u=n.getItemByHref(l)))return console.warn("decoded spineItem "+l+" missing as well"),!1}return{href:r,elementId:a,idref:u.idref}},this.resolveContentRefHelper=function(e,t){if(!t)return e;var n=t.split("/");n.pop();for(var i=e.split("/");n.length>0&&".."===i[0];)n.pop(),i.splice(0,1);return n.concat(i).join("/")},this.openSpineIndexPage=function(e,t,i){n||(n=this.getSpine());var r;if(!(r=-1===e?n.last():n.items[e]))return!1;var a=new PageOpenRequest(r,i);return-1===t?a.setLastPage():t&&a.setPageIndex(t),openPage(a,0),!0},this.getSpine=function(){return n||e.reader.spine()}}}),define("readium_plugin_nypl_private/private1/pagination/PagingHandler",["jquery","readium_shared_js/globals","readium_js_plugins","./PaginationHelpers","./PagelistParser","underscore"],function(e,t,n,i,r,a){return function(e,t){function n(t){var n;if(t.elementId){if(n=e.reader.getElementById(t.idref,t.elementId))return e.reader.getNearestCfiFromElement(n[0]);console.warn("getPageBreakCFIs: element not found in DOM with id ",t.elementId)}else{if(t.contentCFI)return t;if(n=e.reader.getElement(t.idref,"body")){var i=e.reader.getNearestCfiFromElement(n[0]),r=e.reader.getCfiForElement(n[0]),o=r.contentCFI+i.contentCFI;return a.extend(i,{contentCFI:o})}console.warn("getPageBreakCFIs: body not found for spine idref ",t.idref)}return null}var o=this,s={},u={},l={},c={},f=null,d=NaN,g=NaN;this.helpers=null,this.rawPageList=[],this.mappedPageList=[],this.mappedExtendedLabelsList=[],this.rawToc=[],this.init=function(e,t){return new Promise(function(n,a){o.helpers=new i(e,t);var s=!1;f=new r(t),f.generatePageListJSON(function(e){o.onPageListLoaded(e),(s=!0)&&n()})})},this.onPageListLoaded=function(e){if(e&&e.length){o.rawPageList=e;var t=(o.helpers.getSpine().items,-1),n=function(n){var i,r;if(o.addIdrefsToPagelist(e),t+=1,n.href)r=o.helpers.resolveHref(n.href),i=a.extend({label:n.label,hrefURL:n.href,index:t,idref:n.idref},r);else{if(!n.cfi)return void console.error("[Paging Handler] Invalid page list entry!");""===n.cfi.contentCFI&&(n.cfi.contentCFI="/0"),i=a.extend({label:n.label,index:t,idref:n.idref},n.cfi)}s[i.idref]||(s[i.idref]=[]),s[i.idref].push(i),a.isString(i.label)?u[i.label.toLowerCase()]=i:u[i.label]=i,o.mappedPageList.push(i),o.mapByIdfref=s,o.mapByLabel=u},i=NaN;d=-1,g=0,a.each(e,function(e){n(e),i=parseInt(e.label),a.isNaN(i)||(g=i,d<0&&(d=i))})}},this.mapExtendedLabels=function(e){var t=-1;a.each(e,function(e){t=o.mapExtendedListEntryFn(e,t)})},this.mapExtendedListEntryFn=function(e,t){var n,i;if(e.href)i=o.helpers.resolveHref(e.href),n=a.extend({label:e.label.label,hrefURL:e.href,index:t+1},i);else{if(!e.cfi)return void console.error("[Paging Handler] Invalid page list entry!");""===e.cfi.contentCFI&&(e.cfi.contentCFI="/0"),n=a.extend({label:e.label.label,index:t+1},e.cfi)}return t+=1,l[n.idref]||(l[n.idref]=[]),l[n.idref].push(n),a.isString(n.label)?c[n.label.toLowerCase()]=n:c[n.label.label]=n,o.mappedExtendedLabelsList.push(n),t},this.getIdrefForHref=function(e,t){for(var n=o.helpers.getSpine().items,i=void 0,r=t;r<n.length;r++){var s=n[r];if(i=s.idref,t=r,a.includes(e,s.href))return{idref:i,spineIndex:t}}return{idref:i,spineIndex:t}},this.addIdrefsToPagelist=function(e){var t=0,n=0;e.forEach(function(i){if(i.href){var r=o.getIdrefForHref(i.href,n);e[t]=a.extend(i,{idref:r.idref}),n=r.spineIndex,t++}})},this.getFromLabel=function(e){var t=u[a.isString(e)?e.toLowerCase():e];return t||(t=c[a.isString(e)?e.toLowerCase():e]),t},this.getFromPageNumber=function(e){return!o.mappedPageList||o.mappedPageList.length<1?(console.error("[Paging Handler] Mising pagelist!"),null):o.mappedPageList[Math.max(Math.min(o.mappedPageList.length,e)-1,0)]},this.getListByIdref=function(e){return s[e]},this.getLastNumericallyParsedPageLabel=function(){return g},this.getTotalPageNumber=function(){return o.mappedPageList.length},this.getLabelFromPageNumber=function(e){return!a.isNumber(e)||a.isNaN(e)||e<1||e>o.mappedPageList.length?null:o.mappedPageList[e-1].label},this.getLabelsFromPageNumberRange=function(e){var t,n,i,r,s=null,u=function(e){var t=parseInt(e);return o.getLabelFromPageNumber(t)};return a.isString(e)&&e.match(/\d+-\d+/)&&(t=e.split("-"),n=a.map(t,u),n=a.filter(n,function(e){return null!=e}),n.length>0&&(i=a.first(n),r=a.last(n),s=i!==r?[i,r]:[i])),s||(s=[u(e)]),s},this.getPageNumberFromLabel=function(e){var t=u[a.isString(e)?e.toLowerCase():e];return t?t.index+1:null},this.getFirstNumericallyParsedPageLabel=function(){return d},this.jumpToEntry=function(e){e.hrefURL?o.helpers.goToHref(e.hrefURL):e.contentCFI&&o.helpers.goToCfi(e)},this.jumpToLabel=function(e){var t=this;return new Promise(function(){var n=t.getFromLabel(e);if(!n)throw new Error("Label does not exist");return t.jumpToEntry(n)})},this.jumpToPageNumber=function(e){var t=this.getFromPageNumber(e);this.jumpToEntry(t)},this.jumpToIndex=function(e){var t=this.mappedPageList[e];this.jumpToLabel(t.label)},this.getVisibleLabelCFIs=function(){var e=o.helpers.getCurrentSpineItems(),t={};return a.each(e,function(e){var i=o.getListByIdref(e.idref),r=a.map(i,n),s=a.filter(r,function(e){return o.helpers.isVisibleCFI(e)});t[e.idref]=s}),t=t[Object.keys(t)[0]]},this.isOnLastPageOfCurrentSpread=function(e){var t=a.last(e.openPages);return t.spineItemPageIndex===t.spineItemPageCount-1},this.isOnFirstPageOfCurrentSpread=function(e){return 0===a.first(e.openPages).spineItemPageIndex},this.getLabelItemsByIdRef=function(t){var i=e.reader.spine().getItemById(t),r=i.isFixedLayout(),s=e.reader.getStartCfi(t),u=e.reader.getEndCfi(t),l=e.reader.getFirstVisibleCfi(t),c=e.reader.getLastVisibleCfi(t),f=o.getListByIdref(i.idref),d=a.map(f,n),g=a.zip(f,d),m=a.bind(o.helpers.contentCfiComparator,o.helpers);if(!s||!d.length)return[];if(l&&l.contentCFI||(l=a.first(this.getVisibleLabelCFIs())),c&&c.contentCFI||(c=a.last(this.getVisibleLabelCFIs())),!l||!c)return[];d=a.compact(d);var p;r||(p=m(a.first(d).contentCFI,s.contentCFI),p&&g.unshift([{label:a.first(f).label,index:a.first(f).index,inferred:!0},s]),m(a.last(d).contentCFI,u.contentCFI)&&g.push([{label:a.last(f).label,index:a.last(f).index,inferred:!0},u]));var h=a.map(g,function(e){var t=e[0],n=e[1];return n?{label:t,cfi:n,first:m(l.contentCFI,n.contentCFI),last:m(c.contentCFI,n.contentCFI)}:null});return 1===h.length?h:h=a.compact(h)},this.getVisibleLabelItemsByIdRef=function(e){var t=[],n=this.getLabelItemsByIdRef(e),i=!1;return a.each(n,function(e,n,r){var a=r[n-1];e.first!==e.last||0===e.first&&0===e.last?(a&&1===a.first&&1===a.last&&0!==e.first&&t.push({cfi:a.cfi,label:a.label}),t.push({cfi:e.cfi,label:e.label})):!a||-1!==e.first||-1!==e.last||t.length||i||(t.push({cfi:a.cfi,label:a.label}),i=!0)}),t},this.getLabelFromIndex=function(e){if(!(this.mappedPageList.length<1)){return this.mappedPageList[e].label}},this.getLabelItems=function(){var e=o.helpers.getCurrentSpineItems(),t=[];return a.each(e,function(e){t.push(o.getLabelItemsByIdRef(e.idref))}),c.length||this.mapExtendedLabels(a.flatten(t)),a.flatten(t)},this.getVisibleLabelItems=function(){var e=o.helpers.getCurrentSpineItems(),t=[];return a.each(e,function(e){t.push(o.getVisibleLabelItemsByIdRef(e.idref))}),a.flatten(t)},this.getFormattedVisibleLabelItems=function(){return o.helpers.formatLabelItems(o.getVisibleLabelItems())},this.getFormattedLabelItems=function(){return o.helpers.formatLabelItems(o.getLabelItems())},this.isBeforeFirstLabel=function(){var t,n,i=e.getLastVisibleCfi(),r=a.first(this.mappedPageList);if(i)if(r){if(i.idref!==r.idref)return t=e.spine().items,n=a.find(t,function(e){return e.idref===r.idref||e.idref===i.idref}),n?n.idref===i.idref:(console.error("[Paging Handler]: Spine Item Mismatch!"),!1)}else console.warn("[EpubPagingHandler] Missing firstPageEntry!");else console.warn("[EpubPagingHandler] No lastVisibleCFI!");return!1},this.decrementLabel=function(e){var t;return a.isNaN(parseInt(e))?(t=this.romanToNum(e),t--,t=this.numToRoman(t),t.toString()):(e-1).toString()},this.romanToNum=function(e){var t=e.toUpperCase();t=t.split("");var n,i={I:1,V:5,X:10,L:50,C:100,D:500,M:1e3},r=t.length,a=0;for(n=0;n<r;n++)i[t[n]]<i[t[n+1]]?a-=i[t[n]]:a+=i[t[n]];return a},this.numToRoman=function(e){var t,n={M:1e3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},i="",r=e;for(t in n)for(;r>=n[t];)i+=t,r-=n[t];return i.toLowerCase()}}}),define("readium_plugin_nypl_private/private1/pagination/main",["readium_shared_js/globals","readium_js_plugins","jquery","./PagingHandler"],function(e,t,n,i){function r(e){this.init=function(e,t){return a=new i(e,t),a.init(e,t)},this.getMappedPageList=function(){return a.mappedPageList},this.getLabelFromIndex=function(e){return a.getLabelFromIndex(e)},this.getLabelItemsByIdRef=function(e){return a.getLabelItemsByIdRef(e)},this.getLabelItems=function(){return a.getFormattedLabelItems()},this.getVisibleLabelItems=function(){return a.getFormattedVisibleLabelItems()},this.getVisibleLabelCFIs=function(){return a.getVisibleLabelCFIs()},this.getLabelsFromPageNumberRange=function(){return a.getLabelsFromPageNumberRange()},this.getTotalPageCount=function(){return a.getTotalPageNumber()},this.getLastPageForIdref=function(e){var t=a.getListByIdref(e);return t[t.length-1]},this.getLastPageNumber=function(){var e=this.getTotalPageCount();return a.getFromPageNumber(e).label},this.jumpToPageNumber=function(e){a.jumpToPageNumber(e)},this.jumpToIndex=function(e){a.jumpToIndex(e)},this.jumpToLabel=function(e){return a.jumpToLabel(e)}}var a;return r}),define("readium_plugin_nypl_private/main",["readium_js_plugins","readium_shared_js/globals","./private1/selection/selection","./private1/disablecopy","./private1/accessibility/accessibility","./private1/pagination/main"],function(e,t,n,i,r,a){e.register("selection",n),e.register("disablecopy",i),e.register("accessibility",r),e.register("pagination",a)}),define("readium_plugin_nypl_private",["readium_plugin_nypl_private/main"],function(e){return e}),define("readium-plugin-nypl_private",function(){}),require(["readium_plugin_nypl_private"]);
//# sourceMappingURL=readium-plugin-nypl_private.js.map