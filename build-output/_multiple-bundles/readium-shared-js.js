define("readium_shared_js/globals",["jquery","eventEmitter"],function(e,t){var n={version:function(){return"0.8.0"},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",CONTENT_DOCUMENT_UNLOADED:"ContentDocumentUnloaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop",PLUGINS_LOADED:"PluginsLoaded"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"},logEvent:function(e,t,n){this.DEBUG_MODE&&console.debug("#### ReadiumSDK.Events."+e+" - "+t+" - "+n)},DEBUG_MODE:!1};return e.extend(n,new t),n}),navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(e,t){return(!t||"1.0"===t)&&("dom-manipulation"===e||("layout-changes"===e||"touch-events"!==e&&("mouse-events"===e||("keyboard-events"===e||"spine-scripting"===e))))}},function(e,t){"function"==typeof define&&define.amd?define("es6-shim",t):"object"==typeof exports?module.exports=t():e.returnExports=t()}(this,function(){"use strict";var e,t=Function.call.bind(Function.apply),n=Function.call.bind(Function.call),i=Array.isArray,r=Object.keys,o=function(e){try{return e(),!1}catch(e){return!0}},a=function(e){try{return e()}catch(e){return!1}},s=function(e){return function(){return!t(e,this,arguments)}}(o),l=!!Object.defineProperty&&function(){return!o(function(){Object.defineProperty({},"x",{get:function(){}})})}(),u="foo"===function(){}.name,c=Function.call.bind(Array.prototype.forEach),f=Function.call.bind(Array.prototype.reduce),d=Function.call.bind(Array.prototype.filter),h=Function.call.bind(Array.prototype.some),p=function(e,t,n,i){!i&&t in e||(l?Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:!0,value:n}):e[t]=n)},g=function(e,t,n){c(r(t),function(i){var r=t[i];p(e,i,r,!!n)})},m=Function.call.bind(Object.prototype.toString),v="function"==typeof/abc/?function(e){return"function"==typeof e&&"[object Function]"===m(e)}:function(e){return"function"==typeof e},y={getter:function(e,t,n){if(!l)throw new TypeError("getters require true ES5 support");Object.defineProperty(e,t,{configurable:!0,enumerable:!1,get:n})},proxy:function(e,t,n){if(!l)throw new TypeError("getters require true ES5 support");var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,{configurable:i.configurable,enumerable:i.enumerable,get:function(){return e[t]},set:function(n){e[t]=n}})},redefine:function(e,t,n){if(l){var i=Object.getOwnPropertyDescriptor(e,t);i.value=n,Object.defineProperty(e,t,i)}else e[t]=n},defineByDescriptor:function(e,t,n){l?Object.defineProperty(e,t,n):"value"in n&&(e[t]=n.value)},preserveToString:function(e,t){t&&v(t.toString)&&p(e,"toString",t.toString.bind(t),!0)}},E=Object.create||function(e,t){var n=function(){};n.prototype=e;var i=new n;return void 0!==t&&r(t).forEach(function(e){y.defineByDescriptor(i,e,t[e])}),i},b=function(e,t){return!!Object.setPrototypeOf&&a(function(){var n=function t(n){var i=new e(n);return Object.setPrototypeOf(i,t.prototype),i};return Object.setPrototypeOf(n,e),n.prototype=E(e.prototype,{constructor:{value:n}}),t(n)})},I=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),T=I.isFinite,w=Function.call.bind(String.prototype.indexOf),_=Function.apply.bind(Array.prototype.indexOf),S=Function.call.bind(Array.prototype.concat),O=Function.call.bind(String.prototype.slice),C=Function.call.bind(Array.prototype.push),P=Function.apply.bind(Array.prototype.push),N=Function.call.bind(Array.prototype.shift),R=Math.max,D=Math.min,x=Math.floor,A=Math.abs,M=Math.exp,F=Math.log,L=Math.sqrt,j=Function.call.bind(Object.prototype.hasOwnProperty),k=function(){},V=I.Map,U=V&&V.prototype.delete,B=V&&V.prototype.get,G=V&&V.prototype.has,W=V&&V.prototype.set,H=I.Symbol||{},z=H.species||"@@species",q=Number.isNaN||function(e){return e!==e},J=Number.isFinite||function(e){return"number"==typeof e&&T(e)},X=v(Math.sign)?Math.sign:function(e){var t=Number(e);return 0===t?t:q(t)?t:t<0?-1:1},Y=function(e){return"[object Arguments]"===m(e)},K=function(e){return null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==m(e)&&"[object Function]"===m(e.callee)},$=Y(arguments)?Y:K,Z={primitive:function(e){return null===e||"function"!=typeof e&&"object"!=typeof e},string:function(e){return"[object String]"===m(e)},regex:function(e){return"[object RegExp]"===m(e)},symbol:function(e){return"function"==typeof I.Symbol&&"symbol"==typeof e}},Q=function(e,t,n){var i=e[t];p(e,t,n,!0),y.preserveToString(e[t],i)},ee="function"==typeof H&&"function"==typeof H.for&&Z.symbol(H()),te=Z.symbol(H.iterator)?H.iterator:"_es6-shim iterator_";I.Set&&"function"==typeof(new I.Set)["@@iterator"]&&(te="@@iterator"),I.Reflect||p(I,"Reflect",{},!0);var ne=I.Reflect,ie=String,re="undefined"!=typeof document&&document?document.all:null,oe=null==re?function(e){return null==e}:function(e){return null==e&&e!==re},ae={Call:function(e,n){var i=arguments.length>2?arguments[2]:[];if(!ae.IsCallable(e))throw new TypeError(e+" is not a function");return t(e,n,i)},RequireObjectCoercible:function(e,t){if(oe(e))throw new TypeError(t||"Cannot call method on "+e);return e},TypeIsObject:function(e){return void 0!==e&&null!==e&&!0!==e&&!1!==e&&("function"==typeof e||"object"==typeof e||e===re)},ToObject:function(e,t){return Object(ae.RequireObjectCoercible(e,t))},IsCallable:v,IsConstructor:function(e){return ae.IsCallable(e)},ToInt32:function(e){return ae.ToNumber(e)>>0},ToUint32:function(e){return ae.ToNumber(e)>>>0},ToNumber:function(e){if("[object Symbol]"===m(e))throw new TypeError("Cannot convert a Symbol value to a number");return+e},ToInteger:function(e){var t=ae.ToNumber(e);return q(t)?0:0!==t&&J(t)?(t>0?1:-1)*x(A(t)):t},ToLength:function(e){var t=ae.ToInteger(e);return t<=0?0:t>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t},SameValue:function(e,t){return e===t?0!==e||1/e==1/t:q(e)&&q(t)},SameValueZero:function(e,t){return e===t||q(e)&&q(t)},IsIterable:function(e){return ae.TypeIsObject(e)&&(void 0!==e[te]||$(e))},GetIterator:function(t){if($(t))return new e(t,"value");var n=ae.GetMethod(t,te);if(!ae.IsCallable(n))throw new TypeError("value is not an iterable");var i=ae.Call(n,t);if(!ae.TypeIsObject(i))throw new TypeError("bad iterator");return i},GetMethod:function(e,t){var n=ae.ToObject(e)[t];if(!oe(n)){if(!ae.IsCallable(n))throw new TypeError("Method not callable: "+t);return n}},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var n=ae.GetMethod(e,"return");if(void 0!==n){var i,r;try{i=ae.Call(n,e)}catch(e){r=e}if(!t){if(r)throw r;if(!ae.TypeIsObject(i))throw new TypeError("Iterator's return method returned a non-object.")}}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ae.TypeIsObject(t))throw new TypeError("bad iterator");return t},IteratorStep:function(e){var t=ae.IteratorNext(e);return!ae.IteratorComplete(t)&&t},Construct:function(e,t,n,i){var r=void 0===n?e:n;if(!i&&ne.construct)return ne.construct(e,t,r);var o=r.prototype;ae.TypeIsObject(o)||(o=Object.prototype);var a=E(o),s=ae.Call(e,a,t);return ae.TypeIsObject(s)?s:a},SpeciesConstructor:function(e,t){var n=e.constructor;if(void 0===n)return t;if(!ae.TypeIsObject(n))throw new TypeError("Bad constructor");var i=n[z];if(oe(i))return t;if(!ae.IsConstructor(i))throw new TypeError("Bad @@species");return i},CreateHTML:function(e,t,n,i){var r=ae.ToString(e),o="<"+t;if(""!==n){o+=" "+n+'="'+ae.ToString(i).replace(/"/g,"&quot;")+'"'}return o+">"+r+"</"+t+">"},IsRegExp:function(e){if(!ae.TypeIsObject(e))return!1;var t=e[H.match];return void 0!==t?!!t:Z.regex(e)},ToString:function(e){return ie(e)}};if(l&&ee){var se=function(e){if(Z.symbol(H[e]))return H[e];var t=H.for("Symbol."+e);return Object.defineProperty(H,e,{configurable:!1,enumerable:!1,writable:!1,value:t}),t};if(!Z.symbol(H.search)){var le=se("search"),ue=String.prototype.search;p(RegExp.prototype,le,function(e){return ae.Call(ue,e,[this])});var ce=function(e){var t=ae.RequireObjectCoercible(this);if(!oe(e)){var n=ae.GetMethod(e,le);if(void 0!==n)return ae.Call(n,e,[t])}return ae.Call(ue,t,[ae.ToString(e)])};Q(String.prototype,"search",ce)}if(!Z.symbol(H.replace)){var fe=se("replace"),de=String.prototype.replace;p(RegExp.prototype,fe,function(e,t){return ae.Call(de,e,[this,t])});var he=function(e,t){var n=ae.RequireObjectCoercible(this);if(!oe(e)){var i=ae.GetMethod(e,fe);if(void 0!==i)return ae.Call(i,e,[n,t])}return ae.Call(de,n,[ae.ToString(e),t])};Q(String.prototype,"replace",he)}if(!Z.symbol(H.split)){var pe=se("split"),ge=String.prototype.split;p(RegExp.prototype,pe,function(e,t){return ae.Call(ge,e,[this,t])});var me=function(e,t){var n=ae.RequireObjectCoercible(this);if(!oe(e)){var i=ae.GetMethod(e,pe);if(void 0!==i)return ae.Call(i,e,[n,t])}return ae.Call(ge,n,[ae.ToString(e),t])};Q(String.prototype,"split",me)}var ve=Z.symbol(H.match),ye=ve&&function(){var e={};return e[H.match]=function(){return 42},42!=="a".match(e)}();if(!ve||ye){var Ee=se("match"),be=String.prototype.match;p(RegExp.prototype,Ee,function(e){return ae.Call(be,e,[this])});var Ie=function(e){var t=ae.RequireObjectCoercible(this);if(!oe(e)){var n=ae.GetMethod(e,Ee);if(void 0!==n)return ae.Call(n,e,[t])}return ae.Call(be,t,[ae.ToString(e)])};Q(String.prototype,"match",Ie)}}var Te=function(e,t,n){y.preserveToString(t,e),Object.setPrototypeOf&&Object.setPrototypeOf(e,t),l?c(Object.getOwnPropertyNames(e),function(i){i in k||n[i]||y.proxy(e,i,t)}):c(Object.keys(e),function(i){i in k||n[i]||(t[i]=e[i])}),t.prototype=e.prototype,y.redefine(e.prototype,"constructor",t)},we=function(){return this},_e=function(e){l&&!j(e,z)&&y.getter(e,z,we)},Se=function(e,t){var n=t||function(){return this};p(e,te,n),!e[te]&&Z.symbol(te)&&(e[te]=n)},Oe=function(e,t,n){l?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n},Ce=function(e,t,n){if(Oe(e,t,n),!ae.SameValue(e[t],n))throw new TypeError("property is nonconfigurable")},Pe=function(e,t,n,i){if(!ae.TypeIsObject(e))throw new TypeError("Constructor requires `new`: "+t.name);var r=t.prototype;ae.TypeIsObject(r)||(r=n);var o=E(r);for(var a in i)if(j(i,a)){var s=i[a];p(o,a,s,!0)}return o};if(String.fromCodePoint&&1!==String.fromCodePoint.length){var Ne=String.fromCodePoint;Q(String,"fromCodePoint",function(e){return ae.Call(Ne,this,arguments)})}var Re={fromCodePoint:function(e){for(var t,n=[],i=0,r=arguments.length;i<r;i++){if(t=Number(arguments[i]),!ae.SameValue(t,ae.ToInteger(t))||t<0||t>1114111)throw new RangeError("Invalid code point "+t);t<65536?C(n,String.fromCharCode(t)):(t-=65536,C(n,String.fromCharCode(55296+(t>>10))),C(n,String.fromCharCode(t%1024+56320)))}return n.join("")},raw:function(e){var t=ae.ToObject(e,"bad callSite"),n=ae.ToObject(t.raw,"bad raw value"),i=n.length,r=ae.ToLength(i);if(r<=0)return"";for(var o,a,s,l,u=[],c=0;c<r&&(o=ae.ToString(c),s=ae.ToString(n[o]),C(u,s),!(c+1>=r));)a=c+1<arguments.length?arguments[c+1]:"",l=ae.ToString(a),C(u,l),c+=1;return u.join("")}};String.raw&&"xy"!==String.raw({raw:{0:"x",1:"y",length:2}})&&Q(String,"raw",Re.raw),g(String,Re);var De=function e(t,n){if(n<1)return"";if(n%2)return e(t,n-1)+t;var i=e(t,n/2);return i+i},xe={repeat:function(e){var t=ae.ToString(ae.RequireObjectCoercible(this)),n=ae.ToInteger(e);if(n<0||n>=1/0)throw new RangeError("repeat count must be less than infinity and not overflow maximum string size");return De(t,n)},startsWith:function(e){var t=ae.ToString(ae.RequireObjectCoercible(this));if(ae.IsRegExp(e))throw new TypeError('Cannot call method "startsWith" with a regex');var n,i=ae.ToString(e);arguments.length>1&&(n=arguments[1]);var r=R(ae.ToInteger(n),0);return O(t,r,r+i.length)===i},endsWith:function(e){var t=ae.ToString(ae.RequireObjectCoercible(this));if(ae.IsRegExp(e))throw new TypeError('Cannot call method "endsWith" with a regex');var n,i=ae.ToString(e),r=t.length;arguments.length>1&&(n=arguments[1]);var o=void 0===n?r:ae.ToInteger(n),a=D(R(o,0),r);return O(t,a-i.length,a)===i},includes:function(e){if(ae.IsRegExp(e))throw new TypeError('"includes" does not accept a RegExp');var t,n=ae.ToString(e);return arguments.length>1&&(t=arguments[1]),-1!==w(this,n,t)},codePointAt:function(e){var t=ae.ToString(ae.RequireObjectCoercible(this)),n=ae.ToInteger(e),i=t.length;if(n>=0&&n<i){var r=t.charCodeAt(n),o=n+1===i;if(r<55296||r>56319||o)return r;var a=t.charCodeAt(n+1);return a<56320||a>57343?r:1024*(r-55296)+(a-56320)+65536}}};if(String.prototype.includes&&!1!=="a".includes("a",1/0)&&Q(String.prototype,"includes",xe.includes),String.prototype.startsWith&&String.prototype.endsWith){var Ae=o(function(){"/a/".startsWith(/a/)}),Me=a(function(){return!1==="abc".startsWith("a",1/0)});Ae&&Me||(Q(String.prototype,"startsWith",xe.startsWith),Q(String.prototype,"endsWith",xe.endsWith))}if(ee){a(function(){var e=/a/;return e[H.match]=!1,"/a/".startsWith(e)})||Q(String.prototype,"startsWith",xe.startsWith);a(function(){var e=/a/;return e[H.match]=!1,"/a/".endsWith(e)})||Q(String.prototype,"endsWith",xe.endsWith);a(function(){var e=/a/;return e[H.match]=!1,"/a/".includes(e)})||Q(String.prototype,"includes",xe.includes)}g(String.prototype,xe);var Fe=["\t\n\v\f\r   ᠎    ","         　\u2028","\u2029\ufeff"].join(""),Le=new RegExp("(^["+Fe+"]+)|(["+Fe+"]+$)","g"),je=function(){return ae.ToString(ae.RequireObjectCoercible(this)).replace(Le,"")},ke=["","​","￾"].join(""),Ve=new RegExp("["+ke+"]","g"),Ue=/^[-+]0x[0-9a-f]+$/i,Be=ke.trim().length!==ke.length;p(String.prototype,"trim",je,Be);var Ge=function(e){return{value:e,done:0===arguments.length}},We=function(e){ae.RequireObjectCoercible(e),this._s=ae.ToString(e),this._i=0};We.prototype.next=function(){var e=this._s,t=this._i;if(void 0===e||t>=e.length)return this._s=void 0,Ge();var n,i,r=e.charCodeAt(t);return r<55296||r>56319||t+1===e.length?i=1:(n=e.charCodeAt(t+1),i=n<56320||n>57343?1:2),this._i=t+i,Ge(e.substr(t,i))},Se(We.prototype),Se(String.prototype,function(){return new We(this)});var He={from:function(e){var t,i=this;arguments.length>1&&(t=arguments[1]);var r,o;if(void 0===t)r=!1;else{if(!ae.IsCallable(t))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(o=arguments[2]),r=!0}var a,s,l,u=void 0!==($(e)||ae.GetMethod(e,te));if(u){s=ae.IsConstructor(i)?Object(new i):[];var c,f,d=ae.GetIterator(e);for(l=0;;){if(!1===(c=ae.IteratorStep(d)))break;f=c.value;try{r&&(f=void 0===o?t(f,l):n(t,o,f,l)),s[l]=f}catch(e){throw ae.IteratorClose(d,!0),e}l+=1}a=l}else{var h=ae.ToObject(e);a=ae.ToLength(h.length),s=ae.IsConstructor(i)?Object(new i(a)):new Array(a);var p;for(l=0;l<a;++l)p=h[l],r&&(p=void 0===o?t(p,l):n(t,o,p,l)),Ce(s,l,p)}return s.length=a,s},of:function(){for(var e=arguments.length,t=this,n=i(t)||!ae.IsCallable(t)?new Array(e):ae.Construct(t,[e]),r=0;r<e;++r)Ce(n,r,arguments[r]);return n.length=e,n}};g(Array,He),_e(Array),e=function(e,t){this.i=0,this.array=e,this.kind=t},g(e.prototype,{next:function(){var t=this.i,n=this.array;if(!(this instanceof e))throw new TypeError("Not an ArrayIterator");if(void 0!==n)for(var i=ae.ToLength(n.length);t<i;t++){var r,o=this.kind;return"key"===o?r=t:"value"===o?r=n[t]:"entry"===o&&(r=[t,n[t]]),this.i=t+1,Ge(r)}return this.array=void 0,Ge()}}),Se(e.prototype),Array.of===He.of||function(){var e=function(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&2===t.length}()||Q(Array,"of",He.of);var ze={copyWithin:function(e,t){var n,i=ae.ToObject(this),r=ae.ToLength(i.length),o=ae.ToInteger(e),a=ae.ToInteger(t),s=o<0?R(r+o,0):D(o,r),l=a<0?R(r+a,0):D(a,r);arguments.length>2&&(n=arguments[2]);var u=void 0===n?r:ae.ToInteger(n),c=u<0?R(r+u,0):D(u,r),f=D(c-l,r-s),d=1;for(l<s&&s<l+f&&(d=-1,l+=f-1,s+=f-1);f>0;)l in i?i[s]=i[l]:delete i[s],l+=d,s+=d,f-=1;return i},fill:function(e){var t;arguments.length>1&&(t=arguments[1]);var n;arguments.length>2&&(n=arguments[2]);var i=ae.ToObject(this),r=ae.ToLength(i.length);t=ae.ToInteger(void 0===t?0:t),n=ae.ToInteger(void 0===n?r:n);for(var o=t<0?R(r+t,0):D(t,r),a=n<0?r+n:n,s=o;s<r&&s<a;++s)i[s]=e;return i},find:function(e){var t=ae.ToObject(this),i=ae.ToLength(t.length);if(!ae.IsCallable(e))throw new TypeError("Array#find: predicate must be a function");for(var r,o=arguments.length>1?arguments[1]:null,a=0;a<i;a++)if(r=t[a],o){if(n(e,o,r,a,t))return r}else if(e(r,a,t))return r},findIndex:function(e){var t=ae.ToObject(this),i=ae.ToLength(t.length);if(!ae.IsCallable(e))throw new TypeError("Array#findIndex: predicate must be a function");for(var r=arguments.length>1?arguments[1]:null,o=0;o<i;o++)if(r){if(n(e,r,t[o],o,t))return o}else if(e(t[o],o,t))return o;return-1},keys:function(){return new e(this,"key")},values:function(){return new e(this,"value")},entries:function(){return new e(this,"entry")}};if(Array.prototype.keys&&!ae.IsCallable([1].keys().next)&&delete Array.prototype.keys,Array.prototype.entries&&!ae.IsCallable([1].entries().next)&&delete Array.prototype.entries,Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[te]&&(g(Array.prototype,{values:Array.prototype[te]}),Z.symbol(H.unscopables)&&(Array.prototype[H.unscopables].values=!0)),u&&Array.prototype.values&&"values"!==Array.prototype.values.name){var qe=Array.prototype.values;Q(Array.prototype,"values",function(){return ae.Call(qe,this,arguments)}),p(Array.prototype,te,Array.prototype.values,!0)}g(Array.prototype,ze),1/[!0].indexOf(!0,-0)<0&&p(Array.prototype,"indexOf",function(e){var t=_(this,arguments);return 0===t&&1/t<0?0:t},!0),Se(Array.prototype,function(){return this.values()}),Object.getPrototypeOf&&Se(Object.getPrototypeOf([].values()));var Je=function(){return a(function(){return 0===Array.from({length:-1}).length})}(),Xe=function(){var e=Array.from([0].entries());return 1===e.length&&i(e[0])&&0===e[0][0]&&0===e[0][1]}();if(Je&&Xe||Q(Array,"from",He.from),!function(){return a(function(){return Array.from([0],void 0)})}()){var Ye=Array.from;Q(Array,"from",function(e){return arguments.length>1&&void 0!==arguments[1]?ae.Call(Ye,this,arguments):n(Ye,this,e)})}var Ke=-(Math.pow(2,32)-1),$e=function(e,t){var i={length:Ke};return i[t?(i.length>>>0)-1:0]=!0,a(function(){return n(e,i,function(){throw new RangeError("should not reach here")},[]),!0})};if(!$e(Array.prototype.forEach)){var Ze=Array.prototype.forEach;Q(Array.prototype,"forEach",function(e){return ae.Call(Ze,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.map)){var Qe=Array.prototype.map;Q(Array.prototype,"map",function(e){return ae.Call(Qe,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.filter)){var et=Array.prototype.filter;Q(Array.prototype,"filter",function(e){return ae.Call(et,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.some)){var tt=Array.prototype.some;Q(Array.prototype,"some",function(e){return ae.Call(tt,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.every)){var nt=Array.prototype.every;Q(Array.prototype,"every",function(e){return ae.Call(nt,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.reduce)){var it=Array.prototype.reduce;Q(Array.prototype,"reduce",function(e){return ae.Call(it,this.length>=0?this:[],arguments)})}if(!$e(Array.prototype.reduceRight,!0)){var rt=Array.prototype.reduceRight;Q(Array.prototype,"reduceRight",function(e){return ae.Call(rt,this.length>=0?this:[],arguments)})}var ot=8!==Number("0o10"),at=2!==Number("0b10"),st=h(ke,function(e){return 0===Number(e+0+e)});if(ot||at||st){var lt=Number,ut=/^0b[01]+$/i,ct=/^0o[0-7]+$/i,ft=ut.test.bind(ut),dt=ct.test.bind(ct),ht=function(e){var t;if("function"==typeof e.valueOf&&(t=e.valueOf(),Z.primitive(t)))return t;if("function"==typeof e.toString&&(t=e.toString(),Z.primitive(t)))return t;throw new TypeError("No default value")},pt=Ve.test.bind(Ve),gt=Ue.test.bind(Ue),mt=function(){var e=function(t){var n;"string"==typeof(n=arguments.length>0?Z.primitive(t)?t:ht(t):0)&&(n=ae.Call(je,n),ft(n)?n=parseInt(O(n,2),2):dt(n)?n=parseInt(O(n,2),8):(pt(n)||gt(n))&&(n=NaN));var i=this,r=a(function(){return lt.prototype.valueOf.call(i),!0});return i instanceof e&&!r?new lt(n):lt(n)};return e}();Te(lt,mt,{}),g(mt,{NaN:lt.NaN,MAX_VALUE:lt.MAX_VALUE,MIN_VALUE:lt.MIN_VALUE,NEGATIVE_INFINITY:lt.NEGATIVE_INFINITY,POSITIVE_INFINITY:lt.POSITIVE_INFINITY}),Number=mt,y.redefine(I,"Number",mt)}var vt=Math.pow(2,53)-1;g(Number,{MAX_SAFE_INTEGER:vt,MIN_SAFE_INTEGER:-vt,EPSILON:2.220446049250313e-16,parseInt:I.parseInt,parseFloat:I.parseFloat,isFinite:J,isInteger:function(e){return J(e)&&ae.ToInteger(e)===e},isSafeInteger:function(e){return Number.isInteger(e)&&A(e)<=Number.MAX_SAFE_INTEGER},isNaN:q}),p(Number,"parseInt",I.parseInt,Number.parseInt!==I.parseInt),1===[,1].find(function(){return!0})&&Q(Array.prototype,"find",ze.find),0!==[,1].findIndex(function(){return!0})&&Q(Array.prototype,"findIndex",ze.findIndex);var yt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable),Et=function(e,t){l&&yt(e,t)&&Object.defineProperty(e,t,{enumerable:!1})},bt=function(){for(var e=Number(this),t=arguments.length,n=t-e,i=new Array(n<0?0:n),r=e;r<t;++r)i[r-e]=arguments[r];return i},It=function(e){return function(t,n){return t[n]=e[n],t}},Tt=function(e,t){var n,i=r(Object(t));return ae.IsCallable(Object.getOwnPropertySymbols)&&(n=d(Object.getOwnPropertySymbols(Object(t)),yt(t))),f(S(i,n||[]),It(t),e)},wt={assign:function(e,t){var n=ae.ToObject(e,"Cannot convert undefined or null to object");return f(ae.Call(bt,1,arguments),Tt,n)},is:function(e,t){return ae.SameValue(e,t)}};if(Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}}()&&Q(Object,"assign",wt.assign),g(Object,wt),l){var _t={setPrototypeOf:function(e,t){var i,r=function(e,t){if(!ae.TypeIsObject(e))throw new TypeError("cannot set prototype on a non-object");if(null!==t&&!ae.TypeIsObject(t))throw new TypeError("can only set prototype to an object or null"+t)},o=function(e,t){return r(e,t),n(i,e,t),e};try{i=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set,n(i,{},null)}catch(t){if(e.prototype!=={}.__proto__)return;i=function(e){this.__proto__=e},o.polyfill=o(o({},null),e.prototype)instanceof e}return o}(Object)};g(Object,_t)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&null!==Object.getPrototypeOf(Object.setPrototypeOf({},null))&&null===Object.getPrototypeOf(Object.create(null))&&function(){var e=Object.create(null),t=Object.getPrototypeOf,n=Object.setPrototypeOf;Object.getPrototypeOf=function(n){var i=t(n);return i===e?null:i},Object.setPrototypeOf=function(t,i){return n(t,null===i?e:i)},Object.setPrototypeOf.polyfill=!1}(),!!o(function(){Object.keys("foo")})){var St=Object.keys;Q(Object,"keys",function(e){return St(ae.ToObject(e))}),r=Object.keys}if(o(function(){Object.keys(/a/g)})){var Ot=Object.keys;Q(Object,"keys",function(e){if(Z.regex(e)){var t=[];for(var n in e)j(e,n)&&C(t,n);return t}return Ot(e)}),r=Object.keys}if(Object.getOwnPropertyNames){if(!!o(function(){Object.getOwnPropertyNames("foo")})){var Ct="object"==typeof window?Object.getOwnPropertyNames(window):[],Pt=Object.getOwnPropertyNames;Q(Object,"getOwnPropertyNames",function(e){var t=ae.ToObject(e);if("[object Window]"===m(t))try{return Pt(t)}catch(e){return S([],Ct)}return Pt(t)})}}if(Object.getOwnPropertyDescriptor){if(!!o(function(){Object.getOwnPropertyDescriptor("foo","bar")})){var Nt=Object.getOwnPropertyDescriptor;Q(Object,"getOwnPropertyDescriptor",function(e,t){return Nt(ae.ToObject(e),t)})}}if(Object.seal){if(!!o(function(){Object.seal("foo")})){var Rt=Object.seal;Q(Object,"seal",function(e){return ae.TypeIsObject(e)?Rt(e):e})}}if(Object.isSealed){if(!!o(function(){Object.isSealed("foo")})){var Dt=Object.isSealed;Q(Object,"isSealed",function(e){return!ae.TypeIsObject(e)||Dt(e)})}}if(Object.freeze){if(!!o(function(){Object.freeze("foo")})){var xt=Object.freeze;Q(Object,"freeze",function(e){return ae.TypeIsObject(e)?xt(e):e})}}if(Object.isFrozen){if(!!o(function(){Object.isFrozen("foo")})){var At=Object.isFrozen;Q(Object,"isFrozen",function(e){return!ae.TypeIsObject(e)||At(e)})}}if(Object.preventExtensions){if(!!o(function(){Object.preventExtensions("foo")})){var Mt=Object.preventExtensions;Q(Object,"preventExtensions",function(e){return ae.TypeIsObject(e)?Mt(e):e})}}if(Object.isExtensible){if(!!o(function(){Object.isExtensible("foo")})){var Ft=Object.isExtensible;Q(Object,"isExtensible",function(e){return!!ae.TypeIsObject(e)&&Ft(e)})}}if(Object.getPrototypeOf){if(!!o(function(){Object.getPrototypeOf("foo")})){var Lt=Object.getPrototypeOf;Q(Object,"getPrototypeOf",function(e){return Lt(ae.ToObject(e))})}}var jt=l&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&ae.IsCallable(e.get)}();if(l&&!jt){var kt=function(){if(!ae.TypeIsObject(this))throw new TypeError("Method called on incompatible type: must be an object.");var e="";return this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.unicode&&(e+="u"),this.sticky&&(e+="y"),e};y.getter(RegExp.prototype,"flags",kt)}var Vt=l&&a(function(){return"/a/i"===String(new RegExp(/a/g,"i"))}),Ut=ee&&l&&function(){var e=/./;return e[H.match]=!1,RegExp(e)===e}(),Bt=a(function(){return"/abc/"===RegExp.prototype.toString.call({source:"abc"})}),Gt=Bt&&a(function(){return"/a/b"===RegExp.prototype.toString.call({source:"a",flags:"b"})});if(!Bt||!Gt){var Wt=RegExp.prototype.toString;p(RegExp.prototype,"toString",function(){var e=ae.RequireObjectCoercible(this);return Z.regex(e)?n(Wt,e):"/"+ie(e.source)+"/"+ie(e.flags)},!0),y.preserveToString(RegExp.prototype.toString,Wt)}if(l&&(!Vt||Ut)){var Ht=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get,zt=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{},qt=function(){return this.source},Jt=ae.IsCallable(zt.get)?zt.get:qt,Xt=RegExp,Yt=function(){return function e(t,n){var i=ae.IsRegExp(t);if(!(this instanceof e)&&i&&void 0===n&&t.constructor===e)return t;var r=t,o=n;return Z.regex(t)?(r=ae.Call(Jt,t),o=void 0===n?ae.Call(Ht,t):n,new e(r,o)):(i&&(r=t.source,o=void 0===n?t.flags:n),new Xt(t,n))}}();Te(Xt,Yt,{$input:!0}),RegExp=Yt,y.redefine(I,"RegExp",Yt)}if(l){var Kt={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};c(r(Kt),function(e){e in RegExp&&!(Kt[e]in RegExp)&&y.getter(RegExp,Kt[e],function(){return RegExp[e]})})}_e(RegExp);var $t=1/Number.EPSILON,Zt=function(e){return e+$t-$t},Qt=Math.pow(2,-23),en=Math.pow(2,127)*(2-Qt),tn=Math.pow(2,-126),nn=Math.E,rn=Math.LOG2E,on=Math.LOG10E,an=Number.prototype.clz;delete Number.prototype.clz;var sn={acosh:function(e){var t=Number(e);return q(t)||e<1?NaN:1===t?0:t===1/0?t:F(t/nn+L(t+1)*L(t-1)/nn)+1},asinh:function e(t){var n=Number(t);return 0!==n&&T(n)?n<0?-e(-n):F(n+L(n*n+1)):n},atanh:function(e){var t=Number(e);return q(t)||t<-1||t>1?NaN:-1===t?-1/0:1===t?1/0:0===t?t:.5*F((1+t)/(1-t))},cbrt:function(e){var t=Number(e);if(0===t)return t;var n,i=t<0;return i&&(t=-t),t===1/0?n=1/0:(n=M(F(t)/3),n=(t/(n*n)+2*n)/3),i?-n:n},clz32:function(e){var t=Number(e),n=ae.ToUint32(t);return 0===n?32:an?ae.Call(an,n):31-x(F(n+.5)*rn)},cosh:function(e){var t=Number(e);return 0===t?1:q(t)?NaN:T(t)?(t<0&&(t=-t),t>21?M(t)/2:(M(t)+M(-t))/2):1/0},expm1:function(e){var t=Number(e);if(t===-1/0)return-1;if(!T(t)||0===t)return t;if(A(t)>.5)return M(t)-1;for(var n=t,i=0,r=1;i+n!==i;)i+=n,r+=1,n*=t/r;return i},hypot:function(e,t){for(var n=0,i=0,r=0;r<arguments.length;++r){var o=A(Number(arguments[r]));i<o?(n*=i/o*(i/o),n+=1,i=o):n+=o>0?o/i*(o/i):o}return i===1/0?1/0:i*L(n)},log2:function(e){return F(e)*rn},log10:function(e){return F(e)*on},log1p:function(e){var t=Number(e);return t<-1||q(t)?NaN:0===t||t===1/0?t:-1===t?-1/0:1+t-1==0?t:t*(F(1+t)/(1+t-1))},sign:X,sinh:function(e){var t=Number(e);return T(t)&&0!==t?A(t)<1?(Math.expm1(t)-Math.expm1(-t))/2:(M(t-1)-M(-t-1))*nn/2:t},tanh:function(e){var t=Number(e);return q(t)||0===t?t:t>=20?1:t<=-20?-1:(Math.expm1(t)-Math.expm1(-t))/(M(t)+M(-t))},trunc:function(e){var t=Number(e);return t<0?-x(-t):x(t)},imul:function(e,t){var n=ae.ToUint32(e),i=ae.ToUint32(t),r=n>>>16&65535,o=65535&n,a=i>>>16&65535,s=65535&i;return o*s+(r*s+o*a<<16>>>0)|0},fround:function(e){var t=Number(e);if(0===t||t===1/0||t===-1/0||q(t))return t;var n=X(t),i=A(t);if(i<tn)return n*Zt(i/tn/Qt)*tn*Qt;var r=(1+Qt/Number.EPSILON)*i,o=r-(r-i);return o>en||q(o)?n*(1/0):n*o}};g(Math,sn),p(Math,"log1p",sn.log1p,-1e-17!==Math.log1p(-1e-17)),p(Math,"asinh",sn.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7)),p(Math,"tanh",sn.tanh,-2e-17!==Math.tanh(-2e-17)),p(Math,"acosh",sn.acosh,Math.acosh(Number.MAX_VALUE)===1/0),p(Math,"cbrt",sn.cbrt,Math.abs(1-Math.cbrt(1e-300)/1e-100)/Number.EPSILON>8),p(Math,"sinh",sn.sinh,-2e-17!==Math.sinh(-2e-17));var ln=Math.expm1(10);p(Math,"expm1",sn.expm1,ln>22025.465794806718||ln<22025.465794806718);var un=Math.round,cn=0===Math.round(.5-Number.EPSILON/4)&&1===Math.round(Number.EPSILON/3.99-.5),fn=$t+1,dn=2*$t-1,hn=[fn,dn].every(function(e){return Math.round(e)===e});p(Math,"round",function(e){var t=x(e),n=-1===t?-0:t+1;return e-t<.5?t:n},!cn||!hn),y.preserveToString(Math.round,un);var pn=Math.imul;-5!==Math.imul(4294967295,5)&&(Math.imul=sn.imul,y.preserveToString(Math.imul,pn)),2!==Math.imul.length&&Q(Math,"imul",function(e,t){return ae.Call(pn,Math,arguments)});var gn=function(){var e=I.setTimeout;if("function"==typeof e||"object"==typeof e){ae.IsPromise=function(e){return!!ae.TypeIsObject(e)&&void 0!==e._promise};var t,i=function(e){if(!ae.IsConstructor(e))throw new TypeError("Bad promise constructor");var t=this,n=function(e,n){if(void 0!==t.resolve||void 0!==t.reject)throw new TypeError("Bad Promise implementation!");t.resolve=e,t.reject=n};if(t.resolve=void 0,t.reject=void 0,t.promise=new e(n),!ae.IsCallable(t.resolve)||!ae.IsCallable(t.reject))throw new TypeError("Bad promise constructor")};"undefined"!=typeof window&&ae.IsCallable(window.postMessage)&&(t=function(){var e=[],t=function(t){C(e,t),window.postMessage("zero-timeout-message","*")},n=function(t){if(t.source===window&&"zero-timeout-message"===t.data){if(t.stopPropagation(),0===e.length)return;N(e)()}};return window.addEventListener("message",n,!0),t});var r,o,a=ae.IsCallable(I.setImmediate)?I.setImmediate:"object"==typeof process&&process.nextTick?process.nextTick:function(){var e=I.Promise,t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}}()||(ae.IsCallable(t)?t():function(t){e(t,0)}),s=function(e){return e},l=function(e){throw e},u={},c=function(e,t,n){a(function(){f(e,t,n)})},f=function(e,t,n){var i,r;if(t===u)return e(n);try{i=e(n),r=t.resolve}catch(e){i=e,r=t.reject}r(i)},d=function(e,t){var n=e._promise,i=n.reactionLength;if(i>0&&(c(n.fulfillReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,i>1))for(var r=1,o=0;r<i;r++,o+=3)c(n[o+0],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=1,n.reactionLength=0},h=function(e,t){var n=e._promise,i=n.reactionLength;if(i>0&&(c(n.rejectReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,i>1))for(var r=1,o=0;r<i;r++,o+=3)c(n[o+1],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=2,n.reactionLength=0},p=function(e){var t=!1;return{resolve:function(n){var i;if(!t){if(t=!0,
n===e)return h(e,new TypeError("Self resolution"));if(!ae.TypeIsObject(n))return d(e,n);try{i=n.then}catch(t){return h(e,t)}if(!ae.IsCallable(i))return d(e,n);a(function(){v(e,n,i)})}},reject:function(n){if(!t)return t=!0,h(e,n)}}},m=function(e,t,i,r){e===o?n(e,t,i,r,u):n(e,t,i,r)},v=function(e,t,n){var i=p(e),r=i.resolve,o=i.reject;try{m(n,t,r,o)}catch(e){o(e)}},y=function(){var e=function(t){if(!(this instanceof e))throw new TypeError('Constructor Promise requires "new"');if(this&&this._promise)throw new TypeError("Bad construction");if(!ae.IsCallable(t))throw new TypeError("not a valid resolver");var n=Pe(this,e,r,{_promise:{result:void 0,state:0,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}}),i=p(n),o=i.reject;try{t(i.resolve,o)}catch(e){o(e)}return n};return e}();r=y.prototype;var E=function(e,t,n,i){var r=!1;return function(o){if(!r&&(r=!0,t[e]=o,0==--i.count)){(0,n.resolve)(t)}}},b=function(e,t,n){for(var i,r,o=e.iterator,a=[],s={count:1},l=0;;){try{if(!1===(i=ae.IteratorStep(o))){e.done=!0;break}r=i.value}catch(t){throw e.done=!0,t}a[l]=void 0;var u=t.resolve(r),c=E(l,a,n,s);s.count+=1,m(u.then,u,c,n.reject),l+=1}if(0==--s.count){(0,n.resolve)(a)}return n.promise},T=function(e,t,n){for(var i,r,o,a=e.iterator;;){try{if(!1===(i=ae.IteratorStep(a))){e.done=!0;break}r=i.value}catch(t){throw e.done=!0,t}o=t.resolve(r),m(o.then,o,n.resolve,n.reject)}return n.promise};return g(y,{all:function(e){var t=this;if(!ae.TypeIsObject(t))throw new TypeError("Promise is not object");var n,r,o=new i(t);try{return n=ae.GetIterator(e),r={iterator:n,done:!1},b(r,t,o)}catch(e){var a=e;if(r&&!r.done)try{ae.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},race:function(e){var t=this;if(!ae.TypeIsObject(t))throw new TypeError("Promise is not object");var n,r,o=new i(t);try{return n=ae.GetIterator(e),r={iterator:n,done:!1},T(r,t,o)}catch(e){var a=e;if(r&&!r.done)try{ae.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},reject:function(e){var t=this;if(!ae.TypeIsObject(t))throw new TypeError("Bad promise constructor");var n=new i(t);return(0,n.reject)(e),n.promise},resolve:function(e){var t=this;if(!ae.TypeIsObject(t))throw new TypeError("Bad promise constructor");if(ae.IsPromise(e)){var n=e.constructor;if(n===t)return e}var r=new i(t);return(0,r.resolve)(e),r.promise}}),g(r,{catch:function(e){return this.then(null,e)},then:function(e,t){var n=this;if(!ae.IsPromise(n))throw new TypeError("not a promise");var r,o=ae.SpeciesConstructor(n,y);r=arguments.length>2&&arguments[2]===u&&o===y?u:new i(o);var a,f=ae.IsCallable(e)?e:s,d=ae.IsCallable(t)?t:l,h=n._promise;if(0===h.state){if(0===h.reactionLength)h.fulfillReactionHandler0=f,h.rejectReactionHandler0=d,h.reactionCapability0=r;else{var p=3*(h.reactionLength-1);h[p+0]=f,h[p+1]=d,h[p+2]=r}h.reactionLength+=1}else if(1===h.state)a=h.result,c(f,r,a);else{if(2!==h.state)throw new TypeError("unexpected Promise state");a=h.result,c(d,r,a)}return r.promise}}),u=new i(y),o=r.then,y}}();if(I.Promise&&(delete I.Promise.accept,delete I.Promise.defer,delete I.Promise.prototype.chain),"function"==typeof gn){g(I,{Promise:gn});var mn=b(I.Promise,function(e){return e.resolve(42).then(function(){})instanceof e}),vn=!o(function(){I.Promise.reject(42).then(null,5).then(null,k)}),yn=o(function(){I.Promise.call(3,k)}),En=function(e){var t=e.resolve(5);t.constructor={};var n=e.resolve(t);try{n.then(null,k).then(null,k)}catch(e){return!0}return t===n}(I.Promise),bn=l&&function(){var e=0,t=Object.defineProperty({},"then",{get:function(){e+=1}});return Promise.resolve(t),1===e}(),In=function e(t){var n=new Promise(t);t(3,function(){}),this.then=n.then,this.constructor=e};In.prototype=Promise.prototype,In.all=Promise.all;var Tn=a(function(){return!!In.all([1,2])});if(mn&&vn&&yn&&!En&&bn&&!Tn||(Promise=gn,Q(I,"Promise",gn)),1!==Promise.all.length){var wn=Promise.all;Q(Promise,"all",function(e){return ae.Call(wn,this,arguments)})}if(1!==Promise.race.length){var _n=Promise.race;Q(Promise,"race",function(e){return ae.Call(_n,this,arguments)})}if(1!==Promise.resolve.length){var Sn=Promise.resolve;Q(Promise,"resolve",function(e){return ae.Call(Sn,this,arguments)})}if(1!==Promise.reject.length){var On=Promise.reject;Q(Promise,"reject",function(e){return ae.Call(On,this,arguments)})}Et(Promise,"all"),Et(Promise,"race"),Et(Promise,"resolve"),Et(Promise,"reject"),_e(Promise)}var Cn=function(e){var t=r(f(e,function(e,t){return e[t]=!0,e},{}));return e.join(":")===t.join(":")},Pn=Cn(["z","a","bb"]),Nn=Cn(["z",1,"a","3",2]);if(l){var Rn=function(e,t){return t||Pn?oe(e)?"^"+ae.ToString(e):"string"==typeof e?"$"+e:"number"==typeof e?Nn?e:"n"+e:"boolean"==typeof e?"b"+e:null:null},Dn=function(){return Object.create?Object.create(null):{}},xn=function(e,t,r){if(i(r)||Z.string(r))c(r,function(e){if(!ae.TypeIsObject(e))throw new TypeError("Iterator value "+e+" is not an entry object");t.set(e[0],e[1])});else if(r instanceof e)n(e.prototype.forEach,r,function(e,n){t.set(n,e)});else{var o,a;if(!oe(r)){if(a=t.set,!ae.IsCallable(a))throw new TypeError("bad map");o=ae.GetIterator(r)}if(void 0!==o)for(;;){var s=ae.IteratorStep(o);if(!1===s)break;var l=s.value;try{if(!ae.TypeIsObject(l))throw new TypeError("Iterator value "+l+" is not an entry object");n(a,t,l[0],l[1])}catch(e){throw ae.IteratorClose(o,!0),e}}}},An=function(e,t,r){if(i(r)||Z.string(r))c(r,function(e){t.add(e)});else if(r instanceof e)n(e.prototype.forEach,r,function(e){t.add(e)});else{var o,a;if(!oe(r)){if(a=t.add,!ae.IsCallable(a))throw new TypeError("bad set");o=ae.GetIterator(r)}if(void 0!==o)for(;;){var s=ae.IteratorStep(o);if(!1===s)break;var l=s.value;try{n(a,t,l)}catch(e){throw ae.IteratorClose(o,!0),e}}}},Mn={Map:function(){var e={},t=function(e,t){this.key=e,this.value=t,this.next=null,this.prev=null};t.prototype.isRemoved=function(){return this.key===e};var i=function(e){return!!e._es6map},r=function(e,t){if(!ae.TypeIsObject(e)||!i(e))throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ae.ToString(e))},o=function(e,t){r(e,"[[MapIterator]]"),this.head=e._head,this.i=this.head,this.kind=t};o.prototype={next:function(){var e=this.i,t=this.kind,n=this.head;if(void 0===this.i)return Ge();for(;e.isRemoved()&&e!==n;)e=e.prev;for(var i;e.next!==n;)if(e=e.next,!e.isRemoved())return i="key"===t?e.key:"value"===t?e.value:[e.key,e.value],this.i=e,Ge(i);return this.i=void 0,Ge()}},Se(o.prototype);var a,s=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');if(this&&this._es6map)throw new TypeError("Bad construction");var n=Pe(this,e,a,{_es6map:!0,_head:null,_map:V?new V:null,_size:0,_storage:Dn()}),i=new t(null,null);return i.next=i.prev=i,n._head=i,arguments.length>0&&xn(e,n,arguments[0]),n};return a=s.prototype,y.getter(a,"size",function(){if(void 0===this._size)throw new TypeError("size method called on incompatible Map");return this._size}),g(a,{get:function(e){r(this,"get");var t,n=Rn(e,!0);if(null!==n)return t=this._storage[n],t?t.value:void 0;if(this._map)return t=B.call(this._map,e),t?t.value:void 0;for(var i=this._head,o=i;(o=o.next)!==i;)if(ae.SameValueZero(o.key,e))return o.value},has:function(e){r(this,"has");var t=Rn(e,!0);if(null!==t)return void 0!==this._storage[t];if(this._map)return G.call(this._map,e);for(var n=this._head,i=n;(i=i.next)!==n;)if(ae.SameValueZero(i.key,e))return!0;return!1},set:function(e,n){r(this,"set");var i,o=this._head,a=o,s=Rn(e,!0);if(null!==s){if(void 0!==this._storage[s])return this._storage[s].value=n,this;i=this._storage[s]=new t(e,n),a=o.prev}else this._map&&(G.call(this._map,e)?B.call(this._map,e).value=n:(i=new t(e,n),W.call(this._map,e,i),a=o.prev));for(;(a=a.next)!==o;)if(ae.SameValueZero(a.key,e))return a.value=n,this;return i=i||new t(e,n),ae.SameValue(-0,e)&&(i.key=0),i.next=this._head,i.prev=this._head.prev,i.prev.next=i,i.next.prev=i,this._size+=1,this},delete:function(t){r(this,"delete");var n=this._head,i=n,o=Rn(t,!0);if(null!==o){if(void 0===this._storage[o])return!1;i=this._storage[o].prev,delete this._storage[o]}else if(this._map){if(!G.call(this._map,t))return!1;i=B.call(this._map,t).prev,U.call(this._map,t)}for(;(i=i.next)!==n;)if(ae.SameValueZero(i.key,t))return i.key=e,i.value=e,i.prev.next=i.next,i.next.prev=i.prev,this._size-=1,!0;return!1},clear:function(){r(this,"clear"),this._map=V?new V:null,this._size=0,this._storage=Dn();for(var t=this._head,n=t,i=n.next;(n=i)!==t;)n.key=e,n.value=e,i=n.next,n.next=n.prev=t;t.next=t.prev=t},keys:function(){return r(this,"keys"),new o(this,"key")},values:function(){return r(this,"values"),new o(this,"value")},entries:function(){return r(this,"entries"),new o(this,"key+value")},forEach:function(e){r(this,"forEach");for(var t=arguments.length>1?arguments[1]:null,i=this.entries(),o=i.next();!o.done;o=i.next())t?n(e,t,o.value[1],o.value[0],this):e(o.value[1],o.value[0],this)}}),Se(a,a.entries),s}(),Set:function(){var e,t=function(e){return e._es6set&&void 0!==e._storage},i=function(e,n){if(!ae.TypeIsObject(e)||!t(e))throw new TypeError("Set.prototype."+n+" called on incompatible receiver "+ae.ToString(e))},o=function t(){if(!(this instanceof t))throw new TypeError('Constructor Set requires "new"');if(this&&this._es6set)throw new TypeError("Bad construction");var n=Pe(this,t,e,{_es6set:!0,"[[SetData]]":null,_storage:Dn()});if(!n._es6set)throw new TypeError("bad set");return arguments.length>0&&An(t,n,arguments[0]),n};e=o.prototype;var a=function(e){var t=e;if("^null"===t)return null;if("^undefined"!==t){var n=t.charAt(0);return"$"===n?O(t,1):"n"===n?+O(t,1):"b"===n?"btrue"===t:+t}},s=function(e){if(!e["[[SetData]]"]){var t=new Mn.Map;e["[[SetData]]"]=t,c(r(e._storage),function(e){var n=a(e);t.set(n,n)}),e["[[SetData]]"]=t}e._storage=null};return y.getter(o.prototype,"size",function(){return i(this,"size"),this._storage?r(this._storage).length:(s(this),this["[[SetData]]"].size)}),g(o.prototype,{has:function(e){i(this,"has");var t;return this._storage&&null!==(t=Rn(e))?!!this._storage[t]:(s(this),this["[[SetData]]"].has(e))},add:function(e){i(this,"add");var t;return this._storage&&null!==(t=Rn(e))?(this._storage[t]=!0,this):(s(this),this["[[SetData]]"].set(e,e),this)},delete:function(e){i(this,"delete");var t;if(this._storage&&null!==(t=Rn(e))){var n=j(this._storage,t);return delete this._storage[t]&&n}return s(this),this["[[SetData]]"].delete(e)},clear:function(){i(this,"clear"),this._storage&&(this._storage=Dn()),this["[[SetData]]"]&&this["[[SetData]]"].clear()},values:function(){return i(this,"values"),s(this),this["[[SetData]]"].values()},entries:function(){return i(this,"entries"),s(this),this["[[SetData]]"].entries()},forEach:function(e){i(this,"forEach");var t=arguments.length>1?arguments[1]:null,r=this;s(r),this["[[SetData]]"].forEach(function(i,o){t?n(e,t,o,o,r):e(o,o,r)})}}),p(o.prototype,"keys",o.prototype.values,!0),Se(o.prototype,o.prototype.values),o}()};if(I.Map||I.Set){a(function(){return 2===new Map([[1,2]]).get(1)})||(I.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new V;return arguments.length>0&&xn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,I.Map.prototype),t},I.Map.prototype=E(V.prototype),p(I.Map.prototype,"constructor",I.Map,!0),y.preserveToString(I.Map,V));var Fn=new Map,Ln=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);return e.set(-0,e),e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}(),jn=Fn.set(1,2)===Fn;Ln&&jn||Q(Map.prototype,"set",function(e,t){return n(W,this,0===e?0:e,t),this}),Ln||(g(Map.prototype,{get:function(e){return n(B,this,0===e?0:e)},has:function(e){return n(G,this,0===e?0:e)}},!0),y.preserveToString(Map.prototype.get,B),y.preserveToString(Map.prototype.has,G));var kn=new Set,Vn=function(e){return e.delete(0),e.add(-0),!e.has(0)}(kn),Un=kn.add(1)===kn;if(!Vn||!Un){var Bn=Set.prototype.add;Set.prototype.add=function(e){return n(Bn,this,0===e?0:e),this},y.preserveToString(Set.prototype.add,Bn)}if(!Vn){var Gn=Set.prototype.has;Set.prototype.has=function(e){return n(Gn,this,0===e?0:e)},y.preserveToString(Set.prototype.has,Gn);var Wn=Set.prototype.delete;Set.prototype.delete=function(e){return n(Wn,this,0===e?0:e)},y.preserveToString(Set.prototype.delete,Wn)}var Hn=b(I.Map,function(e){var t=new e([]);return t.set(42,42),t instanceof e}),zn=Object.setPrototypeOf&&!Hn,qn=function(){try{return!(I.Map()instanceof I.Map)}catch(e){return e instanceof TypeError}}();0===I.Map.length&&!zn&&qn||(I.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new V;return arguments.length>0&&xn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},I.Map.prototype=V.prototype,p(I.Map.prototype,"constructor",I.Map,!0),y.preserveToString(I.Map,V));var Jn=b(I.Set,function(e){var t=new e([]);return t.add(42,42),t instanceof e}),Xn=Object.setPrototypeOf&&!Jn,Yn=function(){try{return!(I.Set()instanceof I.Set)}catch(e){return e instanceof TypeError}}();if(0!==I.Set.length||Xn||!Yn){var Kn=I.Set;I.Set=function e(){if(!(this instanceof e))throw new TypeError('Constructor Set requires "new"');var t=new Kn;return arguments.length>0&&An(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},I.Set.prototype=Kn.prototype,p(I.Set.prototype,"constructor",I.Set,!0),y.preserveToString(I.Set,Kn)}var $n=new I.Map,Zn=!a(function(){return $n.keys().next().done});if(("function"!=typeof I.Map.prototype.clear||0!==(new I.Set).size||0!==$n.size||"function"!=typeof I.Map.prototype.keys||"function"!=typeof I.Set.prototype.keys||"function"!=typeof I.Map.prototype.forEach||"function"!=typeof I.Set.prototype.forEach||s(I.Map)||s(I.Set)||"function"!=typeof $n.keys().next||Zn||!Hn)&&g(I,{Map:Mn.Map,Set:Mn.Set},!0),I.Set.prototype.keys!==I.Set.prototype.values&&p(I.Set.prototype,"keys",I.Set.prototype.values,!0),Se(Object.getPrototypeOf((new I.Map).keys())),Se(Object.getPrototypeOf((new I.Set).keys())),u&&"has"!==I.Set.prototype.has.name){var Qn=I.Set.prototype.has;Q(I.Set.prototype,"has",function(e){return n(Qn,this,e)})}}g(I,Mn),_e(I.Map),_e(I.Set)}var ei=function(e){if(!ae.TypeIsObject(e))throw new TypeError("target must be an object")},ti={apply:function(){return ae.Call(ae.Call,null,arguments)},construct:function(e,t){if(!ae.IsConstructor(e))throw new TypeError("First argument must be a constructor.");var n=arguments.length>2?arguments[2]:e;if(!ae.IsConstructor(n))throw new TypeError("new.target must be a constructor.");return ae.Construct(e,t,n,"internal")},deleteProperty:function(e,t){if(ei(e),l){var n=Object.getOwnPropertyDescriptor(e,t);if(n&&!n.configurable)return!1}return delete e[t]},has:function(e,t){return ei(e),t in e}};Object.getOwnPropertyNames&&Object.assign(ti,{ownKeys:function(e){ei(e);var t=Object.getOwnPropertyNames(e);return ae.IsCallable(Object.getOwnPropertySymbols)&&P(t,Object.getOwnPropertySymbols(e)),t}});var ni=function(e){return!o(e)};if(Object.preventExtensions&&Object.assign(ti,{isExtensible:function(e){return ei(e),Object.isExtensible(e)},preventExtensions:function(e){return ei(e),ni(function(){Object.preventExtensions(e)})}}),l){var ii=function(e,t,n){var i=Object.getOwnPropertyDescriptor(e,t);if(!i){var r=Object.getPrototypeOf(e);if(null===r)return;return ii(r,t,n)}return"value"in i?i.value:i.get?ae.Call(i.get,n):void 0},ri=function(e,t,i,r){var o=Object.getOwnPropertyDescriptor(e,t);if(!o){var a=Object.getPrototypeOf(e);if(null!==a)return ri(a,t,i,r);o={value:void 0,writable:!0,enumerable:!0,configurable:!0}}if("value"in o){if(!o.writable)return!1;if(!ae.TypeIsObject(r))return!1;return Object.getOwnPropertyDescriptor(r,t)?ne.defineProperty(r,t,{value:i}):ne.defineProperty(r,t,{value:i,writable:!0,enumerable:!0,configurable:!0})}return!!o.set&&(n(o.set,r,i),!0)};Object.assign(ti,{defineProperty:function(e,t,n){return ei(e),ni(function(){Object.defineProperty(e,t,n)})},getOwnPropertyDescriptor:function(e,t){return ei(e),Object.getOwnPropertyDescriptor(e,t)},get:function(e,t){ei(e);var n=arguments.length>2?arguments[2]:e;return ii(e,t,n)},set:function(e,t,n){ei(e);var i=arguments.length>3?arguments[3]:e;return ri(e,t,n,i)}})}if(Object.getPrototypeOf){var oi=Object.getPrototypeOf;ti.getPrototypeOf=function(e){return ei(e),oi(e)}}if(Object.setPrototypeOf&&ti.getPrototypeOf){var ai=function(e,t){for(var n=t;n;){if(e===n)return!0;n=ti.getPrototypeOf(n)}return!1};Object.assign(ti,{setPrototypeOf:function(e,t){if(ei(e),null!==t&&!ae.TypeIsObject(t))throw new TypeError("proto must be an object or null");return t===ne.getPrototypeOf(e)||!(ne.isExtensible&&!ne.isExtensible(e))&&(!ai(e,t)&&(Object.setPrototypeOf(e,t),!0))}})}var si=function(e,t){if(ae.IsCallable(I.Reflect[e])){a(function(){return I.Reflect[e](1),I.Reflect[e](NaN),I.Reflect[e](!0),!0})&&Q(I.Reflect,e,t)}else p(I.Reflect,e,t)};Object.keys(ti).forEach(function(e){si(e,ti[e])});var li=I.Reflect.getPrototypeOf;if(u&&li&&"getPrototypeOf"!==li.name&&Q(I.Reflect,"getPrototypeOf",function(e){return n(li,I.Reflect,e)}),I.Reflect.setPrototypeOf&&a(function(){return I.Reflect.setPrototypeOf(1,{}),!0})&&Q(I.Reflect,"setPrototypeOf",ti.setPrototypeOf),I.Reflect.defineProperty&&(a(function(){var e=!I.Reflect.defineProperty(1,"test",{value:1}),t="function"!=typeof Object.preventExtensions||!I.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})||Q(I.Reflect,"defineProperty",ti.defineProperty)),I.Reflect.construct&&(a(function(){var e=function(){};return I.Reflect.construct(function(){},[],e)instanceof e})||Q(I.Reflect,"construct",ti.construct)),"Invalid Date"!==String(new Date(NaN))){var ui=Date.prototype.toString,ci=function(){var e=+this;return e!==e?"Invalid Date":ae.Call(ui,this)};Q(Date.prototype,"toString",ci)}var fi={anchor:function(e){return ae.CreateHTML(this,"a","name",e)},big:function(){return ae.CreateHTML(this,"big","","")},blink:function(){return ae.CreateHTML(this,"blink","","")},bold:function(){return ae.CreateHTML(this,"b","","")},fixed:function(){return ae.CreateHTML(this,"tt","","")},fontcolor:function(e){return ae.CreateHTML(this,"font","color",e)},fontsize:function(e){return ae.CreateHTML(this,"font","size",e)},italics:function(){return ae.CreateHTML(this,"i","","")},link:function(e){return ae.CreateHTML(this,"a","href",e)},small:function(){return ae.CreateHTML(this,"small","","")},strike:function(){return ae.CreateHTML(this,"strike","","")},sub:function(){return ae.CreateHTML(this,"sub","","")},sup:function(){return ae.CreateHTML(this,"sup","","")}};c(Object.keys(fi),function(e){var t=String.prototype[e],i=!1;if(ae.IsCallable(t)){var r=n(t,"",' " '),o=S([],r.match(/"/g)).length;i=r!==r.toLowerCase()||o>2}else i=!0;i&&Q(String.prototype,e,fi[e])});var di=function(){if(!ee)return!1;var e="object"==typeof JSON&&"function"==typeof JSON.stringify?JSON.stringify:null;if(!e)return!1;if(void 0!==e(H()))return!0;if("[null]"!==e([H()]))return!0;var t={a:H()};return t[H()]=!0,"{}"!==e(t)}(),hi=a(function(){return!ee||"{}"===JSON.stringify(Object(H()))&&"[{}]"===JSON.stringify([Object(H())])});if(di||!hi){var pi=JSON.stringify;Q(JSON,"stringify",function(e){if("symbol"!=typeof e){var t;arguments.length>1&&(t=arguments[1]);var r=[e];if(i(t))r.push(t);else{var o=ae.IsCallable(t)?t:null,a=function(e,t){var i=o?n(o,this,e,t):t;if("symbol"!=typeof i)return Z.symbol(i)?It({})(i):i};r.push(a)}return arguments.length>2&&r.push(arguments[2]),pi.apply(this,r)}})}return I}),define("readium_js_plugins",["jquery","underscore","eventEmitter"],function(e,t,n){function i(e,t){this.reader=e,this.plugin=t}function r(e){this.create=function(t){return{host:e,instance:new i(e,t)}}}function o(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}var a={},s=function(){this.initialize=function(e){var n=new r(e);if(e.plugins)throw new Error("Already initialized on reader!");e.plugins={},t.each(a,function(e){e.init(n)})},this.getLoadedPlugins=function(){return a},this.register=function(t,i,r){if(a[t])throw new Error("Duplicate registration for plugin with name: "+t);var s;"function"==typeof i?r=i:s=i,a[t]=new o(t,s,function(t,i){if(!t.initialized||!i.host.plugins[t.name]){t.initialized=!0;try{var o={};e.extend(o,new n),r.call(o,i.instance),t.supported=!0,i.host.plugins[t.name]=o}catch(e){t.fail(e)}}})}};return o.prototype={init:function(e){for(var t,n,i=this.dependencies||[],r=0,s=i.length;r<s;++r){if(n=i[r],!((t=a[n])&&t instanceof o))throw new Error("required Plugin '"+n+"' not found");if(t.init(e),!t.supported)throw new Error("required Plugin '"+n+"' not supported")}this.initializer(this,e.create(this))},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Plugin '"+this.name+"' failed to load: "+e)},warn:function(e){console.warn("Plugin "+this.name+": "+e)},deprecationNotice:function(e,t){console.warn("DEPRECATED: "+e+" in Plugin "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in "+this.name+" Plugin: "+e)}},new s}),define("readium_shared_js/globalsSetup",["./globals","jquery","console_shim","es6-shim","eventEmitter","URIjs","readium_cfi_js","readium_js_plugins"],function(e,t,n,i,r,o,a,s){if(console.log("Globals..."),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),i=n.length>>>0;if(0===i)return!1;for(var r=0|t,o=Math.max(r>=0?r:i-Math.abs(r),0);o<i;){if(function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}(n[o],e))return!0;o++}return!1}}),window.ReadiumSDK?(console.log("ReadiumSDK extend."),t.extend(e,window.ReadiumSDK)):console.log("ReadiumSDK set."),window.ReadiumSDK=e,r.prototype.trigger=r.prototype.emit,window.EventEmitter=r,window.URI=o,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}if(e.Plugins=s,e.on(e.Events.READER_INITIALIZED,function(t){e.logEvent("READER_INITIALIZED","ON","globalsSetup.js");try{s.initialize(t)}catch(e){console.error("Plugins failed to initialize:",e)}_.defer(function(){e.logEvent("PLUGINS_LOADED","EMIT","globalsSetup.js"),e.emit(e.Events.PLUGINS_LOADED,t)})}),window._RJS_isBrowser){var l=window._RJS_pluginsList;console.log("Plugins included: ",l.map(function(e){return e.replace("readium_plugin_","")})),require(l)}else setTimeout(function(){var e=Object.keys(s.getLoadedPlugins());console.log("Plugins included: ",e)},0)}),define("readium_shared_js",["readium_shared_js/globalsSetup"],function(e){return e}),define("readium_shared_js/models/bookmark_data",[],function(){var e=function(e,t){var n=this;this.idref=e,this.contentCFI=t,this.toString=function(){return JSON.stringify(n)}};return e.fromString=function(t){var n=JSON.parse(t);return new e(n.idref,n.contentCFI)},e}),define("readium_shared_js/models/current_pages_info",[],function(){return function(e,t){this.isRightToLeft=e.isRightToLeft(),this.isFixedLayout=t,this.spineItemCount=e.items.length,this.openPages=[],this.addOpenPage=function(e,t,n,i){this.openPages.push({spineItemPageIndex:e,spineItemPageCount:t,idref:n,spineItemIndex:i}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var t=this.openPages[this.openPages.length-1];return t.spineItemIndex<e.last().index||t.spineItemPageIndex<t.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var t=this.openPages[0];return e.first().index<t.spineItemIndex||0<t.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(e,t){return e.spineItemIndex!=t.spineItemIndex?e.spineItemIndex-t.spineItemIndex:e.spineItemPageIndex-t.spineItemPageIndex})}}}),define("readium_shared_js/models/fixed_page_spread",[],function(){var e=function(t,n){function i(){s.leftItem=void 0,s.rightItem=void 0,s.centerItem=void 0}function r(t,n){n==e.POSITION_LEFT?s.leftItem=t:n==e.POSITION_RIGHT?s.rightItem=t:(n!=e.POSITION_CENTER&&console.error("Unrecognized position value"),s.centerItem=t)}function o(t){return l?t.isLeftPage()?e.POSITION_LEFT:t.isRightPage()?e.POSITION_RIGHT:e.POSITION_CENTER:e.POSITION_CENTER}function a(e){return e.isLeftPage()?s.spine.isRightToLeft()?s.spine.prevItem(e):s.spine.nextItem(e):e.isRightPage()?s.spine.isRightToLeft()?s.spine.nextItem(e):s.spine.prevItem(e):void 0}var s=this;this.spine=t,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var l=n;this.setSyntheticSpread=function(e){l=e},this.isSyntheticSpread=function(){return l},this.openFirst=function(){0==this.spine.items.length?i():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?i():this.openItem(this.spine.last())},this.openItem=function(t){i();var n=o(t);if(r(t,n),n!=e.POSITION_CENTER&&this.spine.isValidLinearItem(t.index)){var s=a(t);if(s){var l=o(s);l!=n&&l!=e.POSITION_CENTER&&!s.isReflowable()&&s.isRenditionSpreadAllowed()&&r(s,l)}}},this.openNext=function(){var e=this.validItems();if(0==e.length)this.openFirst();else{var t=this.spine.nextItem(e[e.length-1]);t&&this.openItem(t)}},this.openPrev=function(){var e=this.validItems();if(0==e.length)this.openLast();else{var t=this.spine.prevItem(e[0]);t&&this.openItem(t)}},this.validItems=function(){var e=[];return this.leftItem&&e.push(this.leftItem),this.rightItem&&e.push(this.rightItem),this.centerItem&&e.push(this.centerItem),e.sort(function(e,t){return e.index-t.index}),e}};return e.POSITION_LEFT="left",e.POSITION_RIGHT="right",e.POSITION_CENTER="center",e}),define("readium_shared_js/models/spine_item",[],function(){var e=function(t,n,i){function r(){a.page_spread&&a.page_spread!=e.SPREAD_LEFT&&a.page_spread!=e.SPREAD_RIGHT&&a.page_spread!=e.SPREAD_CENTER&&console.error(a.page_spread+" is not a recognized spread type")}function o(e,t){return a[e]?a[e]===t:!!a.spine.package[e]&&a.spine.package[e]===t}var a=this;this.idref=t.idref,this.href=t.href,this.cfi=t.cfi,this.linear=t.linear?t.linear.toLowerCase():t.linear,this.page_spread=t.page_spread,this.rendition_viewport=t.rendition_viewport,this.rendition_spread=t.rendition_spread,this.rendition_orientation=t.rendition_orientation,this.rendition_layout=t.rendition_layout,this.rendition_flow=t.rendition_flow,this.media_overlay_id=t.media_overlay_id,this.media_type=t.media_type,this.index=n,this.spine=i,r(),this.setSpread=function(e){this.page_spread=e,r()},this.isRenditionSpreadAllowed=function(){var t=a.getRenditionSpread();return!t||t!=e.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return a.page_spread==e.SPREAD_LEFT},this.isRightPage=function(){return a.page_spread==e.SPREAD_RIGHT},this.isCenterPage=function(){return a.page_spread==e.SPREAD_CENTER},this.isReflowable=function(){return!a.isFixedLayout()},this.isFixedLayout=function(){if(a.getRenditionLayout()){if(a.rendition_layout){if(a.rendition_layout===e.RENDITION_LAYOUT_PREPAGINATED)return!0;if(a.rendition_layout===e.RENDITION_LAYOUT_REFLOWABLE)return!1}return a.spine.package.isFixedLayout()}return a.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return a.rendition_flow?a.rendition_flow:a.spine.package.rendition_flow},this.getRenditionViewport=function(){return a.rendition_viewport?a.rendition_viewport:a.spine.package.rendition_viewport},this.getRenditionSpread=function(){return a.rendition_spread?a.rendition_spread:a.spine.package.rendition_spread},this.getRenditionOrientation=function(){return a.rendition_orientation?a.rendition_orientation:a.spine.package.rendition_orientation},this.getRenditionLayout=function(){return a.rendition_layout?a.rendition_layout:a.spine.package.rendition_layout},this.isFlowScrolledContinuous=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return o("rendition_flow",e.RENDITION_FLOW_SCROLLED_DOC)}};return e.RENDITION_LAYOUT_REFLOWABLE="reflowable",e.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",e.RENDITION_ORIENTATION_LANDSCAPE="landscape",e.RENDITION_ORIENTATION_PORTRAIT="portrait",e.RENDITION_ORIENTATION_AUTO="auto",e.SPREAD_LEFT="page-spread-left",e.SPREAD_RIGHT="page-spread-right",e.SPREAD_CENTER="page-spread-center",e.RENDITION_SPREAD_NONE="none",e.RENDITION_SPREAD_LANDSCAPE="landscape",e.RENDITION_SPREAD_PORTRAIT="portrait",e.RENDITION_SPREAD_BOTH="both",e.RENDITION_SPREAD_AUTO="auto",e.RENDITION_FLOW_PAGINATED="paginated",e.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",e.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",e.RENDITION_FLOW_AUTO="auto",e.alternateSpread=function(t){return t===e.SPREAD_LEFT?e.SPREAD_RIGHT:t===e.SPREAD_RIGHT?e.SPREAD_LEFT:t},e}),define("readium_shared_js/helpers",["./globals","underscore","jquery","jquerySizes","./models/spine_item","URIjs"],function(e,t,n,i,r,o){!function(){"use strict";if(window.performance){if(window.performance.now)return;for(var e=["webkitNow","mozNow","msNow","oNow"],t=0;t<e.length;t++)if(e[t]in window.performance)return void(window.performance.now=window.performance[e[t]])}else window.performance={};if(Date.now)return void(window.performance.now=function(){return Date.now()});window.performance.now=function(){return+new Date}}();var a={};return a.getEbookUrlFilePath=function(e){return window.Blob&&window.File?e instanceof File?e.name:e instanceof Blob?"readium-ebook.epub":e:e},a.getURLQueryParams=function(e){var t={},n=e||window.location.search;if(n&&n.length){n=n.substring(1);for(var i=n.split("&"),r=0;r<i.length;r++){var o=i[r].split("=");o.length>1&&(t[o[0]]=decodeURIComponent(o[1]))}}return t},a.buildUrlQueryParameters=function(e,n){var i=new o(e||window.location),r=i.search(),s=i.hash(),l=i.search("").hash("").toString(),u="";for(var c in n)if(n.hasOwnProperty(c)&&n[c]){var f=n[c];t.isString(f)&&(f=f.trim()),f&&(f=f.verbatim?f.value:encodeURIComponent(f),console.debug("URL QUERY PARAM OVERRIDE: "+c+" = "+f),u+=c+"="+f,u+="&")}var d=a.getURLQueryParams(r);for(var h in d)if(d.hasOwnProperty(h)&&d[h]&&!n[h]){var p=d[h].trim();p&&(console.debug("URL QUERY PARAM PRESERVED: "+h+" = "+p),u+=h+"="+encodeURIComponent(p),u+="&")}return u=u.slice(0,-1),l+"?"+u+s},a.Rect=function(e,t,n,i){this.left=e,this.top=t,this.width=n,this.height=i,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(e,t){return void 0==t&&(t=0),!(e.right()<this.left+t||e.left>this.right()-t||e.bottom()<this.top+t||e.top>this.bottom()-t)}},a.Rect.fromElement=function(e){var n;n=t.isArray(e)||e instanceof jQuery?e[0]:e,3===n.nodeType&&(n=e.parent()[0]);for(var i=n.offsetLeft,r=n.offsetTop,o=n.offsetWidth,s=n.offsetHeight;n=n.offsetParent;)i+=n.offsetLeft,r+=n.offsetTop;return new a.Rect(i,r,o,s)},a.UpdateHtmlFontAttributes=function(e,i,r,o){var a=n("head",e),s=n("#readium_font_family_link",a);var l=0,u=function(){if(0!=l){var t=n("style#readium-fontFamily",a);if(t&&t[0]&&a[0].removeChild(t[0]),1==l){var s=e[0].ownerDocument.createElement("style");s.setAttribute("id","readium-fontFamily"),s.appendChild(e[0].ownerDocument.createTextNode('html * { font-family: "'+r.fontFamily+'" !important; }')),a[0].appendChild(s)}}var u=i/100,c=e[0].ownerDocument.defaultView;if(!c)return void console.log("NIL $epubHtml[0].ownerDocument.defaultView");for(var f=n("p, div, span, h1, h2, h3, h4, h5, h6, li, blockquote, td, pre, dt, dd, code, a",e),d=0;d<f.length;d++){var h=f[d],p=h.getAttribute("data-original-font-size");if(p)break;var s=c.getComputedStyle(h),g=parseInt(s.fontSize);h.setAttribute("data-original-font-size",g);var m=parseInt(s.lineHeight);m&&h.setAttribute("data-original-line-height",m)}for(var d=0;d<f.length;d++){var h=f[d],p=h.getAttribute("data-original-font-size"),g=p?Number(p):0;g&&n(h).css("font-size",g*u+"px")
;var v=h.getAttribute("data-original-line-height"),m=v?Number(v):0;m&&n(h).css("line-height",m*u+"px")}e.css("font-size",i+"%");o()},c=t.once(u);if(r.fontFamily&&r.url){var f=s.length?s.attr("data-fontfamily"):void 0;s.length?f!=r.fontFamily?(l=1,s.attr({"data-fontfamily":r.fontFamily,href:r.url})):l=0:(l=1,setTimeout(function(){s=n("<link/>",{id:"readium_font_family_link","data-fontfamily":r.fontFamily,rel:"stylesheet",type:"text/css"}),a.append(s),s.attr({href:r.url})},0))}else l=2,s.length&&s.remove();1==l?setTimeout(function(){c()},100):c()},a.ResolveContentRef=function(e,t){if(!t)return e;var n=t.split("/");n.pop();for(var i=e.split("/");n.length>0&&".."===i[0];)n.pop(),i.splice(0,1);return n.concat(i).join("/")},a.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},a.BeginsWith=function(e,t){return 0===e.indexOf(t)},a.RemoveFromString=function(e,t){var n=e.indexOf(t);return-1==n?e:e.substring(0,n)+e.substring(n+t.length)},a.Margins=function(e,t,n){this.margin=e,this.border=t,this.padding=n,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},a.triggerLayout=function(e){var t=e[0].contentDocument;if(t){var n=void 0;try{if(!(n=t.styleSheets&&t.styleSheets.length?t.styleSheets[0]:void 0)){var i=t.createElement("style");t.head.appendChild(i),i.appendChild(t.createTextNode("")),n=i.sheet}if(n){var r="body:first-child::before {content:'READIUM';color: red;font-weight: bold;}";n.cssRules?n.insertRule(r,n.cssRules.length):n.insertRule(r,0)}}catch(e){console.error(e)}try{var o=t.createElementNS("http://www.w3.org/1999/xhtml","style");o.appendChild(t.createTextNode("*{}")),t.body.appendChild(o),t.body.removeChild(o),n&&(n.cssRules?n.deleteRule(n.cssRules.length-1):n.deleteRule(0))}catch(e){console.error(e)}if(t.body){t.body.offsetTop}}},a.deduceSyntheticSpread=function(t,n,i){if(!t||0==t.length)return 0;var o=n?n.getRenditionSpread():void 0;if(o===r.RENDITION_SPREAD_NONE)return!1;if("double"==i.syntheticSpread)return!0;if("single"==i.syntheticSpread)return!1;if(!n)return 0;if(o===r.RENDITION_SPREAD_BOTH)return!0;var s=a.getOrientation(t);if(o===r.RENDITION_SPREAD_LANDSCAPE)return s===e.Views.ORIENTATION_LANDSCAPE;if(o===r.RENDITION_SPREAD_PORTRAIT)return s===e.Views.ORIENTATION_PORTRAIT;if(!o||o===r.RENDITION_SPREAD_AUTO){return s===e.Views.ORIENTATION_LANDSCAPE?1:0}return console.warn("Helpers.deduceSyntheticSpread: spread properties?!"),0},a.Margins.fromElement=function(e){return new this(e.margin(),e.border(),e.padding())},a.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},a.loadTemplate=function(e,t){return a.loadTemplate.cache[e]},a.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe enable-annotation="enable-annotation" allowfullscreen="allowfullscreen" scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe enable-annotation="enable-annotation" allowfullscreen="allowfullscreen" scrolling="no" id="epubContentIframe"></iframe></div>'},a.setStyles=function(e,t){var i=e.length;if(i){for(var r="",o=[],a=!(!t||!t.createTextNode),s=0;s<i;s++){var l=e[s];if(a){if(l.selector&&""!=l.selector&&"html"!=l.selector&&"body"!=l.selector&&"*"!=l.selector){var u="";for(var c in l.declarations)if(l.declarations.hasOwnProperty(c)){var f=c.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()});u+=f+": "+l.declarations[c]+" !important; "}o.push({selector:l.selector,cssProps:u})}else for(var c in l.declarations)if(l.declarations.hasOwnProperty(c)){var f=c.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()});r+=f+": "+l.declarations[c]+" !important; "}}else l.selector?n(l.selector,t).css(l.declarations):t.css(l.declarations)}if(a){var d=t,h=n("style#readium-bookStyles",d.head);h&&h[0]&&d.head.removeChild(h[0]);var p="";if(r.length>0&&(p+=" body, body::after, body::before, body *, body *::after, body *::before { "+r+" } "),o.length>0)for(var s=0;s<o.length;s++){var g=o[s];p+=" "+g.selector+" { "+g.cssProps+" } "}if(p.length>0){var m=d.createElement("style");m.setAttribute("id","readium-bookStyles"),m.appendChild(d.createTextNode(p)),d.head.appendChild(m)}}}},a.isIframeAlive=function(e){var t=void 0,n=void 0;try{t=e.contentWindow,n=e.contentDocument}catch(e){return console.error(e),!1}return t&&n},a.getOrientation=function(t){var n=t.width(),i=t.height();if(n&&i)return n>=i?e.Views.ORIENTATION_LANDSCAPE:e.Views.ORIENTATION_PORTRAIT},a.isRenditionSpreadPermittedForItem=function(t,n){var i=t.getRenditionSpread();return!i||i==r.RENDITION_SPREAD_BOTH||i==r.RENDITION_SPREAD_AUTO||i==r.RENDITION_SPREAD_LANDSCAPE&&n==e.Views.ORIENTATION_LANDSCAPE||i==r.RENDITION_SPREAD_PORTRAIT&&n==e.Views.ORIENTATION_PORTRAIT},a.CSSTransition=function(e,n){var i={};t.each(["","-webkit-","-moz-","-ms-"],function(e){i[e+"transition"]=e+n}),e.css(i)},a.CSSTransformString=function(e){var t,n,i,r=!!e.enable3D,o=e.origin;if(e.left||e.top){var a=e.left||0,s=e.top||0;t=r?"translate3D("+a+"px, "+s+"px, 0)":"translate("+a+"px, "+s+"px)"}if(e.scale&&(n=r?"scale3D("+e.scale+", "+e.scale+", 0)":"scale("+e.scale+")"),e.angle&&(i=r?"rotate3D(0,0,"+e.angle+"deg)":"rotate("+e.angle+"deg)"),!(t||n||i))return{};var l=t&&n?t+" "+n:t||n;i&&(l=l+" "+i);var u={};return u.transform=l,u["transform-origin"]=o||(r?"0 0 0":"0 0"),u},a.extendedThrottle=function(e,t,n,i,r,o){i||(i=250),r||(r=i);var a,s,l=!0;return function(){var u=o||this,c=Date.now&&Date.now()||(new Date).getTime(),f=arguments;a&&c<a+i||(a=c,l?(e.apply(u,f),l=!1):t.apply(u,f)),clearTimeout(s),s=setTimeout(function(){a=c,l=!0,n.apply(u,f)},r)}},a.escapeJQuerySelector=function(e){if(e){return e.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1")}},a.polyfillCaretRangeFromPoint=function(e){if(!e.caretRangeFromPoint)if(e.caretPositionFromPoint)e.caretRangeFromPoint=function(t,n){var i=e.createRange(),r=e.caretPositionFromPoint(t,n);return r?(r.offsetNode&&(i.setStart(r.offsetNode,r.offset),i.setEnd(r.offsetNode,r.offset)),i):null};else if((e.body||e.createElement("body")).createTextRange){var t={convertToDOMRange:function(e,t){var n=function(e,n,i){var r=t.createElement("a"),o=n.duplicate();o.collapse(i);var a=o.parentElement();do{a.insertBefore(r,r.previousSibling),o.moveToElementText(r)}while(o.compareEndPoints(i?"StartToStart":"StartToEnd",n)>0&&r.previousSibling);-1==o.compareEndPoints(i?"StartToStart":"StartToEnd",n)&&r.nextSibling?(o.setEndPoint(i?"EndToStart":"EndToEnd",n),e[i?"setStart":"setEnd"](r.nextSibling,o.text.length)):e[i?"setStartBefore":"setEndBefore"](r),r.parentNode.removeChild(r)},i=t.createRange();return n(i,e,!0),n(i,e,!1),i}};e.caretRangeFromPoint=function(n,i){for(var r=e.body.createTextRange(),o=40;o;o-=4)try{return r.moveToPoint(n,o+i-40),t.convertToDOMRange(r,e)}catch(e){}try{var a=e.elementFromPoint(n-1,i-1),s=e.createRange();return s.setStartAfter(a),s}catch(e){return null}}}},a}),define("readium_shared_js/views/cfi_navigation_logic",["jquery","underscore","../helpers","readium_cfi_js"],function(e,t,n,i){return function(r){function o(){return re.getRootDocument().createRange()}function a(e){var t=o();return t.selectNodeContents(e),t}function s(e){var t=o();return t.selectNode(e),C(t.getBoundingClientRect(),0,0)}function l(e){var t=o();return t.selectNodeContents(e),C(t.getBoundingClientRect(),0,0)}function u(e,t,n,i){var r=o();return r.setStart(e,t||0),n.nodeType===Node.ELEMENT_NODE?r.setEnd(n,i||n.childNodes.length):n.nodeType===Node.TEXT_NODE&&r.setEnd(n,i||0),r.collapsed?C(r.getClientRects()[0],0,0):C(r.getBoundingClientRect(),0,0)}function c(e,n){return n=n||y(),t.map(e.getClientRects(),function(e){return C(e,n.left,n.top)})}function f(){return r.frameDimensionsGetter?r.frameDimensionsGetter():(console.error("CfiNavigationLogic: No frame dimensions specified!"),null)}function d(e,t,i){return i=i||re.getRootDocument(),n.polyfillCaretRangeFromPoint(i),i.caretRangeFromPoint(e,t)}function h(){return!!r.paginationInfo}function p(){return r.paginationInfo&&!!r.paginationInfo.rightToLeft}function g(){return r.paginationInfo&&!!r.paginationInfo.isVerticalWritingMode}function m(e,t,n){return n=n||f(),!!e&&((0!=e.left||0!=e.right||0!=e.top||0!=e.bottom)&&(h()&&!g()?e.left>=0&&e.left<n.width||!t&&e.left<0&&e.right>0:e.top>=0&&e.top<n.height||!t&&e.top<0&&e.bottom>0))}function v(){return!r.paginationInfo||g()?r.$iframe.width():r.paginationInfo.columnWidth+r.paginationInfo.columnGap}function y(){return r.visibleContentOffsetsGetter?r.visibleContentOffsetsGetter():g()&&r.paginationOffsetsGetter?r.paginationOffsetsGetter():{top:0,left:0}}function E(){return r.paginationOffsetsGetter?r.paginationOffsetsGetter():{top:0,left:0}}function b(e,t,n,i){n=n||y(),i=i||f();var r=S(e,n);if(0===r.length)return null;var o=0;if(1===r.length){var a=r[0];h()&&(a.bottom>i.height||a.top<0)&&N(a,!0,i),m(a,!1,i)&&(o=t&&a.top<0?Math.floor(100*(a.height+a.top)/a.height):t&&a.bottom>i.height?Math.floor(100*(i.height-a.top)/a.height):t&&a.left<0&&a.right>0?Math.floor(100*a.right/a.width):t&&a.left<0&&a.right>0?Math.floor(100*a.right/a.width):100)}else for(var s=0,l=r.length;s<l;++s)if(m(r[s],!1,i)){o=t?_(r,s):100;break}return o}function I(e){var t=y(),n=S(e,t);return 0===n.length?null:T(n)}function T(e,n,i){var o=p(),a=g();i=i||v(),n=n||f();var s=t.first(e);1===e.length&&N(s,!1,n,i,o,a);var l;if(a){var u=s.top;l=Math.floor(u/n.height)}else{var c=s.left;o&&(c=i*(r.paginationInfo?r.paginationInfo.visibleColumnCount:1)-c),l=Math.floor(c/i)}return l}function w(e,t,n){return t=t||y(),n=n||f(),T([C(e,t.left,t.top)],n)}function _(e,n){var i=0,r=0;return e.length>1?t.each(e,function(e,t){i+=e.height,t>=n&&(r+=e.height)}):(i=e[0].height,r=e[0].height-Math.max(0,-e[0].top)),r===i?100:Math.floor(100*r/i)}function S(e,t){t=t||{};var n,i=t.left||0,r=t.top||0,a=e[0].nodeType===Node.TEXT_NODE;if(a){var s=o();s.selectNode(e[0]),n=s.getClientRects()}else n=e[0].getClientRects();for(var l=[],u=0,c=n.length;u<c;++u)(n[u].height>0||1===n.length)&&l.push(C(n[u],i,r));return l}function O(e,t){t=t||{};var n,i=t.left||0,r=t.top||0,a=e[0].nodeType===Node.TEXT_NODE;if(a){var s=o();s.selectNode(e[0]),n=s.getBoundingClientRect()}else n=e[0].getBoundingClientRect();return C(n,i,r)}function C(e,t,n){var i={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.right-e.left,height:e.bottom-e.top};return t=t||0,n=n||0,P(i,t,n),i}function P(e,t,n){e.left+=t,e.right+=t,e.top+=n,e.bottom+=n}function N(e,t,n,i,r,o){if(n=n||f(),i=i||v(),r=r||p(),!(o=o||g())){for(r&&(i*=-1);e.top<0;)P(e,-i,n.height);if(t)for(;e.bottom>=n.height&&!m(e,!1,n);)P(e,i,-n.height)}}function R(e,t){var n=t/100;return Math.round((e.endOffset-e.startOffset)*n)}function D(e,t){if(e.endOffset-e.startOffset==1)return[e];var n=R(e,t),i=e.startContainer,r=e.cloneRange();r.setStart(i,e.startOffset),r.setEnd(i,e.startOffset+n);var o=e.cloneRange();return o.setStart(i,e.startOffset+n),o.setEnd(i,e.endOffset),[r,o]}function x(e,t,n,i){n=n||y();var r=a(e),o=c(r,n),s=A(o,t([0,1]));return L(D(r,s),n,t([0,1]),s,function(e){return(g()?e.height:e.width)&&m(e,!1,i)})}function A(e,n){var i=0,r=t.filter(e,function(e){return(g()?e.height:e.width)&&m(e,!1,f())}),o=F(r),a=s-o,s=F(e);return o===s?n?55:45:(i=o/s*100,a>o?i+5:i-5)}function M(e){var n=e.sort(function(e,t){return e.top<t.top}),i=[];t.each(n,function(e){var t=e.top;if(i[t]){var n=i[t];n.push(e.height),i[t]=n}else i[t]=[e.height]})}function F(e){var n=M(e),i=0;return t.each(n,function(e){i+=Math.max.apply(null,e)}),i}function L(e,t,n,i,r){for(var o=0,a=e;1!==a.length;){o++;a=j(c(a[n],t),r)?D(a[n],i):D(a[n?0:1],i)}oe&&(console.debug("getVisibleTextRangeOffsets:getTextRangeOffset:runCount",o),window.top._DEBUG_visibleTextRangeOffsetsRuns.push(o));var s=a[0];return s&&s.collapse(!n),s}function j(e,n){return!!t.filter(e,n).length}function k(e,t,n,i){if(!e)return null;var r=e.element,o=e.textNode;if(o&&Y(o)){var a=x(o,t,n,i);return a?B(a):(oe&&console.warn("findVisibleLeafNodeCfi: failed to find text range offset"),null)}return re.getCfiForElement(r)}function V(e,n){return k(re.findLastVisibleElement(e,n),t.last,e,n)}function U(e,n){return k(re.findFirstVisibleElement(e,n),t.first,e,n)}function B(e){return e.collapsed&&e.startContainer.nodeType===Node.TEXT_NODE?i.generateCharacterOffsetCFIComponent(e.startContainer,e.startOffset,["cfi-marker"],[],["MathJax_Message","MathJax_SVG_Hidden"]):e.collapsed?re.getCfiForElement(e.startContainer):i.generateRangeComponent(e.startContainer,e.startOffset,e.endContainer,e.endOffset,re.getClassBlacklist(),re.getElementBlacklist(),re.getIdBlacklist())}function G(e){return"epubcfi(/99!"+e+")"}function W(e){return i.Interpreter.isRangeCfi(G(e))}function H(e){return i.Interpreter.hasTextTerminus(G(e))}function z(e,t,n,r){var o=re.getRootDocument(),a=G(e);try{var s=i.getTargetElement(a,o,t,n,r)}catch(e){}return s&&0!=s.length?s:void console.log("Can't find element for CFI: "+e)}function q(t){var n=re.getLeafNodeElements(e(re.getBodyElement())),i=t(n),r=t([!0,!1]),a=o();return a.selectNodeContents(i[0]),a.collapse(r),B(a)}function J(e){var n=e.className;n&&void 0!==n.animVal?n=n.animVal:n&&void 0!==n.baseVal&&(n=n.baseVal);var i=n?n.split(" "):[],r=e.id,o=re.getClassBlacklist();return!(1!==i.length||!t.contains(o,i[0]))||(!(!i.length||!t.intersection(o,i).length)||(!!(r&&r.length&&t.contains(re.getIdBlacklist(),r))||!!t.contains(re.getElementBlacklist(),e.tagName.toLowerCase())))}function X(e){return!!e&&e.nodeType===Node.ELEMENT_NODE}function Y(e){return!!e&&(e.nodeType===Node.TEXT_NODE&&K(e.nodeValue))}function K(e){return!!e.trim().length}function $(){var e=this,n={leafNodeElements:!0,visibleLeafNodes:!1};t.each(n,function(t,n){e[n]=new Map}),this._invalidate=function(){t.each(n,function(t,n){t||(e[n]=new Map)})}}function Z(){for(var e="0123456789ABCDEF".split(""),t="#",n=0;n<6;n++)t+=e[Math.round(15*Math.random())];return t}function Q(t,n,i){var r=Z();t instanceof Array||(t=[t]);for(var o=0;o!=t.length;o++){var a=t[o],s=i.createElement("div");s.style.position="absolute",e(s).css("z-index","1000"),e(s).css("pointer-events","none"),e(s).css("opacity","0.4"),s.style.border="1px solid white",n||r?r&&!n?s.style.background=r:(!0===n&&(n="red"),s.style.border="1px dashed "+n,s.style.background="yellow"):s.style.background="purple",s.style.margin=s.style.padding="0",s.style.top=a.top+"px",s.style.left=a.left+"px",s.style.width=a.width-2+"px",s.style.height=a.height-2+"px",i.documentElement.appendChild(s),le.push(e(s))}}function ee(e){var t=E();Q({left:e.left+t.left,top:e.top+t.top,width:e.width,height:e.height},!0,re.getRootDocument())}function te(e){var t=u(e.startContainer,e.startOffset,e.endContainer,e.endOffset);return ee(t),t}function ne(e){ee(s(e))}function ie(){t.each(le,function(e){e.remove()}),le=[]}var re=this;r=r||{};var oe=ReadiumSDK.DEBUG_MODE;oe&&(window.top._DEBUG_visibleTextRangeOffsetsRuns=window.top._DEBUG_visibleTextRangeOffsetsRuns||[]),this.getRootElement=function(){return r.$iframe?r.$iframe[0].contentDocument.documentElement:null},this.getBodyElement=function(){var e=this.getRootDocument();return e&&e.body?e.body:this.getRootElement()},this.getClassBlacklist=function(){return r.classBlacklist||[]},this.getIdBlacklist=function(){return r.idBlacklist||[]},this.getElementBlacklist=function(){return r.elementBlacklist||[]},this.getRootDocument=function(){return r.$iframe?r.$iframe[0].contentDocument:null},this.getCfiForElement=function(e){var t=i.Generator.generateElementCFIComponent(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());return"!"==t[0]&&(t=t.substring(1)),t},this.getVisibleCfiFromPoint=function(e,t,n){var i=re.getRootDocument(),r=d(e,t,i),a=i.elementFromPoint(e,t),s=!a||a===i.documentElement;if(n){if(!a||s)return null;var u=l(a);if(!m(u,!1))return null;if(e<u.left||e>u.right||t<u.top||t>u.bottom)return null}if(!r){if(s)return console.error("Could not generate CFI no visible element on page"),null;r=o(),r.selectNode(a)}var c,f,h,p=r,g=p.startContainer;if(g.nodeType===Node.TEXT_NODE){if(n&&g.parentNode!==a)return null;1===g.length&&1===p.startOffset?(f=0,h=1):p.startOffset===g.length?(f=p.startOffset-1,h=p.startOffset):(f=p.startOffset,h=p.startOffset+1);var v={startContainer:g,endContainer:g,startOffset:f,endOffset:h,commonAncestorContainer:p.commonAncestorContainer};oe&&te(v),c=B(v)}else if(g.nodeType===Node.ELEMENT_NODE){if(g=p.startContainer.childNodes[p.startOffset]||p.startContainer.childNodes[0]||p.startContainer,n&&g!==a)return null;c=g.nodeType!==Node.ELEMENT_NODE?B(p):re.getCfiForElement(g)}else{if(n&&g!==a)return null;c=re.getCfiForElement(a)}return c&&-1!==c.indexOf("NaN")?void console.log("Did not generate a valid CFI:"+c):c},this.getRangeCfiFromPoints=function(e,t,n,i){var r=re.getRootDocument(),a=d(e,t,r),s=d(n,i,r),l=o();return l.setStart(a.startContainer,a.startOffset),l.setEnd(s.startContainer,s.startOffset),a.startContainer===a.endContainer&&a.startContainer.nodeType===Node.TEXT_NODE&&s.startContainer.length>s.startOffset+1&&l.setEnd(s.startContainer,s.startOffset+1),B(l)},this.getFirstVisibleCfi=function(e,t){return U(e,t)},this.getLastVisibleCfi=function(e,t){return V(e,t)},this.getDomRangeFromRangeCfi=function(e,t,n){var i=o();if(t){if(re.isRangeCfi(e)){var r=re.getNodeRangeInfoFromCfi(e);i.setStart(r.startInfo.node,r.startInfo.offset)}else{var a=re.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];i.setStart(a,0)}if(re.isRangeCfi(t)){var s=re.getNodeRangeInfoFromCfi(t);n?i.setEnd(s.endInfo.node,s.endInfo.offset):i.setEnd(s.startInfo.node,s.startInfo.offset)}else{var l=re.getElementByCfi(t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];i.setEnd(l,l.childNodes.length)}}else if(re.isRangeCfi(e)){var u=re.getNodeRangeInfoFromCfi(e);i.setStart(u.startInfo.node,u.startInfo.offset),i.setEnd(u.endInfo.node,u.endInfo.offset)}else{var c=re.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist())[0];i.selectNode(c)}return i},this.getRangeCfiFromDomRange=function(e){return B(e)},this.isRangeCfi=function(e){return W(e)||H(e)},this.getPageIndexDeltaForCfi=function(e,t,n,i){if(this.isRangeCfi(e)){return w(this.getNodeRangeInfoFromCfi(e).clientRect)}var r=z(e,t,n,i);return r?this.getPageIndexDeltaForElement(r):-1},this.getElementFromPoint=function(e,t){return re.getRootDocument().elementFromPoint(e,t)},this.getNodeRangeInfoFromCfi=function(e){var t=re.getRootDocument(),n=G(e);if(W(e)){try{var r=i.Interpreter.getRangeTargetElements(n,t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());oe&&console.log(r)}catch(e){}if(!r)return void console.log("Can't find nodes for range CFI: "+e);var o={node:r.startElement,offset:r.startOffset},a={node:r.endElement,offset:r.endOffset},s=o&&a?u(o.node,o.offset,a.node,a.offset):null;return oe&&(console.log(s),Q(s,"purple",t)),{startInfo:o,endInfo:a,clientRect:s}}if(H(e)){try{var l=i.Interpreter.getTextTerminusInfo(n,t,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist());oe&&console.log(l)}catch(e){}if(!l)return void console.log("Can't find node for text term CFI: "+e);var c={node:l.textNode,offset:l.textOffset},f=u(c.node,c.offset,c.node,c.offset);return oe&&(console.log(f),Q(f,"purple",t)),{startInfo:c,endInfo:c,clientRect:f}}return{startInfo:null,endInfo:null,clientRect:O(re.getElementByCfi(e,this.getClassBlacklist(),this.getElementBlacklist(),this.getIdBlacklist()),y())}},this.isNodeFromRangeCfiVisible=function(e){var t=this.getNodeRangeInfoFromCfi(e);return t?m(t.clientRect,!1):void 0},this.getNearestCfiFromElement=function(n){var i,r,o,a=t.filter(n.parentNode.childNodes,function(e){return e===n||Y(e)}),s=a.indexOf(n),l=a[s-1];if(l||(l=a[s+1],i=!0),l||(l=t.last(this.getLeafNodeElements(e(n.previousElementSibling))))||(i=!0,l=t.first(this.getLeafNodeElements(e(n.nextElementSibling)))),Y(l)?(r=l,o=!0):r=X(l)?l:X(n.previousElementSibling)?n.previousElementSibling:X(n.nextElementSibling)?n.nextElementSibling:n.parentNode,o){var u=r.ownerDocument.createRange();return u.selectNodeContents(r),u.collapse(i),this.getRangeCfiFromDomRange(u)}return this.getCfiForElement(r)},this.getElementByCfi=function(e,t,n,i){return z(e,t,n,i)},this.getPageIndexDeltaForElement=function(e){var t=I(e);if(null===t){return I(this.getElementByCfi(this.getNearestCfiFromElement(e[0])))}return t},this.getElementById=function(t){var n=this.getRootDocument(),i=e(n.getElementById(t));if(0!=i.length)return i},this.getPageIndexDeltaForElementId=function(e){var t=this.getElementById(e);return t?this.getPageIndexDeltaForElement(t):-1},this.getFirstVisibleMediaOverlayElement=function(t){function n(i){if(i&&i.length)for(var a=0,s=i.length;a<s;a++){var l=i[a];if(l){var u=e(l);if(u.data("mediaOverlayData")){var c=r.getElementVisibility(u,t);if(c&&(o||(o=l),100==c))return l}else{var f=n(l.children);if(f)return f}}}}var i=e(this.getBodyElement());if(i&&i.length&&i[0]){var r=this,o=void 0,a=n([i[0]]);return a||(a=o),a}},this.getElementVisibility=function(e,t){return b(e,!0,t)},this.isElementVisible=this.getElementVisibility,this.getVisibleElementsWithFilter=function(t,n){var i=this.getElementsWithFilter(e(this.getBodyElement()),n);return this.getVisibleElements(i,t)},this.getAllElementsWithFilter=function(t){return this.getElementsWithFilter(e(this.getBodyElement()),t)},this.getAllVisibleElementsWithSelector=function(t,n){var i=e(t,this.getRootElement()),r=[];return e.each(i,function(){r.push(e(this))}),this.getVisibleElements(r,n)},this.getVisibleElements=function(e,n,i){var r=[];return t.each(e,function(e){var t=e[0].nodeType===Node.TEXT_NODE,o=t?e.parent():e,a=b(e,!0,n,i);a&&r.push({element:o[0],textNode:t?e[0]:null,percentVisible:a})}),r},this.getVisibleLeafNodes=function(t,n){if(se){var i=(r.paginationInfo||{}).currentSpreadIndex||0,o=ae.visibleLeafNodes.get(i);if(o)return o}var a=this.getLeafNodeElements(e(this.getBodyElement())),s=this.getVisibleElements(a,t,n);return se&&ae.visibleLeafNodes.set(i,s),s},this.getStartCfi=function(){return q(t.first)},this.getEndCfi=function(){return q(t.last)},this.getElementsWithFilter=function(t,n){function i(t){if(void 0!=t)for(var o=0,a=t.length;o<a;o++){var s=e(t[o]);n(s)?r.push(s):i(s[0].children)}}var r=[];return i([t[0]]),r},this.getLeafNodeElements=function(t){if(se){var n=ae.leafNodeElements.get(t);if(n)return n}for(var i,r=document.createNodeIterator(t[0],NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(){return NodeFilter.FILTER_ACCEPT},!1),o=[];i=r.nextNode();){if(i.nodeType===Node.ELEMENT_NODE&&!i.childElementCount&&!K(i.textContent)||Y(i)){J(i.nodeType===Node.TEXT_NODE?i.parentNode:i)||o.push(e(i))}}return se&&ae.leafNodeElements.set(t,o),o},this.getElements=function(t){return t?e(t,this.getRootElement()):e(this.getRootElement()).children()},this.getElement=function(e){var t=this.getElements(e);if(t.length>0)return t};var ae=new $,se=!1;this.invalidateCache=function(){ae._invalidate()};var le=[];ReadiumSDK._DEBUG_CfiNavigationLogic={clearDebugOverlays:ie,drawDebugOverlayFromRect:ee,drawDebugOverlayFromDomRange:te,drawDebugOverlayFromNode:ne,debugVisibleCfis:function(){console.log(JSON.stringify(ReadiumSDK.reader.getPaginationInfo().openPages));var e=ReadiumSDK.reader.getFirstVisibleCfi(),t=ReadiumSDK.reader.getDomRangeFromRangeCfi(e);console.log(e,t,te(t));var n=ReadiumSDK.reader.getLastVisibleCfi(),i=ReadiumSDK.reader.getDomRangeFromRangeCfi(n);console.log(n,i,te(i))},visibleTextRangeOffsetsRunsAvg:function(){var e=window.top._DEBUG_visibleTextRangeOffsetsRuns;return e.reduce(function(e,t){return e+t})/e.length}},this.findFirstVisibleElement=function(t,n){var i=this.getBodyElement();if(!i)return null;for(var r,o,a=0,s=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(i){return i.nodeType===Node.ELEMENT_NODE&&J(i)?NodeFilter.FILTER_REJECT:(i.nodeType!==Node.TEXT_NODE||Y(i))&&b(e(i),!0,t,n)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},!1);s.nextNode();){var l=s.currentNode;if(l.nodeType===Node.TEXT_NODE){r=l.parentNode,o=l,a=100;break}for(var u=!1,c=!1,f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.ELEMENT_NODE){u=!0;break}d.nodeType===Node.TEXT_NODE&&(c=!0)}if(!u&&c)for(var f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.TEXT_NODE&&Y(d)){var h=b(e(d),!0,t,n);if(h){r=l,o=d,a=h;break}}}else if(!u){r=l,a=100,o=null;break}}return r?{element:r,textNode:o,percentVisible:a}:null},this.findLastVisibleElement=function(t,n){var i=this.getBodyElement();if(!i)return null;for(var r,o,a=0,s=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,function(i){return i.nodeType===Node.ELEMENT_NODE&&J(i)?NodeFilter.FILTER_REJECT:(i.nodeType!==Node.TEXT_NODE||Y(i))&&b(e(i),!0,t,n)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},!1);s.lastChild(););do{var l=s.currentNode;if(l.nodeType===Node.TEXT_NODE){r=l.parentNode,o=l,a=100;break}for(var u=!1,c=!1,f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.ELEMENT_NODE){u=!0;break}d.nodeType===Node.TEXT_NODE&&(c=!0)}if(!u&&c)for(var f=l.childNodes.length-1;f>=0;f--){var d=l.childNodes[f];if(d.nodeType===Node.TEXT_NODE&&Y(d)){var h=b(e(d),!0,t,n);if(h){r=l,o=d,a=h;break}}}else if(!u){r=l,a=100,o=null;break}}while(s.previousNode());return r?{element:r,textNode:o,percentVisible:a}:null}}}),define("readium_shared_js/models/viewer_settings",[],function(){return function(e){function t(e){for(var t=[],n=e.split(/[\s,;]+/),i=0;i<n.length;i++){var r=n[i].trim();""!==r&&t.push(r)}return t}function n(e,t,n){void 0!==t[e]&&(i[e]=n?n(t[e]):t[e])}var i=this;this.syntheticSpread="auto",this.fontSelection=0,this.fontSize=100,this.columnGap=20,this.columnMaxWidth=700,this.columnMinWidth=400,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!1,this.pageTransition=-1,this.scroll="auto",this.update=function(e){n("columnGap",e),n("columnMaxWidth",e),n("columnMinWidth",e),n("fontSize",e),n("fontSelection",e),n("mediaOverlaysPreservePlaybackWhenScroll",e),n("mediaOverlaysSkipSkippables",e),n("mediaOverlaysEscapeEscapables",e),n("mediaOverlaysSkippables",e,t),n("mediaOverlaysEscapables",e,t),n("mediaOverlaysEnableClick",e),n("mediaOverlaysRate",e),n("mediaOverlaysVolume",e),n("mediaOverlaysSynchronizationGranularity",e),n("mediaOverlaysAutomaticPageTurn",e),n("scroll",e),n("syntheticSpread",e),n("pageTransition",e),n("enableGPUHardwareAccelerationCSS3D",e)},this.update(e)}}),function(e,t){"function"==typeof define&&define.amd?define("ResizeSensor",t):"object"==typeof exports?module.exports=t():e.ResizeSensor=t()}("undefined"!=typeof window?window:this,function(){function e(e,t){var n=Object.prototype.toString.call(e),i="[object Array]"===n||"[object NodeList]"===n||"[object HTMLCollection]"===n||"[object Object]"===n||"undefined"!=typeof jQuery&&e instanceof jQuery||"undefined"!=typeof Elements&&e instanceof Elements,r=0,o=e.length;if(i)for(;r<o;r++)t(e[r]);else t(e)}function t(e){if(!e.getBoundingClientRect)return{width:e.offsetWidth,height:e.offsetHeight};var t=e.getBoundingClientRect();return{width:Math.round(t.width),height:Math.round(t.height)}}if("undefined"==typeof window)return null;var n=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return window.setTimeout(e,20)},i=function(r,o){function a(){var e=[];this.add=function(t){e.push(t)};var t,n;this.call=function(i){for(t=0,n=e.length;t<n;t++)e[t].call(this,i)},this.remove=function(i){var r=[];for(t=0,n=e.length;t<n;t++)e[t]!==i&&r.push(e[t]);e=r},this.length=function(){return e.length}}function s(e,i){if(e){if(e.resizedAttached)return void e.resizedAttached.add(i);e.resizedAttached=new a,e.resizedAttached.add(i),e.resizeSensor=document.createElement("div"),e.resizeSensor.dir="ltr",e.resizeSensor.className="resize-sensor";var r="position: absolute; left: -10px; top: -10px; right: 0; bottom: 0; overflow: hidden; z-index: -1; visibility: hidden; max-width: 100%",o="position: absolute; left: 0; top: 0; transition: 0s;";e.resizeSensor.style.cssText=r,e.resizeSensor.innerHTML='<div class="resize-sensor-expand" style="'+r+'"><div style="'+o+'" class="resize-sensor-inner"></div></div><div class="resize-sensor-shrink" style="'+r+'"><div style="'+o+' width: 200%; height: 200%" class="resize-sensor-inner"></div></div>',e.appendChild(e.resizeSensor);var s=window.getComputedStyle(e),l=s?s.getPropertyValue("position"):null;"absolute"!==l&&"relative"!==l&&"fixed"!==l&&(e.style.position="relative");var u,c,f,d=e.resizeSensor.childNodes[0],h=d.childNodes[0],p=e.resizeSensor.childNodes[1],g=t(e),m=g.width,v=g.height,y=!0,E=function(){h.style.width="100000px",h.style.height="100000px",d.scrollLeft=1e5,d.scrollTop=1e5,p.scrollLeft=1e5,p.scrollTop=1e5},b=function(){if(y){if(!d.scrollTop&&!d.scrollLeft)return E(),void(f||(f=n(function(){f=0,b()})));y=!1}E()};e.resizeSensor.resetSensor=b;var I=function(){c=0,u&&(m=g.width,v=g.height,e.resizedAttached&&e.resizedAttached.call(g))},T=function(){g=t(e),u=g.width!==m||g.height!==v,u&&!c&&(c=n(I)),b()},w=function(e,t,n){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n)};w(d,"scroll",T),w(p,"scroll",T),n(b)}}var l;"undefined"!=typeof ResizeObserver?(l=new ResizeObserver(function(t){e(t,function(e){o.call(this,{width:e.contentRect.width,height:e.contentRect.height})})}),void 0!==r&&e(r,function(e){l.observe(e)})):e(r,function(e){s(e,o)}),this.detach=function(t){"undefined"!=typeof ResizeObserver?e(r,function(e){l.unobserve(e)}):i.detach(r,t)},this.reset=function(){r.resizeSensor.resetSensor()}};return i.reset=function(t,n){e(t,function(e){e.resizeSensor.resetSensor()})},i.detach=function(t,n){e(t,function(e){e&&(e.resizedAttached&&"function"==typeof n&&(e.resizedAttached.remove(n),e.resizedAttached.length())||e.resizeSensor&&(e.contains(e.resizeSensor)&&e.removeChild(e.resizeSensor),delete e.resizeSensor,delete e.resizedAttached))})},i}),define("readium_shared_js/views/one_page_view",["../globals","jquery","underscore","eventEmitter","./cfi_navigation_logic","../helpers","../models/viewer_settings","../models/bookmark_data","ResizeSensor"],function(e,t,n,i,r,o,a,s,l){var u=function(c,f,d,h){function p(e){if(e){F=!0;var n=C[0].contentDocument;_=t("html",n),_&&0!=_.length?(S=t("body",_),V||S.css("margin","0")):(_=t("svg",n),S=void 0),V&&R.applyBookStyles(),y(),g(),k.onIFrameLoad()}}function g(){if(S&&V){var n=S[0];if(n.resizeSensor)return;L.width=t(n).width(),L.height=t(n).height(),n.resizeSensor=new l(n,function(){var i={width:t(n).width(),height:t(n).height()};if(console.debug("OnePageView content resized ...",i.width,i.height,P.idref),i.width!=L.width||i.height!=L.height){L.width=i.width,L.height=i.height,console.debug("... updating pagination.");var r=D.package.resolveRelativeUrl(P.href);e.logEvent("OnePageView.Events.CONTENT_SIZE_CHANGED","EMIT","one_page_view.js [ "+P.href+" -- "+r+" ]"),
R.emit(u.Events.CONTENT_SIZE_CHANGED,C,P)}else console.debug("... ignored (identical dimensions).")})}}function m(){if(V&&_&&B){var e=B.fontSelection,t=!h.fonts||!h.fonts.length||e<=0||e-1>=h.fonts.length,n=t?{}:h.fonts[e-1];o.UpdateHtmlFontAttributes(_,B.fontSize,n,function(){})}}function v(){if(!C||!C.length)return 0;if(o.isIframeAlive(C[0])){var e=C[0].contentWindow,t=C[0].contentDocument;return Math.round(parseFloat(e.getComputedStyle(t.documentElement).height))}if(_){console.error("getContentDocHeight ??");return _.height()}return 0}function y(){if(U.width=0,U.height=0,!V){var e=void 0,n=void 0,i=void 0,r=C[0].contentDocument,o=t("meta[name=viewport]",r).attr("content");if(o||(o=t("meta[name=viewbox]",r).attr("content")),o&&(e=b(o)),!e&&r&&r.documentElement&&r.documentElement.nodeName&&"svg"==r.documentElement.nodeName.toLowerCase()){var a=void 0,s=void 0,l=r.documentElement.getAttribute("width"),u=l&&l.length>=1&&"%"==l[l.length-1];if(l)try{a=parseInt(l,10)}catch(e){}a&&u&&(n=a,a=void 0);var c=r.documentElement.getAttribute("height"),f=c&&c.length>=1&&"%"==c[c.length-1];if(c)try{s=parseInt(c,10)}catch(e){}s&&f&&(i=s,s=void 0),a&&s&&(e={width:a,height:s})}if(!e&&P&&(o=P.getRenditionViewport())&&(e=b(o))&&console.log("Viewport: using rendition:viewport dimensions"),!e){var d=t(r).find("img");if(d.length>0){e={width:d.width(),height:d.height()};P&&P.media_type&&P.media_type.length&&0==P.media_type.indexOf("image/")||console.warn("Viewport: using img dimensions!")}else if(d=t(r).find("image"),d.length>0){var a=void 0,s=void 0,l=d[0].getAttribute("width");if(l)try{a=parseInt(l,10)}catch(e){}var c=d[0].getAttribute("height");if(c)try{s=parseInt(c,10)}catch(e){}a&&s&&(e={width:a,height:s},!0,console.warn("Viewport: using image dimensions!"))}}if(!e){a=M.width(),s=M.height();t("iframe.iframe-fixed",M).length>1&&(a*=.5),n&&(a*=n/100),i&&(s*=i/100),e={width:a,height:s},!0,console.warn("Viewport: using browser / e-reader viewport dimensions!")}e&&(U.width=e.width,U.height=e.height)}}function E(t){t&&(e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","one_page_view.js [ "+t.href+" ]"),R.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,C,t))}function b(e){for(var t=e.replace(/\s/g,"").split(","),n={},i=0;i<t.length;i++){var r=t[i].split("=");2==r.length&&(n[r[0]]=r[1])}var o=Number.NaN,a=Number.NaN;if(n.width&&(o=parseInt(n.width)),n.height&&(a=parseInt(n.height)),!isNaN(o)&&!isNaN(a))return{width:o,height:a}}function I(){return{top:-O.parent().scrollTop(),left:0}}function T(){if(h.needsFixedLayoutScalerWorkAround()){var e=O.parent()[0];return{width:e.clientWidth,height:e.clientHeight}}return{width:U.width,height:U.height}}function w(e){return P?new s(P.idref,e):null}t.extend(this,new i);var _,S,O,C,P,N,R=this,D=c.spine,x=c.iframeLoader,A=c.bookStyles,M=c.$viewport,F=!1,L={width:void 0,height:void 0},j=function(e){var t=function(e,t){this.begin=e,this.end=t},n=new t(function(e,t,n,i,r,o,a){i.css("opacity","0")},function(e,t,n,i,r,a,s){i.css("transform","none"),o.CSSTransition(i,"opacity 150ms ease-out"),i.css("opacity","1")}),i=new t(function(e,t,n,i,r,a,s){i.css("opacity","0");var l=Math.ceil(r*e),u=.8*l*(2===s?1:-1),c=o.CSSTransformString({left:Math.round(u),origin:"50% 50% 0",enable3D:d});i.css(c)},function(e,t,n,i,r,a,s){i.css("opacity","1"),o.CSSTransition(i,"transform 150ms ease-out"),i.css("transform","none")}),r=new t(function(e,t,n,i,r,a,s){i.css("opacity","0");var l=Math.ceil(r*e),u=1.7*l*(2===s?1:-1),c=o.CSSTransformString({left:Math.round(u),angle:30*(2===s?-1:1),origin:"50% 50% 0",enable3D:d});i.css(c)},function(e,t,n,i,r,a,s){i.css("opacity","1"),o.CSSTransition(i,"transform 300ms ease-in-out"),i.css("transform","none")}),s=new t(function(e,t,n,i,r,a,s){i.css("opacity","0");for(var l=!1,u=!1,c=0;c<f.length;c++){var h=f[c].toLowerCase();if(h.indexOf("left")>=0){l=!0;break}if(h.indexOf("right")>=0){!0;break}if(h.indexOf("center")>=0){u=!0;break}}var p=Math.ceil(r*e),g=.5*p*(l||u&&1===s?1:-1),m=o.CSSTransformString({scale:.2,left:Math.round(g),angle:30*(l||u&&1===s?1:-1),origin:"50% 50% 0",enable3D:d});i.css(m)},function(e,t,n,i,r,a,s){i.css("opacity","1"),o.CSSTransition(i,"transform 400ms ease-out"),i.css("transform","none")}),l=[];l.push(n),l.push(i),l.push(r),l.push(s);var u=e.disablePageTransitions||!1;u=!0;var c=-1,d=new a({}).enableGPUHardwareAccelerationCSS3D,h=void 0;this.updateOptions=function(e){h=e;var t=h;t&&void 0!==t.enableGPUHardwareAccelerationCSS3D||(t=new a({})),t.enableGPUHardwareAccelerationCSS3D&&(d=!0),null!==e.pageTransition&&void 0!==e.pageTransition&&(c=e.pageTransition)},this.updateOptions(e);var p=0,g=!1,m=!1;this.updatePageSwitchDir=function(e,t){m||(p=e,g=t)},this.onIFrameLoad=function(){m=!0},this.transformContentImmediate_BEGIN=function(e,t,n,i){var r=g||m;if(m=!1,!u&&-1!==c&&(o.CSSTransition(e,"all 0 ease 0"),r)){var a=c>=0&&c<l.length?l[c]:void 0;0!==p&&a?a.begin(t,n,i,e,R.meta_width(),R.meta_height(),p):e.css("opacity","0")}},this.transformContentImmediate_END=function(e,t,n,i){if(u||-1===c)return void e.css("transform","none");setTimeout(function(){var r=c>=0&&c<l.length?l[c]:void 0;0!==p&&r?r.end(t,n,i,e,R.meta_width(),R.meta_height(),p):(e.css("transform","none"),o.CSSTransition(e,"opacity 250ms linear"),e.css("opacity","1"))},10)}},k=new j(c),V=d||!1,U={width:0,height:0};this.element=function(){return O},this.meta_height=function(){return U.height},this.meta_width=function(){return U.width},this.isDisplaying=function(){return F},this.render=function(){var e=o.loadTemplate("single_page_frame",{});O=t(e),N=t("#scaler",O),o.CSSTransition(O,"all 0 ease 0"),O.css("transform","none");var n=h.viewerSettings();n&&void 0!==n.enableGPUHardwareAccelerationCSS3D||(n=new a({})),n.enableGPUHardwareAccelerationCSS3D&&O.css("transform","translateZ(0)"),O.css("height","100%"),O.css("width","100%");for(var i=0,r=f.length;i<r;i++)O.addClass(f[i]);return C=t("iframe",O),this},this.decorateIframe=function(){C&&C.length&&(C.css("border-bottom","1px dashed silver"),C.css("border-top","1px dashed silver"))},this.remove=function(){this.clear(),P=void 0,O&&O[0]&&O.remove(),O=void 0,N=void 0,C=void 0},this.clear=function(){F=!1,C&&C[0]&&(C[0].src="")},this.currentSpineItem=function(){return P};var B=void 0;this.setViewSettings=function(e,t){B=e,V&&!t&&R.applyBookStyles(),y(),k.updateOptions(e)},this.applyBookStyles=function(){V&&_&&(o.setStyles(A.getStyles(),_),m())},this.scaleToWidth=function(e){if(!(V||U.width<=0)){var t=e/U.width;R.transformContentImmediate(t,0,0)}},this.resizeIFrameToContent=function(){var e=v();R.setHeight(e),R.showIFrame()},this.setHeight=function(e){N.css("height",e+"px"),O.css("height",e+"px")};this.showIFrame=function(){C.css("visibility","visible"),C.css("transform","none");var e=B;e&&void 0!==e.enableGPUHardwareAccelerationCSS3D||(e=new a({})),e.enableGPUHardwareAccelerationCSS3D&&(!0,C.css("transform","translateZ(0)"))},this.hideIFrame=function(){C.css("visibility","hidden");var e=!1,t=B;t&&void 0!==t.enableGPUHardwareAccelerationCSS3D||(t=new a({})),t.enableGPUHardwareAccelerationCSS3D&&(e=!0);var n=o.CSSTransformString({left:"10000",top:"10000",enable3D:e});C.css(n)},this.updatePageSwitchDir=function(e,t){k.updatePageSwitchDir(e,t)},this.transformContentImmediate=function(e,t,n){if(!V){var i=Math.ceil(U.width*e),r=Math.floor(U.height*e);if(k.transformContentImmediate_BEGIN(O,e,t,n),O.css("left",t+"px"),O.css("top",n+"px"),O.css("width",i+"px"),O.css("height",r+"px"),_){var s=!1,l=B;if(l&&void 0!==l.enableGPUHardwareAccelerationCSS3D||(l=new a({})),l.enableGPUHardwareAccelerationCSS3D&&(s=!0),S&&h.needsFixedLayoutScalerWorkAround()){var u=o.CSSTransformString({scale:e,enable3D:s});u["min-width"]=U.width,u["min-height"]=U.height,_.css(u),S&&S.length&&S.css({width:U.width,height:U.height});var c=o.CSSTransformString({scale:1,enable3D:s});c.width=U.width*e,c.height=U.height*e,N.css(c)}else{var f=o.CSSTransformString({scale:e,enable3D:s});f.width=U.width,f.height=U.height,N.css(f)}_.css("opacity","0.999"),R.showIFrame(),setTimeout(function(){_.css("opacity","1")},0),k.transformContentImmediate_END(O,e,t,n)}}},this.getCalculatedPageHeight=function(){return O.height()},this.transformContent=n.bind(n.debounce(this.transformContentImmediate,50),R),this.onUnload=function(){E(P)},this.loadSpineItem=function(t,n,i){if(P!=t){var r=P;P=t;var a=D.package.resolveRelativeUrl(t.href);R.hideIFrame(),E(r),e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","EMIT","one_page_view.js [ "+t.href+" -- "+a+" ]"),R.emit(u.Events.SPINE_ITEM_OPEN_START,C,P),x.loadIframe(C[0],a,function(e){if(e&&n){var r=function(){n(e,C,P,!0,i)};o.isIframeAlive(C[0])?(p(e),r()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(t.href),p(e),setTimeout(r,500))}else p(e)},R,{spineItem:P})}else n&&n(!0,C,P,!1,i)},this.getNavigator=function(){return new r({$iframe:C,frameDimensionsGetter:T,visibleContentOffsetsGetter:I,classBlacklist:["cfi-marker","mo-cfi-highlight","resize-sensor","resize-sensor-expand","resize-sensor-shrink","resize-sensor-inner","js-hypothesis-config","js-hypothesis-embed"],elementBlacklist:["hypothesis-adder"],idBlacklist:["MathJax_Message","MathJax_SVG_Hidden"]})},this.getElementByCfi=function(e,t,n,i,r){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElementByCfi(t,n,i,r)},this.getElementById=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElementById(t)},this.getElement=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){return R.getNavigator().getFirstVisibleMediaOverlayElement()},this.offset=function(){if(C)return C.offset()},this.getVisibleElementsWithFilter=function(e){return R.getNavigator().getVisibleElementsWithFilter(null,e)},this.getVisibleElements=function(e){return R.getNavigator().getAllVisibleElementsWithSelector(e)},this.getAllElementsWithFilter=function(e,t){return R.getNavigator().getAllElementsWithFilter(e,t)},this.getElements=function(e,t){return e!=P.idref?void console.error("spine item is not loaded"):R.getNavigator().getElements(t)},this.getNodeRangeInfoFromCfi=function(e,t){return e!=P.idref?void console.warn("spine item is not loaded"):R.getNavigator().getNodeRangeInfoFromCfi(t)},this.getLoadedContentFrames=function(){return[{spineItem:P,$iframe:C}]},this.getFirstVisibleCfi=function(e,t){return w(R.getNavigator().getFirstVisibleCfi(e,t))},this.getLastVisibleCfi=function(e,t){return w(R.getNavigator().getLastVisibleCfi(e,t))},this.getDomRangeFromRangeCfi=function(e,t,n){return R.getNavigator().getDomRangeFromRangeCfi(e,t,n)},this.getRangeCfiFromDomRange=function(e){return w(R.getNavigator().getRangeCfiFromDomRange(e))},this.getVisibleCfiFromPoint=function(e,t,n){return w(R.getNavigator().getVisibleCfiFromPoint(e,t,n))},this.getRangeCfiFromPoints=function(e,t,n,i){return w(R.getNavigator().getRangeCfiFromPoints(e,t,n,i))},this.getCfiForElement=function(e){return w(R.getNavigator().getCfiForElement(e))},this.getElementFromPoint=function(e,t){return R.getNavigator().getElementFromPoint(e,t)},this.getStartCfi=function(){return w(R.getNavigator().getStartCfi())},this.getEndCfi=function(){return w(R.getNavigator().getEndCfi())},this.getNearestCfiFromElement=function(e){return w(R.getNavigator().getNearestCfiFromElement(e))}};return u.Events={SPINE_ITEM_OPEN_START:"SpineItemOpenStart",CONTENT_SIZE_CHANGED:"ContentSizeChanged"},u}),define("readium_shared_js/models/page_open_request",[],function(){return function(e,t){this.spineItem=e,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstVisibleCfi=void 0,this.lastVisibleCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=t,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(e){this.reset(),this.spineItemPageIndex=e},this.setElementId=function(e){this.reset(),this.elementId=e},this.setElementCfi=function(e){this.reset(),this.elementCfi=e},this.setFirstAndLastVisibleCfi=function(e,t){this.reset(),this.firstVisibleCfi=e,this.lastVisibleCfi=t}}}),define("readium_shared_js/views/fixed_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../models/fixed_page_spread","./one_page_view","../models/page_open_request","../helpers"],function(e,t,n,i,r,o,a,s,l,u){return function(n,c){function f(t){var i=new s(n,[t],!1,c);return i.on(s.Events.SPINE_ITEM_OPEN_START,function(t,n){e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","ON","fixed_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","fixed_view.js [ "+n.href+" ]"),C.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),i.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","ON","fixed_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","fixed_view.js [ "+n.href+" ]"),C.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)}),i}function d(){return V.validItems()[0]}function h(e,n){if(U)return void(B={initiator:e,paginationRequest:n});U=!0;var i={isElementAdded:!1},r=p([{pageView:A,spineItem:V.leftItem,context:i},{pageView:M,spineItem:V.rightItem,context:i},{pageView:F,spineItem:V.centerItem,context:i}]);t.when.apply(t,r).done(function(){if(U=!1,B){var t=B.initiator,r=B.paginationRequest;B=void 0,h(t,r)}else i.isElementAdded&&(u.setStyles(R.getStyles(),S.parent()),I()),n?g(e,n.spineItem,n.elementId):g(e)})}function p(e){for(var t=[],n=0;n<e.length;n++){var i=T(e[n].pageView,e[n].spineItem,e[n].context);t.push(i)}return t}function g(t,n,i){b(),y(),window.setTimeout(function(){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","fixed_view.js"),C.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:C.getPaginationInfo(),initiator:t,spineItem:n,elementId:i})},60)}function m(e,t){var n=new a(N,t);return n.openItem(e),V.leftItem!=n.leftItem||V.rightItem!=n.rightItem||V.centerItem!=n.centerItem}function v(){if(!k||!j)return!1;var e=P.width(),t=P.height();return e&&t}function y(t){if(G(0,!1),v()){var n=P.width(),i=P.height(),r=A.isDisplaying()?u.Margins.fromElement(A.element()):u.Margins.empty(),o=M.isDisplaying()?u.Margins.fromElement(M.element()):u.Margins.empty(),a=F.isDisplaying()?u.Margins.fromElement(F.element()):u.Margins.empty(),s=E(r,o,a),l={width:n-j.width(),height:i-j.height()},c={width:l.width-s.width(),height:l.height-s.height()};if(!(l.width<=0||l.height<=0)){var f=c.width/k.width,d=c.height/k.height;P.css("overflow","auto");var h;"fit-width"==D.style?h=f:"fit-height"==D.style?h=d:"user"==D.style?h=D.scale:(h=Math.min(f,d),P.css("overflow","hidden")),O=h;var p={width:k.width*h,height:k.height*h},g={width:p.width+s.width(),height:p.height+s.height()},m={width:g.width+j.width(),height:g.height+j.height()},y=Math.floor((n-m.width)/2),b=Math.floor((i-m.height)/2);y<0&&(y=0),b<0&&(b=0),S.css("left",y+"px"),S.css("top",b+"px"),S.css("width",g.width+"px"),S.css("height",g.height+"px");var I=j.padding.left,T=j.padding.top,w=t?"transformContentImmediate":"transformContent";A.isDisplaying()&&A[w](h,I,T),M.isDisplaying()&&(I+=k.separatorPosition*h,A.isDisplaying()&&(I+=r.left),M[w](h,I,T)),F.isDisplaying()&&F[w](h,I,T),e.logEvent("FXL_VIEW_RESIZED","EMIT","fixed_view.js"),C.emit(e.Events.FXL_VIEW_RESIZED)}}}function E(e,t,n){var i={left:Math.max(e.margin.left,t.margin.left,n.margin.left),right:Math.max(e.margin.right,t.margin.right,n.margin.right),top:Math.max(e.margin.top,t.margin.top,n.margin.top),bottom:Math.max(e.margin.bottom,t.margin.bottom,n.margin.bottom)},r={left:Math.max(e.border.left,t.border.left,n.border.left),right:Math.max(e.border.right,t.border.right,n.border.right),top:Math.max(e.border.top,t.border.top,n.border.top),bottom:Math.max(e.border.bottom,t.border.bottom,n.border.bottom)},o={left:Math.max(e.padding.left,t.padding.left,n.padding.left),right:Math.max(e.padding.right,t.padding.right,n.padding.right),top:Math.max(e.padding.top,t.padding.top,n.padding.top),bottom:Math.max(e.padding.bottom,t.padding.bottom,n.padding.bottom)};return new u.Margins(i,r,o)}function b(){k={},F.isDisplaying()?(k.width=F.meta_width(),k.height=F.meta_height(),k.separatorPosition=0):A.isDisplaying()&&M.isDisplaying()?A.meta_height()==M.meta_height()?(k.width=A.meta_width()+M.meta_width(),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):(k.width=A.meta_width()+M.meta_width()*(A.meta_height()/M.meta_height()),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):A.isDisplaying()?(k.width=2*A.meta_width(),k.height=A.meta_height(),k.separatorPosition=A.meta_width()):M.isDisplaying()?(k.width=2*M.meta_width(),k.height=M.meta_height(),k.separatorPosition=M.meta_width()):k=void 0}function I(){j=u.Margins.fromElement(S)}function T(n,i,r){var o=t.Deferred();return i?(n.remove(),S.append(n.render().element()),r.isElementAdded=!0,n.loadSpineItem(i,function(t,i,r,a,s){t&&a&&(n.meta_height()&&n.meta_width()||console.error("Invalid document "+r.href+": viewport is not specified!"),e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","fixed_view.js [ "+r.href+" ]"),C.emit(e.Events.CONTENT_DOCUMENT_LOADED,i,r)),o.resolve()},r)):(n.isDisplaying()&&n.remove(),o.resolve()),o.promise()}function w(){var e=[];e=N.isLeftToRight()?[A,F,M]:[M,F,A];for(var t=[],n=0,i=e.length;n<i;n++)e[n].isDisplaying()&&t.push(e[n]);return t}function _(e,t){for(var n=w(),i=0,r=n.length;i<r;i++){var o=n[i];if(o.currentSpineItem().idref==e)return t(o)}console.error("spine item is not loaded")}t.extend(this,new i);var S,O,C=this,P=t(n.$viewport),N=n.spine,R=n.userStyles,D=(n.bookStyles,n.zoom||{style:"default"}),x=(n.iframeLoader,void 0),A=f("fixed-page-frame-left"),M=f("fixed-page-frame-right"),F=f("fixed-page-frame-center"),L=[];L.push(A),L.push(M),L.push(F);var j,k,V=new a(N,!1),U=!1,B=!1;this.isReflowable=function(){return!1},this.setZoom=function(e){D=e,y(!1)},this.render=function(){var e=u.loadTemplate("fixed_book_frame",{});return S=t(e),u.CSSTransition(S,"all 0 ease 0"),S.css("overflow","hidden"),P.append(S),C.applyStyles(),this},this.remove=function(){S.remove()},this.setViewSettings=function(e,t){x=e,V.setSyntheticSpread(1==u.deduceSyntheticSpread(P,d(),x));for(var n=w(),i=0,r=n.length;i<r;i++)n[i].setViewSettings(e,t)};var G=function(e,t){A&&A.updatePageSwitchDir(e,t),M&&M.updatePageSwitchDir(e,t),F&&F.updatePageSwitchDir(e,t)};this.applyStyles=function(){u.setStyles(R.getStyles(),S.parent()),I(),b(),y()},this.applyBookStyles=function(){for(var e=w(),t=0,n=e.length;t<n;t++)e[t].applyBookStyles()},this.onViewportResize=function(){var e=d();if(e){var t=1==u.deduceSyntheticSpread(P,e,x);if(m(e,t)){V.setSyntheticSpread(t);var n=new l(e,C);C.openPage(n)}else y(!0)}},this.getViewScale=function(){return O},this.openPage=function(e,t){if(e.spineItem){var n=V.leftItem,i=V.rightItem,r=V.centerItem,o=1==u.deduceSyntheticSpread(P,e.spineItem,x);V.setSyntheticSpread(o),V.openItem(e.spineItem);var a=n!==V.leftItem||i!==V.rightItem||r!==V.centerItem;null!==t&&void 0!==t||(t=0),G(0===t?0:V.spine.isRightToLeft()?1===t?2:1:t,a),h(e.initiator,e)}},this.openPagePrev=function(e){V.openPrev(),G(V.spine.isRightToLeft()?2:1,!0),h(e,void 0)},this.openPageNext=function(e){V.openNext(),G(V.spine.isRightToLeft()?1:2,!0),h(e,void 0)},this.getPaginationInfo=function(){for(var e=new o(N,!0),t=[V.leftItem,V.rightItem,V.centerItem],n=0;n<t.length;n++){var i=t[n];i&&e.addOpenPage(0,1,i.idref,i.index)}return e},this.bookmarkCurrentPage=function(){var e=w(),t=this.getLoadedSpineItems();return e.length>0?e[0].getFirstVisibleCfi():t.length>0?new r(this.getLoadedSpineItems()[0].idref,null):void 0},this.getLoadedSpineItems=function(){return V.validItems()},this.getElement=function(e,t){return _(e,function(n){return n.getElement(e,t)})},this.getElementById=function(e,t){return _(e,function(n){return n.getElementById(e,t)})},this.getElementByCfi=function(e,t,n,i,r){return _(e,function(o){return o.getElementByCfi(e,t,n,i,r)})},this.getFirstVisibleMediaOverlayElement=function(){for(var e=w(),t=0,n=e.length;t<n;t++){var i=e[t].getFirstVisibleMediaOverlayElement();if(i)return i}},this.insureElementVisibility=function(e,t,n){},this.getElements=function(e,t){return _(e,function(n){return n.getElements(e,t)})},this.isElementVisible=function(e){return!0},this.getVisibleElementsWithFilter=function(e,t){for(var n=[],i=w(),r=0,o=i.length;r<o;r++)n.push(i[r].getAllElementsWithFilter(e,t));return n},this.getVisibleElements=function(e,t){for(var n=[],i=w(),r=0,o=i.length;r<o;r++)t?n.push({elements:i[r].getElements(i[r].currentSpineItem().idref,e),spineItem:i[r].currentSpineItem()}):n.push(i[r].getElements(i[r].currentSpineItem().idref,e));return n},this.isElementVisible=function(e){return!0},this.isVisibleSpineItemElementCfi=function(e,t){return _(e,function(e){return!0})},this.getNodeRangeInfoFromCfi=function(e,t){return _(e,function(n){return n.getNodeRangeInfoFromCfi(e,t)})},this.getFirstVisibleCfi=function(){var e=w();if(e.length>0)return e[0].getFirstVisibleCfi()},this.getLastVisibleCfi=function(){var e=w();if(e.length>0)return e[e.length-1].getLastVisibleCfi()},this.getDomRangesFromRangeCfi=function(e,t,n){var i=w();if(t&&e.idref!==t.idref){for(var r=[],o=0,a=i.length;o<a;o++){var s=i[o];if(s.currentSpineItem().idref===e.idref){var l=s.getLastVisibleCfi();r.push(s.getDomRangeFromRangeCfi(e.contentCFI,l.contentCFI,n))}else if(s.currentSpineItem().idref===t.idref){var u=s.getFirstVisibleCfi();r.push(s.getDomRangeFromRangeCfi(u.contentCFI,t.contentCFI,n))}}return r}return[this.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangeFromRangeCfi=function(e,t,n){var i=w();if(t&&e.idref!==t.idref)return void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref");for(var r=0,o=i.length;r<o;r++){var a=i[r];if(a.currentSpineItem().idref===e.idref)return a.getDomRangeFromRangeCfi(e.contentCFI,t?t.contentCFI:null,n)}},this.getRangeCfiFromDomRange=function(e){for(var t=w(),n=0,i=t.length;n<i;n++){var r=t[n];if(r.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.startContainer.ownerDocument)return r.getRangeCfiFromDomRange(e)}},this.getVisibleCfiFromPoint=function(e,t,n,i){if(!i)throw new Error("getVisibleCfiFromPoint: Spine item idref must be specified for this fixed layout view.");return _(i,function(i){return i.getVisibleCfiFromPoint(e,t,n)})},this.getRangeCfiFromPoints=function(e,t,n,i,r){if(!r)throw new Error("getRangeCfiFromPoints: Spine item idref must be specified for this fixed layout view.");return _(r,function(r){return r.getRangeCfiFromPoints(e,t,n,i)})},this.getCfiForElement=function(e){for(var t=w(),n=0,i=t.length;n<i;n++){var r=t[n];if(r.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.ownerDocument)return r.getCfiForElement(e)}},this.getElementFromPoint=function(e,t,n){if(!n)throw new Error("getElementFromPoint: Spine item idref must be specified for this fixed layout view.");return _(n,function(n){return n.getElementFromPoint(e,t)})},this.getStartCfi=function(){return w()[0].getStartCfi()},this.getEndCfi=function(){return w()[0].getEndCfi()},this.getNearestCfiFromElement=function(e){for(var t=w(),n=0,i=t.length;n<i;n++){var r=t[n];if(r.getLoadedContentFrames()[0].$iframe[0].contentDocument===e.ownerDocument)return r.getNearestCfiFromElement(e)}}}}),define("readium_shared_js/views/iframe_loader",["jquery","underscore","URIjs"],function(e,t,n){return function(){var i=this,r={};this.addIFrameEventListener=function(e,t,n){void 0==r[e]&&(r[e]=[]),r[e].push({callback:t,context:n})},this.updateIframeEvents=function(n){t.each(r,function(t,i){e(n.contentWindow).off(i);for(var r=0,o=t.length;r<o;r++)e(n.contentWindow).on(i,t[r].callback,t[r].context)})},this.loadIframe=function(e,t,r,o,a){e.baseURI||("undefined"!=typeof location&&(e.baseURI=location.href+""),console.error("!iframe.baseURI => "+e.baseURI)),console.log("EPUB doc iframe src:"),console.log(t),console.log("EPUB doc iframe base URI:"),console.log(e.baseURI),e.setAttribute("data-baseUri",e.baseURI),e.setAttribute("data-src",t);var s=new n(t).absoluteTo(e.baseURI).search("").hash("").toString();i._loadIframeWithUri(e,a,s,function(){r.call(o,!0,a)})},this._loadIframeWithUri=function(n,r,o,a){n.onload=function(){var r=n.contentDocument||n.contentWindow.document;e("svg",r).on("load",function(){console.log("SVG loaded")}),i.updateIframeEvents(n);var o=n.contentWindow.MathJax;if(o){console.log("MathJax VERSION: "+o.cdnVersion+" // "+o.fileversion+" // "+o.version);var s=!0;o.Hub.Browser.isFirefox&&(s=!1),o.Hub.Browser.isChrome&&(s=!1),window.navigator.userAgent.indexOf("Edge")>0&&(s=!1),o.Hub.Config({showMathMenu:!1,messageStyle:"none",showProcessingMessages:!0,SVG:{useFontCache:s}});var l=t.once(a);try{o.Hub.Queue(l)}catch(e){console.error("MathJax fail!"),a()}}else a()},n.setAttribute("src",o)}}}),define("readium_shared_js/views/internal_links_support",["jquery","../helpers","readium_cfi_js","URIjs"],function(e,t,n,i){return function(r){function o(e){var t=e.indexOf("("),n=e.indexOf("!"),i=e.indexOf(")");if(-1!=n)return-1==i&&(i=e.length),{spineItemCfi:e.substring(t+1,n),elementCfi:e.substring(n+1,i)}}function a(e,t){var n=r.package().resolveRelativeUrl(t.href);return e.absoluteTo(n)}function s(e,i){var s=a(e,i);if(!s)return void console.error("Unable to resolve "+e.href());var u=e.fragment(),c=s.toString();c=t.RemoveFromString(c,"#"+u),l(c,function(e){if(e){var t=new window.DOMParser,i=t.parseFromString(e,"text/xml"),a=o(u);if(!a)return void console.warn("Unable to split cfi:"+u);var s=n.Interpreter.getContentDocHref("epubcfi("+a.spineItemCfi+")",i);if(s){var l=r.spine().getItemByHref(s);l?r.openSpineItemElementCfi(l.idref,a.elementCfi,f):console.warn("Unable to find spineItem with href="+s)}else console.warn("Unable to find document ref from "+u+" cfi")}})}function l(t,n){e.ajax({isLocal:0!==t.indexOf("http"),url:t,dataType:"text",async:!0,success:function(e){n(e)},error:function(e,i,r){console.error("Error when AJAX fetching "+t),console.error(i),console.error(r),n()}})}function u(e){var n=e.filename();return n&&t.EndsWith(n,".opf")}function c(e,t){var n,o=e.filename();if(o){var a=new i(e,t.href),s=decodeURIComponent(a.pathname()),l=r.spine().getItemByHref(s);if(!l)return void console.error("spine item with href="+s+" not found");n=l.idref}else n=t.idref;var u=e.fragment();r.openSpineItemElementId(n,u,f)}var f=this;this.processLinkElements=function(t,n){var r=t[0].contentDocument;e("a",r).click(function(e){var t;t=e.currentTarget.attributes["xlink:href"]?e.currentTarget.attributes["xlink:href"].value:e.currentTarget.attributes.href.value;var r=!1,o=new i(t);o.is("relative")?u(o)?(s(o,n),r=!0):(c(o,n),r=!0):(window.open(t,"_blank"),r=!0),r&&(e.preventDefault(),e.stopPropagation())})}}}),define("readium_shared_js/models/smil_iterator",["jquery","../helpers"],function(e,t){return function(n){function i(e,t,n){for(var r=e,o=t.children.length;r>=0&&r<o;r+=n?-1:1){var a=t.children[r];if("par"==a.nodeType)return a;if(a=i(n?a.children.length-1:0,a,n))return a}if(t.parent)return i(t.index+(n?-1:1),t.parent,n)}this.smil=n,this.currentPar=void 0,this.reset=function(){this.currentPar=i(0,this.smil,!1)},this.findTextId=function(n){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!n)return!1;for(;this.currentPar;){if(this.currentPar.element){if(n===this.currentPar.text.srcFragmentId)return!0;for(var i=this.currentPar.element.parentNode;i;){if(i.id&&i.id==n)return!0;i=i.parentNode}var r=e("#"+t.escapeJQuerySelector(n),this.currentPar.element);if(r&&r.length&&r[0])return!0}this.next()}return!1},this.next=function(){if(!this.currentPar)return void console.debug("Par iterator is out of range");this.currentPar=i(this.currentPar.index+1,this.currentPar.parent,!1)},this.previous=function(){if(!this.currentPar)return void console.debug("Par iterator is out of range");this.currentPar=i(this.currentPar.index-1,this.currentPar.parent,!0)},this.isLast=function(){return this.currentPar?!i(this.currentPar.index+1,this.currentPar.parent,!1):void console.debug("Par iterator is out of range")},this.goToPar=function(e){for(;this.currentPar&&this.currentPar!=e;)this.next()},this.reset()}}),define("readium_shared_js/views/media_overlay_data_injector",["jquery","underscore","../helpers","../models/smil_iterator","readium_cfi_js"],function(e,t,n,i,r){return function(o,a){this.attachMediaOverlayData=function(s,l,u){var c=s[0].contentDocument.documentElement;if(l.media_overlay_id||0!==o.smil_models.length){var f=e("body",c);if(0==f.length)console.error("! BODY ???");else{if(f.data("mediaOverlayClick"))console.error("[WARN] already mediaOverlayClick");else{f.data("mediaOverlayClick",{ping:"pong"});var d=function(t){var n=e(this)[0];if(!(n=t.target))return a.touchInit(),!0;var i=void 0,r=n,o=!1;for("a"===r.nodeName.toLowerCase()&&(o=!0);!(i=e(r).data("mediaOverlayData"))&&("a"===r.nodeName.toLowerCase()&&(o=!0),r=r.parentNode););if(i&&(i.par||i.pars)){if(!u.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),a.touchInit(),!0;if(o)return console.log("MO CLICKED LINK"),a.touchInit(),!0;var s=i.par?i.par:i.pars[0];return r&&r!=n&&"body"===r.nodeName.toLowerCase()&&s&&!s.getSmil().id?(a.touchInit(),!0):(a.playUserPar(s),!0)}var l=e(n).attr("ibooks:readaloud");if(l||(l=e(n).attr("epub:readaloud")),l){console.debug("MO readaloud attr: "+l);var c=a.isPlaying();if("start"===l&&!c||"stop"===l&&c||"startstop"===l)return a.toggleMediaOverlay(),!0}return a.touchInit(),!0},h=t.debounce(d,200);"ontouchstart"in document.documentElement&&f[0].addEventListener("touchstart",h,!1),f[0].addEventListener("mousedown",h,!1)}}var p=o.getSmilBySpineItem(l);if(!p)return void console.error("NO SMIL?? "+l.idref+" /// "+l.media_overlay_id);var g=function(e){if(e){if(e.nodeType&&"seq"===e.nodeType&&e.textref){var t=e.textref.split("#"),i=t[0],r=2===t.length?t[1]:"";if(i&&r){n.ResolveContentRef(i,p.href)===l.href&&(e.element=s[0].contentDocument.getElementById(r),e.element||console.error("seq.textref !element? "+e.textref))}}if(e.children&&e.children.length)for(var o=0;o<e.children.length;o++){var a=e.children[o];g(a)}}};g(p);for(var m=new i(p);m.currentPar;){m.currentPar.element=void 0,m.currentPar.cfi=void 0;if(n.ResolveContentRef(m.currentPar.text.srcFile,m.smil.href)===l.href){var v=!m.currentPar.text.srcFragmentId||0==m.currentPar.text.srcFragmentId.length,y=0==m.currentPar.text.srcFragmentId.indexOf("epubcfi")?void 0:m.currentPar.text.srcFragmentId,E=void 0,b=!1;if(v||y)E=v?f:e(s[0].contentDocument.getElementById(y));else if(0===m.currentPar.text.srcFragmentId.indexOf("epubcfi")){var I=m.currentPar.text.srcFragmentId.substr("epubcfi".length+1,m.currentPar.text.srcFragmentId.length-"epubcfi".length-2);0===I.indexOf("/99!")&&(I=I.substr("/99!".length,I.length-"/99!".length));var T=I.split(",");if(T&&3===T.length)try{var w=T[0]+T[1],_="epubcfi("+w+")",S=r.getTextTerminusInfoWithPartialCFI(_,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),O=T[0]+T[2],C="epubcfi("+O+")",P=(r.getTextTerminusInfoWithPartialCFI(C,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),S.textNode.parentNode);m.currentPar.cfi={smilTextSrcCfi:m.currentPar.text.srcFragmentId,partialRangeCfi:I,partialStartCfi:w,partialEndCfi:O,cfiTextParent:P},b=!0,E=e(P);var N=E.data("mediaOverlayData");if(N){N.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),N.par=void 0);var R=!1;if(N.pars)for(var D=0;D<N.pars.length;D++){var x=N.pars[D];x===m.currentPar&&(R=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else N.pars=[];R||N.pars.push(m.currentPar)}else N={pars:[m.currentPar]},E.data("mediaOverlayData",N)}catch(e){console.error(e)}else try{var A="epubcfi("+I+")"
;E=r.getTargetElementWithPartialCFI(A,s[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(e){console.error(e)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+m.currentPar.text.srcFragmentId);if(E&&E.length>0){if(!b){m.currentPar.element&&m.currentPar.element!==E[0]&&console.error("DIFFERENT ELEMENTS??! "+m.currentPar.text.srcFragmentId+" /// "+m.currentPar.element.id);var M=E[0].nodeName?E[0].nodeName.toLowerCase():void 0;"audio"!==M&&"video"!==M||E.attr("preload","auto"),m.currentPar.element=E[0];var N=E.data("mediaOverlayData");N&&(console.error("[WARN] MO DATA already exists."),N.par&&N.par!==m.currentPar&&console.error("DIFFERENT PARS??!")),E.data("mediaOverlayData",{par:m.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+m.currentPar.text.srcFragmentId+" == "+m.currentPar.text.srcFile+" /// "+l.href)}m.next()}}}}}),define("readium_shared_js/views/audio_player",["jquery"],function(e){return function(t,n,i,r,o){function a(){t({isPlaying:!0}),r()}function s(){o(),t({isPlaying:!1})}function l(){if(y.moSeeking)return void(v&&console.debug("onEnded() skipped (still seeking...)"));c(),i(),t({isPlaying:!1})}function u(){S||(S=setInterval(function(){if(y.moSeeking)return void(++_>1e3&&(_=0,c()));var e=void 0;try{e=y.currentTime}catch(e){console.error(e.message)}e&&n(e,1)},20))}function c(){S&&clearInterval(S),S=void 0}function f(e){v&&console.debug("onReadyToSeek #"+e.data.playId),h(e.data.seekBegin,e.data.playId,!0)}function d(t){e(y).off(D,d),m?(v&&console.debug("onReadyToSeek ANDROID ... waiting a bit ... #"+t.data.playId),N(),setTimeout(function(){f(t)},1e3)):f(t)}function h(t,n,i){if(v&&console.debug("playSeekCurrentTime() #"+n),0==t&&(t=.01),Math.abs(t-y.currentTime)<.3)return v&&console.debug("playSeekCurrentTime() CONTINUE"),y.moSeeking=void 0,void E.play();var r=i?A:M;v&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+r),E.pause(),e(y).on(r,{newCurrentTime:t,playId:n,isNewSrc:i},p);try{y.currentTime=t}catch(e){console.error(e.message),setTimeout(function(){try{y.currentTime=t}catch(e){console.error(e.message)}},5)}}function p(t){var n=t.data.isNewSrc?A:M,i=void 0==t.data.seekRetries;(i||t.data.seekRetries==x)&&e(y).off(n,p),v&&console.debug("onSeeked() #"+t.data.playId+" FIRST? "+i+" EV: "+n);var r=y.currentTime,o=Math.abs(t.data.newCurrentTime-r);if((i||t.data.seekRetries>=0)&&o>=1)v&&console.debug("onSeeked() time diff: "+t.data.newCurrentTime+" vs. "+r+" ("+o+")"),i&&(t.data.seekRetries=x,t.data.isNewSrc=!1),t.data.seekRetries--,v&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){p(t)},m?1e3:200),setTimeout(function(){y.pause();try{y.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message),setTimeout(function(){try{y.currentTime=t.data.newCurrentTime}catch(e){console.error(e.message)}},4)}},5);else{if(v&&(console.debug("onSeeked() STATE:"),console.debug(i),console.debug(t.data.seekRetries),console.debug(o)),o>=1){v&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var a=I,s=b,l=t.data.newCurrentTime;return E.reset(),void setTimeout(function(){E.playFile(a,s,l)},10)}v&&console.debug("onSeeked() OKAY => play!"),t.data.seekRetries=void 0,E.play(),y.moSeeking=void 0}}var g=!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g),m=navigator.userAgent.toLowerCase().indexOf("android")>-1,v=ReadiumSDK.DEBUG_MODE,y=new Audio;v&&(y.addEventListener("load",function(){console.debug("0) load")}),y.addEventListener("loadstart",function(){console.debug("1) loadstart")}),y.addEventListener("durationchange",function(){console.debug("2) durationchange")}),y.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),y.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),y.addEventListener("progress",function(){console.debug("5) progress")}),y.addEventListener("canplay",function(){console.debug("6) canplay")}),y.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),y.addEventListener("play",function(){console.debug("8) play")}),y.addEventListener("pause",function(){console.debug("9) pause")}),y.addEventListener("ended",function(){console.debug("10) ended")}),y.addEventListener("seeked",function(){console.debug("X) seeked")}),y.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")}),y.addEventListener("seeking",function(){console.debug("Z) seeking")}));var E=this,b=void 0,I=void 0;this.currentSmilSrc=function(){return I};var T=1;this.setRate=function(e){T=e,T<.5&&(T=.5),T>4&&(T=4),y.playbackRate=T},E.setRate(T),this.getRate=function(){return T};var w=1;this.setVolume=function(e){w=e,w<0&&(w=0),w>1&&(w=1),y.volume=w},E.setVolume(w),this.getVolume=function(){return w},this.play=function(){return v&&console.error("this.play()"),!!b&&(u(),E.setVolume(w),E.setRate(T),y.play(),!0)},this.pause=function(){v&&console.error("this.pause()"),c(),y.pause()},y.addEventListener("play",a,!1),y.addEventListener("pause",s,!1),y.addEventListener("ended",l,!1);var _=0,S=void 0;this.isPlaying=function(){return void 0!==S},this.reset=function(){v&&console.error("this.reset()"),this.pause(),y.moSeeking=void 0,I=void 0,b=void 0,setTimeout(function(){y.setAttribute("src","")},1)},y.addEventListener("loadstart",function(){O=!0});var O=!1;this.touchInit=function(){return!!g&&(!O&&(O=!0,y.setAttribute("src","touch/init/html5/audio.mp3"),y.load(),!0))};var C=0,P=0;this.playFile=function(t,n,i){++C>99999&&(C=0);var r=C;return y.moSeeking?++P>x?void(P=0):(v&&console.debug("this.playFile("+n+") @"+i+" (POSTPONE, SEEKING...)"),void setTimeout(function(){E.playFile(t,n,i)},20)):(y.moSeeking={},v&&console.debug("this.playFile("+n+") @"+i+" #"+r),b&&b===n?(v&&console.debug("this.playFile() SAME SRC"),this.pause(),I=t,b=n,void h(i,r,!1)):(v&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+b),console.debug("epubSrc: "+n)),this.reset(),y.moSeeking={},I=t,b=n,m||y.addEventListener("play",R,!1),e(y).on(D,{seekBegin:i,playId:r},d),void setTimeout(function(){y.setAttribute("src",b),y.load(),m||N()},1)))};var N=function(){v&&console.debug("playToForcePreload");var e=w;w=0,E.play(),w=e},R=function(){y.removeEventListener("play",R,!1),v&&console.debug("onPlayToForcePreload"),y.pause()},D=m?"canplaythrough":"canplay",x=10,A=g?"canplaythrough":"seeked",M=g?"timeupdate":"seeked"}}),define("readium_shared_js/views/media_overlay_element_highlighter",["jquery","readium_cfi_js"],function(e,t){return function(t){function n(t,n,r){if(u)try{if(u[0].ownerDocument===t[0].ownerDocument)return}catch(e){}$head=e("head",t[0].ownerDocument.documentElement),u=e("<style type='text/css'> </style>"),u.append("."+i+" {");var o="background-color: yellow !important; color: black !important; border-radius: 0.4em;",a=r;if(a){var s=!1;for(var l in a.declarations)a.declarations.hasOwnProperty(l)&&(s=!0,u.append(l+": "+a.declarations[l]+"; "));s||n||u.append(o)}else n||u.append(o);u.append("}"),u.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var i="mo-active-default",r=void 0;this.isElementHighlighted=function(e){return r&&e===r};var o=void 0;this.isCfiHighlighted=function(e){return o&&e===o};var a="",s="",l=t,u=void 0;this.reDo=function(){u&&u.remove(),u=void 0;var e=r,t=o,n=a,i=s;r?(this.reset(),this.highlightElement(e,n,i)):o&&(this.reset(),this.highlightCfi(t,n,i))},this.highlightElement=function(t,u,c){if(t&&t!==r){this.reset(),r=t,o=void 0,a=u,s=c;var f=this.adjustParToSeqSyncGranularity(r),d=f.element;s&&""!==s&&e(d.ownerDocument.documentElement).addClass(s);var h=e(d),p=a&&""!==a,g=l.userStyles().findStyle("."+i);n(h,p,g),g||!p?(p&&h.addClass(a),h.addClass(i)):h.addClass(a),(this.includeParWhenAdjustingToSeqSyncGranularity||r!==f)&&e(r.element).addClass("mo-sub-sync")}},this.highlightCfi=function(t,u,c){if(t&&t!==o){this.reset(),r=void 0,o=t,a=u,s=c;var f=e(o.cfi.cfiTextParent),d=a&&""!==a,h=l.userStyles().findStyle("."+i);n(f,d,h);if(l.plugins.highlights)try{var p=t.getSmil().spineItemId;l.plugins.highlights.addHighlight(p,t.cfi.partialRangeCfi,"MO_SPEAK","highlight",void 0)}catch(e){console.error(e)}else if(l.plugins.annotations)try{var p=t.getSmil().spineItemId;l.plugins.annotations.addHighlight(p,t.cfi.partialRangeCfi,"MO_SPEAK","highlight",void 0)}catch(e){console.error(e)}}},this.reset=function(){if(o){var t=o.cfi.cfiTextParent.ownerDocument;if(l.plugins.highlights)try{l.plugins.highlights.removeHighlight("MO_SPEAK");for(var n=void 0;null!==(n=t.getElementById("start-MO_SPEAK"));)console.log("toRemove START"),console.log(n),n.parentNode.removeChild(n);for(;null!==(n=t.getElementById("end-MO_SPEAK"));)console.log("toRemove END"),console.log(n),n.parentNode.removeChild(n)}catch(e){console.error(e)}else if(l.plugins.annotations)try{l.plugins.annotations.removeHighlight("MO_SPEAK");for(var n=void 0;null!==(n=t.getElementById("start-MO_SPEAK"));)console.log("toRemove START"),console.log(n),n.parentNode.removeChild(n);for(;null!==(n=t.getElementById("end-MO_SPEAK"));)console.log("toRemove END"),console.log(n),n.parentNode.removeChild(n)}catch(e){console.error(e)}o=void 0}if(r){var u=this.adjustParToSeqSyncGranularity(r),c=u.element;(this.includeParWhenAdjustingToSeqSyncGranularity||r!==u)&&e(r.element).removeClass("mo-sub-sync"),s&&""!==s&&e(c.ownerDocument.documentElement).removeClass(s),a&&""!==a&&e(c).removeClass(a),e(c).removeClass(i),r=void 0}a="",s=""},this.adjustParToSeqSyncGranularity=function(e){if(e){var t=l.viewerSettings().mediaOverlaysSynchronizationGranularity;if(t&&t.length>0){if(!(e.element||(e.cfi?e.cfi.cfiTextParent:void 0)))return console.error("adjustParToSeqSyncGranularity !element ???"),e;var n=e.getFirstSeqAncestorWithEpubType(t,this.includeParWhenAdjustingToSeqSyncGranularity);if(n&&n.element)return n}return e}}}}),define("readium_shared_js/views/scroll_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","../models/current_pages_info","../helpers","./one_page_view","../models/page_open_request","../models/viewer_settings"],function(e,t,n,i,r,o,a,s,l,u){return function(c,f,d){function h(e,t){if(he)return void e();var n=N();if(!n)return void e();var i=H(0),r=G(n);if(i.top-r.bottom>se){var o=L();_(n),y(o-(r.bottom-r.top),void 0),t("updateLoadedViewsTop 1"),h(e,t)}else i.top-r.top<se?b(n,function(n){n?(t("updateLoadedViewsTop 2"),h(e,t)):e()}):e()}function p(e,t){if(he)return void e();var n=R();if(!n)return void e();var i=H(0),r=G(n);r.top-i.bottom>se?(_(n),t("updateLoadedViewsBottom 1"),p(e,t)):r.bottom-i.bottom<se?T(n,function(n){t("updateLoadedViewsBottom 2"),n?p(e,t):e()}):e()}function g(e){if(f){var t=void 0;if(Q&&e){var n=e.offset();n&&(t=n.top)}var i=function(n){if(Q){if(!t)return;var i=void 0,r=e.offset();if(r&&(i=r.top),!i)return;var o=i-t;Math.abs(o)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+n+") "+o+" -- "+e.currentSpineItem().href)}};pe=!0,p(function(){h(function(){setTimeout(function(){pe=!1},le+100)},i)},i)}}function m(e){d.viewerSettings().mediaOverlaysPreservePlaybackWhenScroll||!ve&&d.isMediaOverlayAvailable()&&(ve=d.isPlayingMediaOverlay())&&d.pauseMediaOverlay()}function v(e){if(!pe&&!ge&&!me){ue.resetCurrentPosition(),g(),F(ue),n.defer(function(){ie||ue.saveCurrentPosition()});d.viewerSettings().mediaOverlaysPreservePlaybackWhenScroll||ve&&setTimeout(function(){d.playMediaOverlay(),ve=!1},100)}}function y(e,t){re[0].scrollTop=e,t&&F(t.initiator,t.spineItem,t.elementId)}function E(e){var t=L(),n=G(e);I(e);var i=G(e),r=i.bottom-i.top,o=n.bottom-n.top,a=r-o;Math.abs(a)>0&&(Q&&console.debug("IMMEDIATE SCROLL ADJUST: "+e.currentSpineItem().href+" == "+a),y(t+a))}function b(e,t){var n=fe.prevItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var i=O(n,!0),r=R();i.element().insertAfter(r.element()),i.loadSpineItem(n,function(r,o,a,s,l){if(r){I(i);var u=G(i);_(i);var c=L(),f=O(n),d=u.bottom-u.top;f.setHeight(d),f.element().insertBefore(e.element()),c+=d,y(c,void 0),f.loadSpineItem(n,function(e,i,r,o,a){e?(E(f),D(f,e,i,r,o,a),t(e)):(console.error("Unable to open 2 "+n.href),_(f),t(!1))})}else console.error("Unable to open 1 "+n.href),_(i),t(!1)})}function I(e){e.currentSpineItem().isFixedLayout()?e.scaleToWidth(re.width()):e.resizeIFrameToContent()}function T(e,t){var n=fe.nextItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var i=(L(),O(n));i.element().insertAfter(e.element()),i.loadSpineItem(n,function(e,r,o,a,s){e?(I(i),D(i,e,r,o,a,s),t(e)):(console.error("Unable to load "+n.href),t(!1))})}function w(){var e=[];P(function(t){e.push(t)},!1);for(var t=0,n=e.length;t<n;t++)_(e[t])}function _(e){e.onUnload(),e.element().remove()}function S(e){re.css("left",e.left),re.css("top",e.top),re.css("right",e.right),re.css("bottom",e.bottom)}function O(t,i){function r(){I(a),F(ue),g(),ie&&!ne&&ue.restoreCurrentPosition()}c.disablePageTransitions=!0;var o=!0;t.isFixedLayout()&&(o=!1);var a=new s(c,["content-doc-frame"],o,d);a.on(s.Events.SPINE_ITEM_OPEN_START,function(t,n){e.logEvent("OnePageView.Events.SPINE_ITEM_OPEN_START","ON","scroll_view.js [ "+n.href+" ]"),e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","scroll_view.js [ "+n.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),a.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","ON","scroll_view.js [ "+n.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)});var l=n.debounce(r,100);a.on(s.Events.CONTENT_SIZE_CHANGED,function(t,n){e.logEvent("OnePageView.Events.CONTENT_SIZE_CHANGED","ON","scroll_view.js [ "+n.href+" ]"),l()}),a.render();return ye&&a.setViewSettings(ye,!0),i||a.element().data("pageView",a),f&&a.decorateIframe(),a}function C(e,t){var n=void 0;return P(function(t){return t.currentSpineItem()!=e||(n=t,!1)},t),n}function P(e,t){for(var n=re.children(),i=n.length,r=t?function(e){return e-1}:function(e){return e+1},o=t?function(e){return e>=0}:function(e){return e<i},a=t?i-1:0,s=a;o(s);s=r(s)){var l=n.eq(s),u=l.data("pageView");if(u&&!1===e(u))return}}function N(){var e=void 0;return P(function(t){return e=t,!1},!1),e}function R(){var e=void 0;return P(function(t){return e=t,!1},!0),e}function D(t,n,i,r,o,a){n&&o&&(e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","scroll_view.js [ "+r.href+" ]"),ue.emit(e.Events.CONTENT_DOCUMENT_LOADED,i,r))}function x(e,t){w();var n=(L(),O(e));re.append(n.element()),n.loadSpineItem(e,function(e,i,r,o,a){e?(I(n),D(n,e,i,r,o,a)):(console.error("Unable to load "+r.href),_(n),n=void 0),t(n)})}function A(e,t){var n,i,r,o,a=0;if(void 0!==t.scrollTop)a=t.scrollTop;else if(void 0!==t.spineItemPageIndex){var s;n=M(),s=t.spineItemPageIndex<0?0:t.spineItemPageIndex>=n?n-1:t.spineItemPageIndex,a=s*k()}else if(e&&t.elementId){if(o=G(e),r=e.getNavigator(),!(i=r.getElementById(t.elementId))||!i.length)return void console.warn("Element id="+t.elementId+" not found!");if(J(e,i,60))return void F(t.initiator,t.spineItem,t.elementId);var l=Y(e,i);a=l.top+o.top}else if(e&&t.elementCfi){o=G(e),r=e.getNavigator();var u=r.getDomRangeFromRangeCfi(t.elementCfi);if(!u)return void console.warn("Range for cfi="+t.elementCfi+" not found!");var c=K(e,u);if(X(c,60))return void F(t.initiator,t.spineItem,t.elementId);a=c.top}else if(t.firstPage)a=0;else if(t.lastPage){if(0===(n=M()))return;a=V()-k()-5}else e?(o=G(e),a=o.top):a=0;L()!=a?(ge=!0,y(a,t),setTimeout(function(){ge=!1},le+100)):F(t.initiator,t.spineItem,t.elementId)}function M(){return Math.ceil(V()/k())}function F(t,n,i){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","scroll_view.js"),ue.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:ue.getPaginationInfo(),initiator:t,spineItem:n,elementId:i})}function L(){return re[0].scrollTop}function j(){return V()-(L()+k())}function k(){return re.height()}function V(){return re[0].scrollHeight}function U(){var e=[],t=H(-ae);return P(function(n){if(B(n,t))e.push(n);else if(e.length>0)return!1;return!0},!1),e}function B(e,t){return q(z(G(e),t))>0}function G(e){var t={top:0,bottom:0},n=e.element(),i=n.position();if(ee){var r=n.offsetParent();i.top-=r.scrollTop(),i.left-=r.scrollLeft()}return t.top=i.top+L(),t.bottom=t.top+e.getCalculatedPageHeight(),t}function W(e){var t,n=H(),i=void 0,r={top:0,bottom:0},o=!1;return P(function(a){if(t=G(a),r.top=Math.max(t.top,n.top)-t.top,r.bottom=Math.min(t.bottom,n.bottom)-t.top,q(r)>0){if(o=!0,i=e(a,r))return!1}else if(o)return!1;return!0},!1),i}function H(e){0===e||e||(e=0);var t={top:L()-e,bottom:L()+k()+e};return t.top<0&&(t.top=0),t.bottom>V()&&(t.bottom=V()),t}function z(e,t){return{top:Math.max(e.top,t.top),bottom:Math.min(e.bottom,t.bottom)}}function q(e){return e.bottom<e.top?0:e.bottom-e.top}function J(e,t,n){return X(Y(e,t),n)}function X(e,t){var n=H(),i=Math.min(q(n),q(e));return 0===i&&(i=5),q(z(n,e))/i*100>=t}function Y(e,t){var n=G(e),i={top:0,bottom:0};return i.top=t.offset().top+n.top,i.bottom=i.top+t.height(),i}function K(e,t){var n=G(e),i={top:0,bottom:0},r=t.getBoundingClientRect();return i.top=r.top+n.top,i.bottom=i.top+r.height,i}function $(e){var t,n,i=U(),r=e(i),o=r.element().position().top;t={top:Math.min(0,o),left:0};var a=Math.min(r.element().height(),k());return o>=0&&(a-=o),n={width:r.element().width(),height:a},e([r.getFirstVisibleCfi,r.getLastVisibleCfi])(t,n)}function Z(e,t){return new r(e.idref,t)}var Q=ReadiumSDK.DEBUG_MODE,ee=!1;try{var te=t.fn.jquery.split(".");2==parseInt(te[0])&&2==parseInt(te[1])&&0==parseInt(te[2])&&(ee=!0)}catch(e){console.error(e)}t.extend(this,new i);var ne,ie,re,oe,ae=5,se=2e3,le=300,ue=this,ce=t(c.$viewport),fe=c.spine,de=c.userStyles,he=!1,pe=!1,ge=!1,me=!1;this.isContinuousScroll=function(){return f},this.render=function(){var e=a.loadTemplate("scrolled_book_frame",{});oe=t(e),ce.append(oe),re=t("#scrolled-content-frame",oe),re.css("overflow",""),re.css("overflow-y","auto"),re.css("overflow-x","hidden"),re.css("-webkit-overflow-scrolling","touch"),re.css("width","100%"),re.css("height","100%"),re.css("position","relative");var i=d.viewerSettings();i&&void 0!==i.enableGPUHardwareAccelerationCSS3D||(i=new u({})),i.enableGPUHardwareAccelerationCSS3D&&re.css("transform","translateZ(0)"),ue.applyStyles();var r=n.debounce(v,le);return re.on("scroll",function(e){r(e),m()}),ue};var ve=!1;this.remove=function(){oe.remove()},this.onViewportResize=function(){},this.resetCurrentPosition=function(){ie=void 0},this.saveCurrentPosition=function(){if(!ne){var e=ue.getFirstVisibleCfi(),t=fe.getItemById(e.idref);t&&(ie=new l(t,ue),ie.setElementCfi(e.contentCFI))}},this.restoreCurrentPosition=function(){ie&&this.openPageInternal(ie)};var ye=void 0;this.setViewSettings=function(e,t){ye=e,P(function(n){n.setViewSettings(e,t)},!1)},this.applyStyles=function(){a.setStyles(de.getStyles(),oe.parent()),S(a.Margins.fromElement(oe).padding)},this.applyBookStyles=function(){P(function(e){e.applyBookStyles()},!1)},this.openPageInternal=function(e){he=!0;var t=function(e,t){ne=void 0,A(e,t),he=!1,g(e)};if(e.spineItem){var n=C(e.spineItem);n?t(n,e):(ne=e,me=!0,x(e.spineItem,function(n){setTimeout(function(){me=!1},le+100),n&&ne?n.currentSpineItem()===ne.spineItem?t(n,ne):ue.openPage(ne):F(e.initiator,e.spineItem,e.elementId)}))}else t(void 0,e)},this.openPage=function(e){this.resetCurrentPosition(),ie=e,this.openPageInternal(e)},this.openPageNext=function(e){var t;j()>0&&(t=new l(void 0,e),t.scrollTop=L()+Math.min(j(),k()-ae),A(void 0,t))},this.openPagePrev=function(e){var t;L()>0&&(t=new l(void 0,e),t.scrollTop=L()-(k()-ae),t.scrollTop<0&&(t.scrollTop=0),A(void 0,t))},this.getPaginationInfo=function(){for(var e,t,n,i,r,a,s,l,u=H(),c=u.bottom-u.top,f=new o(fe,!1),d=U(),h=0,p=d.length;h<p;h++)n=d[h],e=n.currentSpineItem(),i=G(n),r=Math.max(u.top-i.top,0),a=Math.max(i.bottom-u.bottom,0),s=Math.ceil(r/c),l=Math.ceil(a/c),t=s+l+1,f.addOpenPage(s,t,e.idref,e.index);return f},this.bookmarkCurrentPage=function(){return ue.getFirstVisibleCfi()},this.getLoadedSpineItems=function(){var e=[];return P(function(t){e.push(t.currentSpineItem())},!1),e},this.getElement=function(e,t){var n=void 0;return P(function(i){return i.currentSpineItem().idref!=e||(n=i.getNavigator().getElement(t),!1)},!1),n},this.getElementById=function(e,t){var n=void 0;return P(function(i){return i.currentSpineItem().idref!=e||(n=i.getNavigator().getElementById(t),!1)},!1),n||void console.error("spine item is not loaded")},this.getElementByCfi=function(e,t,n,i,r){var o=void 0;return P(function(a){return a.currentSpineItem().idref!=e||(o=a.getNavigator().getElementByCfi(t,n,i,r),!1)},!1),o||void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){return W(function(e,t){return e.getNavigator().getFirstVisibleMediaOverlayElement(t)})},this.insureElementVisibility=function(e,n,i){var r=void 0;if(P(function(t){return t.currentSpineItem().idref!==e||(r=t,!1)},!1),!r)return void console.warn("Page for element "+n+" not found");var o=t(n),a=Y(r,o);if(!X(a,60)){var s=fe.getItemById(e),u=new l(s,i);u.scrollTop=a.top,ue.openPage(u)}},this.getVisibleElements=function(e,t){var i=[];return P(function(r){t?i.push({elements:r.getVisibleElements(e),spineItem:r.currentSpineItem()}):i=n.flatten([i,r.getVisibleElements(e)],!0)}),i},this.getVisibleElementsWithFilter=function(e){console.warn("getVisibleElementsWithFilter: Not implemented yet for scroll_view")},this.isElementVisible=function(e){console.warn("isElementVisible: Not implemented yet for scroll_view")},this.getElements=function(e,t){var n=C(e);if(n)return n.getElements(e,t)},this.isNodeFromRangeCfiVisible=function(e,t){var n=C(spineIdRef);if(n)return n.isNodeFromRangeCfiVisible(spineIdRef,t)},this.isVisibleSpineItemElementCfi=function(e,t){var n=C(e);if(n)return n.isVisibleSpineItemElementCfi(e,t)},this.getNodeRangeInfoFromCfi=function(e,t){var n=C(e);if(n)return n.isVisibleSpineItemElementCfi(e,t)},this.getFirstVisibleCfi=function(){return $(n.first)},this.getLastVisibleCfi=function(){return $(n.last)},this.getDomRangeFromRangeCfi=function(e,t,n){return t&&e.idref!==t.idref?void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref"):(e=e||{},t=t||{},W(function(i){if(i.currentSpineItem().idref===e.idref)return i.getDomRangeFromRangeCfi(e.contentCFI,t.contentCFI,n)}))},this.getRangeCfiFromDomRange=function(e){return W(function(t){return t.getRangeCfiFromDomRange(e)})},this.getVisibleCfiFromPoint=function(e,t,n){return W(function(i){return Z(i.currentSpineItem(),i.getVisibleCfiFromPoint(e,t,n))})},this.getRangeCfiFromPoints=function(e,t,n,i){return W(function(r){return Z(r.currentSpineItem(),r.getRangeCfiFromPoints(e,t,n,i))})},this.getCfiForElement=function(e){return W(function(t){return Z(t.currentSpineItem(),t.getCfiForElement(e).contentCFI)})},this.getElementFromPoint=function(e,t){return W(function(n){return n.getElementFromPoint(e,t)})},this.getStartCfi=function(){return W(function(e){return e.getStartCfi()})},this.getEndCfi=function(){return W(function(e){return e.getEndCfi()})},this.getNearestCfiFromElement=function(e){return W(function(t){return t.getNearestCfiFromElement(e)})}}}),define("readium_shared_js/views/media_overlay_player",["../globals","jquery","../helpers","./audio_player","./media_overlay_element_highlighter","../models/smil_iterator","readium_cfi_js","./scroll_view"],function(e,t,n,i,r,o,a,s){return function(l,u){function c(e){var t=e.getSmil();if(b&&b.smil==t?b.reset():b=new o(t),b.goToPar(e),!b.currentPar)return void console.error("playPar !_smilIterator.currentPar");d()}function f(){D.resetBlankPage(),L=setTimeout(function(){if(L){if(D.resetBlankPage(),!b||!b.currentPar)return void D.reset();k=0,p(b.currentPar.audio.clipEnd+.1,2)}},2e3),u({isPlaying:!0})}function d(){if(z=!1,!b||!b.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!b.smil.id)return I.reset(),D.resetTTS(),D.resetEmbedded(),void setTimeout(function(){f()},100);if(b.currentPar.audio.src){D.resetTTS(),D.resetEmbedded(),D.resetBlankPage();var e=b.currentPar.audio.clipEnd-b.currentPar.audio.clipBegin;(e<=0||F>e)&&(console.error("### MO XXX PAR OFFSET: "+F+" / "+e),F=0);var i=n.ResolveContentRef(b.currentPar.audio.src,b.smil.href),r=N.resolveRelativeUrlMO(i),o=b.currentPar.audio.clipBegin+F;I.playFile(b.currentPar.audio.src,r,o)}else{F=0,I.reset();var s=b.currentPar.element;if(s){k=0;var l=s.nodeName?s.nodeName.toLowerCase():void 0;"audio"===l||"video"===l?(D.resetTTS(),D.resetBlankPage(),P&&D.resetEmbedded(),P=s,P.pause(),P.currentTime=0,P.play(),t(P).on("ended",D.onEmbeddedEnd),C=!0,setTimeout(function(){u({isPlaying:!0})},80)):(D.resetEmbedded(),D.resetBlankPage(),w=s.textContent,w&&""!=w?G(w):w=void 0)}var c=b.currentPar.cfi;if(c){k=0,D.resetEmbedded(),D.resetBlankPage(),x.reset();var d=c.cfiTextParent.ownerDocument,h="epubcfi("+c.partialStartCfi+")",p=(a.getTextTerminusInfoWithPartialCFI(h,d,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),"epubcfi("+c.partialEndCfi+")");a.getTextTerminusInfoWithPartialCFI(p,d,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);w=void 0,w&&""!=w?G(w):w=void 0}}F=0,E()}function h(e){D.pause();var t=e?N.media_overlay.getNextSmil(b.smil):N.media_overlay.getPreviousSmil(b.smil);if(t){if(b=new o(t),b.currentPar){if(!e)for(;!b.isLast();)b.next();l.openContentUrl(b.currentPar.text.src,b.smil.href,D)}}else console.log("No more SMIL"),D.reset()}function p(e,t,n){if(k=e,j=!1,b&&b.currentPar){var i=b.currentPar,r=b.currentPar.audio;if(!(e>V&&e<=r.clipEnd)){j=!0;var o=I.isPlaying();o&&6===t&&console.debug("from userNav _audioPlayer.isPlaying() ???");var a=e>r.clipEnd,s=!J&&6!==t&&a,l=b&&b.smil&&b.smil.spineItemId?b.smil.spineItemId:M&&M.spineItem&&M.spineItem.idref?M.spineItem.idref:void 0;if(s&&l&&M&&M.paginationInfo&&M.paginationInfo.openPages&&M.paginationInfo.openPages.length>1){l===M.paginationInfo.openPages[0].idref&&(s=!1)}if(a?b.next():b.previous(),!b.currentPar)return void(s?(q=!0,D.reset()):h(a));if(!b.currentPar.audio)return void D.pause();if(R.mediaOverlaysSkipSkippables){for(var u=!1,c=b.currentPar;c;){if(c.isSkippable&&c.isSkippable(R.mediaOverlaysSkippables)){u=!0;break}c=c.parent}if(u){console.log("MO SKIP: "+c.epubtype),D.pause();return void p(a?b.currentPar.audio.clipEnd+.1:V-1,t,!0)}}if(!o&&(b.currentPar.element||b.currentPar.cfi&&b.currentPar.cfi.cfiTextParent)){var f=x.adjustParToSeqSyncGranularity(b.currentPar);if(f&&f!==b.currentPar){var g=x.adjustParToSeqSyncGranularity(i);if(g&&(g===f||!a)){if(g===f){do{a?b.next():b.previous()}while(b.currentPar&&b.currentPar.hasAncestor(g));if(!b.currentPar)return void(s?(q=!0,D.reset()):h(a))}if(!a){var m=x.adjustParToSeqSyncGranularity(b.currentPar);if(m&&m!==b.currentPar){var v=b.currentPar,y=void 0;do{y=b.currentPar,b.previous()}while(b.currentPar&&b.currentPar.hasAncestor(m));b.currentPar?(b.next(),b.currentPar.hasAncestor(m)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(b.reset(),b.currentPar!==y&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),b.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),b.goToPar(v))}}}}}if(I.isPlaying()&&b.currentPar.audio.src&&b.currentPar.audio.src==I.currentSmilSrc()&&e>=b.currentPar.audio.clipBegin&&e<=b.currentPar.audio.clipEnd)return void E();d()}}}function g(e){if(!B||B[0].ownerDocument!==e[0].ownerDocument){$head=t("head",e[0].ownerDocument.documentElement),B=t("<style type='text/css'> </style>").appendTo($head),B.append(".tts_on{background-color:red;color:white;} .tts_off{}")}}function m(){v();var e=function(){if(b&&b.currentPar){var e=b.smil;if(e.mo){var t=k-b.currentPar.audio.clipBegin;if(!(t<=0)){for(var n=e.mo.smil_models.indexOf(e),i=new o(e),r=-1;i.currentPar&&(r++,i.currentPar!=b.currentPar);)i.next();u({playPosition:t,smilIndex:n,parIndex:r})}}}};setTimeout(e,500),H=setInterval(e,1500)}function v(){k=0,void 0!==H&&clearInterval(H),H=void 0}function y(){return v(),j?void(j=!1):b&&b.currentPar?void p(b.currentPar.audio.clipEnd+.1,5):void D.reset()}function E(){if(b&&b.currentPar){if(b.currentPar.text.srcFragmentId&&b.currentPar.text.srcFragmentId.length>0){if(b.currentPar.element)return void(x.isElementHighlighted(b.currentPar)||(x.highlightElement(b.currentPar,N.media_overlay.activeClass,N.media_overlay.playbackActiveClass),z||l.insureElementVisibility(b.currentPar.getSmil().spineItemId,b.currentPar.element,D)));if(b.currentPar.cfi)return void(x.isCfiHighlighted(b.currentPar)||(x.highlightCfi(b.currentPar,N.media_overlay.activeClass,N.media_overlay.playbackActiveClass),z||l.insureElementVisibility(b.currentPar.getSmil().spineItemId,b.currentPar.cfi.cfiTextParent,D)))}if(!b.currentPar.element){var e=b.currentPar.text.src,t=b.smil.href;b=void 0,l.openContentUrl(e,t,D)}}}var b=void 0,I=new i(u,p,y,m,v),T=!1,w=void 0,_=void 0!==window.speechSynthesis&&null!=speechSynthesis,S=void 0,O=!1,C=!1,P=void 0;this.isPlaying=function(){return I.isPlaying()||T||C||L};var N=l.package(),R=l.viewerSettings(),D=this,x=new r(l);l.on(e.Events.READER_VIEW_DESTROYED,function(){e.logEvent("READER_VIEW_DESTROYED","ON","media_overlay_player.js"),D.reset()}),this.applyStyles=function(){x.reDo()},this.onSettingsApplied=function(){I.setRate(R.mediaOverlaysRate),I.setVolume(R.mediaOverlaysVolume/100)},D.onSettingsApplied(),l.on(e.Events.SETTINGS_APPLIED,function(){e.logEvent("SETTINGS_APPLIED","ON","media_overlay_player.js"),this.onSettingsApplied()},this);var A=!1;this.onDocLoadStart=function(){D.isPlaying()&&(A=!0,D.pause())};var M=void 0;this.onPageChanged=function(e){M=e;var n=q;q=!1;var i=A;if(A=!1,!e)return void D.reset();var r=void 0;if(e.elementId||e.initiator==D){for(var o=l.getLoadedSpineItems(),a=l.spine().isRightToLeft(),s=a?o.length-1:0;a&&s>=0||!a&&s<o.length;s+=a?-1:1){var u=o[s];if(!e.spineItem||e.spineItem==u){if(e.elementId&&0===e.elementId.indexOf("epubcfi")){x.reset();var f=e.elementId.substr("epubcfi".length+1,e.elementId.length-"epubcfi".length-2);0===f.indexOf("/99!")&&(f=f.substr("/99!".length,f.length-"/99!".length));var h=f.split(",");if(h&&3===h.length)try{var p=h[0]+h[1],g=l.getElementByCfi(u.idref,p,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(r=g&&g.length>0?g[0]:void 0){r.nodeType===Node.TEXT_NODE&&(r=r.parentNode);break}}catch(e){console.error(e)}else try{var g=l.getElementByCfi(u.idref,f,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(r=g&&g.length>0?g[0]:void 0){r.nodeType===Node.TEXT_NODE&&(r=r.parentNode);break}}catch(e){console.error(e)}}if(!r){if(e.initiator!=D||e.elementId){var g=l.getElementById(u.idref,e.elementId);r=g&&g.length>0?g[0]:void 0}else{var g=l.getElement(u.idref,"body");r=g&&g.length>0?g[0]:void 0}if(r)break}}}r||console.error("paginationData.elementId BUT !element: "+e.elementId)}var m=D.isPlaying()||i;if(!b||!b.currentPar){if(e.initiator!==D)return F=0,D.reset(),void(e.elementId&&r?(m||n)&&(e.elementIdResolved=r,D.toggleMediaOverlayRefresh(e)):(m||n)&&D.toggleMediaOverlay());if(!r)return console.error("!element: "+e.elementId),void(F=0);var v=t(r).data("mediaOverlayData");if(!v)return console.error("!moData: "+e.elementId),void(F=0);var y=v.par?v.par:v.pars[0];if(v.pars)for(var I=0;I<v.pars.length;I++){var T=v.pars[I];if(e.elementId===T.cfi.smilTextSrcCfi){y=T;break}}return void c(y)}var w=!b.currentPar.element&&!b.currentPar.cfi;if(w&&console.error("!! _smilIterator.currentPar.element ??"),e.initiator==D){var _=e.elementId&&e.elementId!==b.currentPar.text.srcFragmentId;if(_&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),_||w)return void(F=0);m?E():d()}else{if(!m&&!n)return void D.reset();if(e.elementId,e.elementId&&!r)return;e.elementId&&(e.elementIdResolved=r),D.toggleMediaOverlayRefresh(e)}};var F=0,L=void 0,j=!1,k=0,V=-999;this.touchInit=function(){return I.touchInit()};var U=function(e){
var t=["p","div","pagenum","td","table","li","ul","ol"],n=[",",";",".","-","??","??","?","!"],i=function(e,t){if(!(e.word.length<=0)){var n=e.text.length;t.spanMap[n]=e.counter,e.text+=e.word,e.markup+=e.html.substring(0,e.wordStart)+'<span class="tts_off" id="tts_'+e.counter+'">'+e.html.substring(e.wordStart,e.wordEnd)+"</span>"+e.html.substring(e.wordEnd,e.html.length),e.word="",e.html="",e.wordStart=-1,e.wordEnd=-1,e.counter++}},r={element:e,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};r.element.innerHTML_original=e.innerHTML;for(var o={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},a=r.element.innerHTML_original.length,s=0;s<=a;){if(o.inTag){if(o.html+=r.element.innerHTML_original[s],">"==r.element.innerHTML_original[s]){o.inTag=!1;var l=o.html.match(/<\/(.*?)>$/);l&&t.indexOf(l[1])>-1&&(i(o,r),o.text+=" ")}}else s==a||r.element.innerHTML_original[s].match(/\s/)?(i(o,r),s<a&&(o.text+=r.element.innerHTML_original[s],o.markup+=r.element.innerHTML_original[s])):n.indexOf(r.element.innerHTML_original[s])>-1?(i(o,r),o.wordStart=o.html.length,o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s],i(o,r)):"<"==r.element.innerHTML_original[s]?(o.inTag=!0,o.html+=r.element.innerHTML_original[s]):(0==o.word.length&&(o.wordStart=o.html.length),o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s]);s++}return r.text=o.text,r.innerHTML_tts=o.markup,r.element.innerHTML=r.innerHTML_tts,r},B=void 0,G=function(n,i){function r(e){e||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){r(!1)},5)):o()}function o(){S=new SpeechSynthesisUtterance,O&&a&&(S.tokenData=a,S.onboundary=function(e){if(S){console.debug("TTS boundary: "+e.name+" / "+e.charIndex);var t=e.target.tokenData;if(t&&t.spanMap.hasOwnProperty(e.charIndex)){var n;[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF "+e.id),e.className="tts_off"});var n="tts_"+t.spanMap[e.charIndex];console.debug("TTS charIndex ID: "+n);var i=t.element.querySelector("#"+n);i&&(console.debug("TTS ON"),i.className="tts_on"),t.lastCharIndex=e.charIndex}}}),S.onend=function(e){if(S)if(console.debug("TTS ended"),O){var t=e.target.tokenData,n=!e.forceSkipEnd&&S===e.target&&(!t||t.element.innerHTML_original);t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (end)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0),n?D.onTTSEnd():console.debug("TTS end SKIPPED")}else D.onTTSEnd()},S.onerror=function(e){if(S&&(console.error("TTS error"),console.debug(S.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),O)){var t=e.target.tokenData;t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.ownerDocument.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (error)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0)}};var e=i||I.getVolume();S.volume=e,S.rate=I.getRate(),S.pitch=1,S.text=f,window.speechSynthesis.speak(S),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}var a=void 0,s=b&&b.currentPar?b.currentPar:void 0,c=s?s.element:void 0;s&&s.cfi;if((!i||i>0)&&(setTimeout(function(){u({isPlaying:!0})},80),T=!0,O&&c)){g(t(c)),c.innerHTML_original&&(c.innerHTML=c.innerHTML_original,c.innerHTML_original=void 0),a=U(c)}if(!_)return e.logEvent("MEDIA_OVERLAY_TTS_SPEAK","EMIT","media_overlay_player.js"),void l.emit(e.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:n});if(!n&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var f=n||w;f&&(S&&(O&&(S.onend&&S.onend({forceSkipEnd:!0,target:S}),S.tokenData=void 0,S.onboundary=void 0),S.onend=void 0,S.onerror=void 0,S=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),r(!0))},W=function(){var t=T;if(t&&u({isPlaying:!1}),T=!1,!_)return void(t&&(e.logEvent("MEDIA_OVERLAY_TTS_STOP","EMIT","media_overlay_player.js"),l.emit(e.Events.MEDIA_OVERLAY_TTS_STOP,void 0)));window.speechSynthesis.pause()},H=void 0;this.onEmbeddedEnd=function(){if(k=0,C=!1,!b||!b.currentPar)return void D.reset();p(b.currentPar.audio.clipEnd+.1,3)},this.onTTSEnd=function(){if(k=0,T=!1,!b||!b.currentPar)return void D.reset();p(b.currentPar.audio.clipEnd+.1,4)},this.escape=function(){if(!b||!b.currentPar)return void this.toggleMediaOverlay();if(!D.isPlaying())return void D.play();if(R.mediaOverlaysEscapeEscapables)for(var e=b.currentPar;e;){if(e.isEscapable&&e.isEscapable(R.mediaOverlaysEscapables)){do{b.next()}while(b.currentPar&&b.currentPar.hasAncestor(e));return b.currentPar?void d():void h(!0)}e=e.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(e){if(D.isPlaying()&&D.pause(),e.element||e.cfi&&e.cfi.cfiTextParent){var t=x.adjustParToSeqSyncGranularity(e);if(t&&t!==e){var n=function(e){if(e.nodeType&&"par"===e.nodeType)return e;if(e.children&&!(e.children.length<=0))for(var t=0;t<e.children.length;t++){var i=e.children[t],r=n(i);if(r)return r}},i=n(t);i&&(e=i)}}c(e)},this.resetTTS=function(){w=void 0,W()},this.resetBlankPage=function(){var e=!1;if(L){e=!0;var t=L;L=void 0,clearTimeout(t)}L=void 0,e&&u({isPlaying:!1})},this.resetEmbedded=function(){var e=C;P&&(t(P).off("ended",D.onEmbeddedEnd),P.pause()),P=void 0,e&&u({isPlaying:!1}),C=!1},this.reset=function(){F=0,I.reset(),D.resetTTS(),D.resetEmbedded(),D.resetBlankPage(),x.reset(),b=void 0,j=!1},this.play=function(){if(b&&b.smil&&!b.smil.id)return void f();if(P)C=!0,P.play(),u({isPlaying:!0});else if(w)G(void 0);else if(!I.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();E()},this.pause=function(){z=!1,L?this.resetBlankPage():C?(C=!1,P&&P.pause(),u({isPlaying:!1})):T?W():I.pause(),x.reset()},this.isMediaOverlayAvailable=function(){return void 0!==l.getFirstVisibleMediaOverlayElement()},this.nextOrPreviousMediaOverlay=function(e){if(D.isPlaying())D.pause();else if(b&&b.currentPar)return void D.play();if(!b)return void this.toggleMediaOverlay();p(e?V-1:b.currentPar.audio.clipEnd+.1,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(e,t,n){F=n,b=void 0,l.openContentUrl(e,t,D)},this.toggleMediaOverlay=function(){return D.isPlaying()?void D.pause():b?void D.play():void this.toggleMediaOverlayRefresh(void 0)};var z=!1;this.toggleMediaOverlayRefresh=function(e){var n=l.getLoadedSpineItems(),i=l.spine().isRightToLeft(),r=void 0,a=D.isPlaying();if(a&&b){if(e.initiator&&e.initiator instanceof s&&R.mediaOverlaysPreservePlaybackWhenScroll)return void(z=!0);r=b.currentPar,D.pause()}z=!1;var u=e&&e.elementIdResolved?e.elementIdResolved:void 0,c=e&&e.elementId?e.elementId:void 0;if(!u){c&&console.error("[WARN] id did not resolve to element?");for(var f=i?n.length-1:0;i&&f>=0||!i&&f<n.length;f+=i?-1:1){var h=n[f];if(h){if(!e||!e.spineItem||e.spineItem==h){if(c){var p=l.getElementById(h.idref,c);u=p&&p.length>0?p[0]:void 0}else if(h.isFixedLayout()&&e&&e.paginationInfo&&e.paginationInfo.openPages){if(e.paginationInfo.openPages[0]&&e.paginationInfo.openPages[0].idref&&e.paginationInfo.openPages[0].idref===h.idref){var p=l.getElement(h.idref,"body");u=p&&p.length>0?p[0]:void 0}}if(u)break}}else console.error("spineItems[i] is undefined??")}}if(u||(u=l.getFirstVisibleMediaOverlayElement()),!u)return void D.reset();var g=t(u).data("mediaOverlayData");if(!g){for(var m=!1,v=function(e){if(!e)return!1;for(var n=0;n<e.length;n++){if(u===e[n]&&(m=!0),m){var i=t(e[n]).data("mediaOverlayData");if(i)return g=i,!0}if(v(e[n].children))return!0}return!1},y=u;y&&"body"!==y.nodeName.toLowerCase();)y=y.parentNode;if(!y)return void D.reset();v([y])}if(!g)return void D.reset();var E=g.par?g.par:g.pars[0],I=E.getSmil();if(b&&b.smil==I?b.reset():b=new o(I),b.goToPar(E),!b.currentPar&&c&&(b.reset(),b.findTextId(c)),!b.currentPar)return void D.reset();a&&r&&r===b.currentPar?D.play():d()},this.isPlayingCfi=function(){return b&&b.currentPar&&b.currentPar.cfi};var q=!1,J=!0;this.setAutomaticNextSmil=function(e){J=e}}}),define("readium_shared_js/models/spine",["./spine_item","../helpers","URIjs"],function(e,t,n){return function(t,i){function r(e){return!u||"no"!==e.linear}function o(e){return e>=0&&e<l.items.length}function a(e){if(o(e)){var t=l.items[e];return r(t)?t:a(t.index-1)}}function s(e){if(o(e)){var t=l.items[e];return r(t)?t:s(t.index+1)}}var l=this;this.items=[],this.direction="ltr",this.package=t;var u=!1;if(this.handleLinear=function(e){u=e},this.isValidLinearItem=function(e){if(o(e))return r(this.item(e))},this.isRightToLeft=function(){return"rtl"==l.direction},this.isLeftToRight=function(){return!l.isRightToLeft()},this.prevItem=function(e){return a(e.index-1)},this.nextItem=function(e){return s(e.index+1)},this.getItemUrl=function(e){return l.package.resolveRelativeUrl(e.href)},this.first=function(){return s(0)},this.last=function(){return a(this.items.length-1)},this.isFirstItem=function(e){return l.first()===e},this.isLastItem=function(e){return l.last()===e},this.item=function(e){if(o(e))return l.items[e]},this.getItemById=function(e){for(var t=l.items.length,n=0;n<t;n++)if(l.items[n].idref==e)return l.items[n]},this.getItemByHref=function(e){var t=l.package.resolveRelativeUrl(e);t=t.replace("filesystem:chrome-extension://","filesystem-chrome-extension://");for(var i=new n(t).normalizePathname().pathname(),r=l.items.length,o=0;o<r;o++){var a=l.package.resolveRelativeUrl(l.items[o].href);a=a.replace("filesystem:chrome-extension://","filesystem-chrome-extension://");if(i==new n(a).normalizePathname().pathname())return l.items[o]}},i){i.direction&&(this.direction=i.direction);for(var c=i.items.length,f=0;f<c;f++){var d=new e(i.items[f],f,this);this.items.push(d)}!function(){for(var t=l.items.length,n=!1,i=l.isLeftToRight()?e.SPREAD_LEFT:e.SPREAD_RIGHT,r=0;r<t;r++){var o=l.items[r];if(!o.page_spread){var a=o.isRenditionSpreadAllowed()?n?i:e.alternateSpread(i):e.SPREAD_CENTER;o.setSpread(a)}n=!o.isRenditionSpreadAllowed()||o.page_spread!=i}}()}}}),define("readium_shared_js/models/smil_model",["../helpers"],function(e){var t={};t.SmilNode=function(e){this.parent=e,this.id="",this.getSmil=function(){for(var e=this;e.parent;)e=e.parent;return e},this.hasAncestor=function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1}},t.TimeContainerNode=function(e){this.parent=e,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.escapables;e.length>0&&(n=e);for(var i=0;i<n.length;i++)if(this.epubtype.indexOf(n[i])>=0)return!0;return!1},this.isSkippable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.skippables;e.length>0&&(n=e);for(var i=0;i<n.length;i++)if(this.epubtype.indexOf(n[i])>=0)return!0;return!1}},t.TimeContainerNode.prototype=new t.SmilNode,t.MediaNode=function(e){this.parent=e,this.src=""},t.MediaNode.prototype=new t.SmilNode,t.SeqNode=function(e){this.parent=e,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var e=this.getSmil(),t=0,n=0;n<this.children.length;n++){var i=this.children[n];if("par"===i.nodeType){if(!i.audio)continue;if(i.text&&(!i.text.manifestItemId||i.text.manifestItemId!=e.spineItemId))continue;t+=i.audio.clipDurationMilliseconds()}else"seq"===i.nodeType&&(t+=i.durationMilliseconds())}return t},this.clipOffset=function(e,t){for(var n=this.getSmil(),i=0;i<this.children.length;i++){var r=this.children[i];if("par"===r.nodeType){if(r==t)return!0;if(!r.audio)continue;if(r.text&&(!r.text.manifestItemId||r.text.manifestItemId!=n.spineItemId))continue;var o=r.audio.clipDurationMilliseconds();e.offset+=o}else if("seq"===r.nodeType){var a=r.clipOffset(e,t);if(a)return!0}}return!1},this.parallelAt=function(e){for(var t=this.getSmil(),n=0,i=0;i<this.children.length;i++){var r=e-n,o=this.children[i];if("par"===o.nodeType){if(!o.audio)continue;if(o.text&&(!o.text.manifestItemId||o.text.manifestItemId!=t.spineItemId))continue;var a=o.audio.clipDurationMilliseconds();if(a>0&&r<=a)return o;n+=a}else if("seq"===o.nodeType){var s=o.parallelAt(r);if(s)return s;n+=o.durationMilliseconds()}}},this.nthParallel=function(e,t){for(var n=0;n<this.children.length;n++){var i=this.children[n];if("par"===i.nodeType){if(++t.count==e)return i}else if("seq"===i.nodeType){var r=i.nthParallel(e,t);if(r)return r}}}},t.SeqNode.prototype=new t.TimeContainerNode,t.ParNode=function(e){this.parent=e,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(e,t){if(e)for(var n=t?this:this.parent;n;){if(n.epubtype&&n.epubtype.indexOf(e)>=0)return n;n=n.parent}}},t.ParNode.prototype=new t.TimeContainerNode,t.TextNode=function(t){this.parent=t,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var t=this.getSmil();if(t.href&&t.href.length){for(var n=this.srcFile?this.srcFile:this.src,i=e.ResolveContentRef(n,t.href),r=t.mo.package.resolveRelativeUrlMO(i),o=0;o<t.mo.package.spine.items.length;o++){var a=t.mo.package.spine.items[o];if(t.mo.package.resolveRelativeUrl(a.href)===r)return void(this.manifestItemId=a.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+t.href)}}},t.TextNode.prototype=new t.MediaNode,t.AudioNode=function(e){this.parent=e,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var e=1e3*this.clipBegin,t=1e3*this.clipEnd;return this.clipEnd>=this.MAX||t<=e?0:t-e}},t.AudioNode.prototype=new t.MediaNode;var n=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(e){return this.children[0].parallelAt(e)},this.nthParallel=function(e){var t={count:-1};return this.children[0].nthParallel(e,t)},this.clipOffset=function(e){var t={offset:0};return this.children[0].clipOffset(t,e)?t.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var e=[];this.hasSync=function(t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1},this.addSync=function(t){if(t)for(var n=t.split(" "),i=0;i<n.length;i++){var r=n[i].trim();r.length>0&&!this.hasSync(r)&&e.push(r)}}};return n.fromSmilDTO=function(e,i){i.DEBUG&&console.debug("Media Overlay DTO import...");var r=0,o=function(){for(var e="",t=0;t<r;t++)e+="   ";return e},a=new n;a.id=e.id,a.spineItemId=e.spineItemId,a.href=e.href,a.smilVersion=e.smilVersion,a.duration=e.duration,a.duration&&a.duration.length&&a.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+a.duration+")"),a.duration=parseFloat(a.duration)),a.mo=i,a.mo.DEBUG&&(console.log("JS MO smilVersion="+a.smilVersion),console.log("JS MO id="+a.id),console.log("JS MO spineItemId="+a.spineItemId),console.log("JS MO href="+a.href),console.log("JS MO duration="+a.duration));var s=function(e,t,n,i){e in t?(e in n||console.debug("property "+e+" not declared in smil node "+n.nodeType),n[e]=t[e],a.mo.DEBUG&&console.log(o()+"JS MO: ["+e+"="+n[e]+"]")):i&&console.log("Required property "+e+" not found in smil node "+t.nodeType)},l=function(e,n){var i;if("seq"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO seq"),i=new t.SeqNode(n),s("textref",e,i,!(!n||!n.parent)),s("id",e,i),s("epubtype",e,i),i.epubtype&&i.getSmil().addSync(i.epubtype),r++,u(e,i),r--;else if("par"==e.nodeType){a.mo.DEBUG&&console.log(o()+"JS MO par"),i=new t.ParNode(n),s("id",e,i),s("epubtype",e,i),i.epubtype&&i.getSmil().addSync(i.epubtype),r++,u(e,i),r--;for(var l=0,c=i.children.length;l<c;l++){var f=i.children[l];"text"==f.nodeType?i.text=f:"audio"==f.nodeType?i.audio=f:console.error("Unexpected smil node type: "+f.nodeType)}if(!i.audio){var d=new t.AudioNode(i);d.clipBegin=0,d.clipEnd=d.MAX,d.src=void 0,i.audio=d}}else if("text"==e.nodeType)a.mo.DEBUG&&console.log(o()+"JS MO text"),i=new t.TextNode(n),s("src",e,i,!0),s("srcFile",e,i,!0),s("srcFragmentId",e,i,!1),s("id",e,i),i.updateMediaManifestItemId();else{if("audio"!=e.nodeType)return void console.error("Unexpected smil node type: "+e.nodeType);a.mo.DEBUG&&console.log(o()+"JS MO audio"),i=new t.AudioNode(n),s("src",e,i,!0),s("id",e,i),s("clipBegin",e,i),i.clipBegin&&i.clipBegin.length&&i.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+i.clipBegin+")"),i.clipBegin=parseFloat(i.clipBegin)),i.clipBegin<0&&(a.mo.DEBUG&&console.log(o()+"JS MO clipBegin adjusted to ZERO"),i.clipBegin=0),s("clipEnd",e,i),i.clipEnd&&i.clipEnd.length&&i.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+i.clipEnd+")"),i.clipEnd=parseFloat(i.clipEnd)),i.clipEnd<=i.clipBegin&&(a.mo.DEBUG&&console.log(o()+"JS MO clipEnd adjusted to MAX"),i.clipEnd=i.MAX)}return i},u=function(e,t){for(var n=e.children.length,i=0;i<n;i++){var r=l(e.children[i],t);r.index=i,t.children.push(r)}};return u(e,a),a},n}),define("readium_shared_js/models/media_overlay",["./smil_model"],function(e){var t=function(e){this.package=e,this.parallelAt=function(e){for(var t=0,n=0;n<this.smil_models.length;n++){var i=this.smil_models[n],r=e-t,o=i.parallelAt(r);if(o)return o;t+=i.durationMilliseconds_Calculated()}},this.percentToPosition=function(e,t,n,i){(e<0||e>100)&&(e=0);var r=this.durationMilliseconds_Calculated(),o=r*(e/100);if(n.par=this.parallelAt(o),n.par){var a=n.par.getSmil();if(a){for(var s=0,l=0;l<this.smil_models.length&&(t.smilData=this.smil_models[l],t.smilData!=a);l++)s+=t.smilData.durationMilliseconds_Calculated();i.milliseconds=o-(s+t.smilData.clipOffset(n.par))}}},this.durationMilliseconds_Calculated=function(){for(var e=0,t=0;t<this.smil_models.length;t++){e+=this.smil_models[t].durationMilliseconds_Calculated()}return e},this.smilAt=function(e){if(!(e<0||e>=this.smil_models.length))return this.smil_models[e]},this.positionToPercent=function(e,t,n){if(e>=this.smil_models.length)return-1;for(var i=0,r=0;r<e;r++){i+=this.smil_models[r].durationMilliseconds_Calculated()}var o=this.smil_models[e],a=o.nthParallel(t);return a?(i+o.clipOffset(a)+n)/this.durationMilliseconds_Calculated()*100:-1},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=ReadiumSDK.DEBUG_MODE,this.getSmilBySpineItem=function(e){if(e)for(var t=0,n=this.smil_models.length;t<n;t++){var i=this.smil_models[t];if(i.spineItemId===e.idref)return e.media_overlay_id!==i.id&&console.error("SMIL INCORRECT ID?? "+e.media_overlay_id+" /// "+i.id),i}},this.getNextSmil=function(e){var t=this.smil_models.indexOf(e);if(-1!=t&&t!=this.smil_models.length-1)return this.smil_models[t+1]},this.getPreviousSmil=function(e){var t=this.smil_models.indexOf(e);if(-1!=t&&0!=t)return this.smil_models[t-1]}};return t.fromDTO=function(n,i){var r=new t(i);if(!n)return r;r.duration=n.duration,r.duration&&r.duration.length&&r.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+r.duration+")"),r.duration=parseFloat(r.duration)),r.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+r.duration),r.narrator=n.narrator,r.DEBUG&&console.debug("Media Overlay Narrator: "+r.narrator),r.activeClass=n.activeClass,r.DEBUG&&console.debug("Media Overlay Active-Class: "+r.activeClass),r.playbackActiveClass=n.playbackActiveClass,r.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+r.playbackActiveClass);var o=n.smil_models.length;r.DEBUG&&console.debug("Media Overlay SMIL count: "+o);for(var a=0;a<o;a++){var s=e.fromSmilDTO(n.smil_models[a],r);r.smil_models.push(s),r.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+s.duration)}o=n.skippables.length,r.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+o);for(var a=0;a<o;a++)r.skippables.push(n.skippables[a]);o=n.escapables.length,r.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+o);for(var a=0;a<o;a++)r.escapables.push(n.escapables[a]);return r},t}),define("readium_shared_js/models/package_data",[],function(){return{rootUrl:"",rootUrlMO:"",rendering_layout:"",spine:{direction:"ltr",items:[{href:"",idref:"",page_spread:"",rendering_layout:""}]}}}),define("readium_shared_js/models/package",["../helpers","./spine_item","./spine","./media_overlay","./package_data","URIjs"],function(e,t,n,i,r,o){return function(r){var a=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(t){var n=void 0;try{n=new o(t)}catch(e){console.error(e),console.log(t)}if(n&&n.is("absolute"))return t;if(a.rootUrlMO&&a.rootUrlMO.length>0){var i=a.rootUrlMO;try{i=new o(i).search("").hash("").toString()}catch(e){console.error(e),console.log(i)}return e.EndsWith(i,"/")?i+t:i+"/"+t}return a.resolveRelativeUrl(t)},this.resolveRelativeUrl=function(t){var n=void 0;try{n=new o(t)}catch(e){console.error(e),console.log(t)}if(n&&n.is("absolute"))return t;if(a.rootUrl){var i=a.rootUrl;try{i=new o(i).search("").hash("").toString()}catch(e){console.error(e),console.log(i)}return e.EndsWith(i,"/")?i+t:i+"/"+t}return t},this.isFixedLayout=function(){return a.rendition_layout===t.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!a.isFixedLayout()},r&&(this.rootUrl=r.rootUrl,this.rootUrlMO=r.rootUrlMO,this.rendition_viewport=r.rendition_viewport,this.rendition_layout=r.rendition_layout,this.rendition_flow=r.rendition_flow,this.rendition_orientation=r.rendition_orientation,this.rendition_spread=r.rendition_spread,this.spine=new n(this,r.spine),this.media_overlay=i.fromDTO(r.media_overlay,this))}}),define("readium_shared_js/models/metadata",[],function(){return function(e){this.identifier=void 0,this.title=void 0,this.author=void 0,this.description=void 0,this.publisher=void 0,this.language=void 0,this.rights=void 0,this.modifiedDate=void 0,this.publishedDate=void 0,this.epubVersion=void 0,e&&(this.identifier=e.id,this.title=e.title,this.author=e.author,this.description=e.description,this.language=e.language,this.publisher=e.publisher,this.rights=e.rights,this.modifiedDate=e.modified_date,this.publishedDate=e.pubdate,this.epubVersion=e.epub_version)}}),define("readium_shared_js/views/reflowable_view",["../globals","jquery","underscore","eventEmitter","../models/bookmark_data","./cfi_navigation_logic","../models/current_pages_info","../helpers","../models/page_open_request","../models/viewer_settings","ResizeSensor"],function(e,t,n,i,r,o,a,s,l,u,c){return function(f,d){function h(e){L.css("left",e.left+"px"),L.css("top",e.top+"px"),L.css("right",e.right+"px"),L.css("bottom",e.bottom+"px")}function p(){return{width:V[0].clientWidth,height:V[0].clientHeight}}function g(){return se.rightToLeft&&!se.isVerticalWritingMode?-se.pageOffset:se.pageOffset}function m(){var e=g();return se.isVerticalWritingMode?{top:e,left:0}:{top:0,left:e}}function v(){L&&L.remove();var e=s.loadTemplate("reflowable_book_page_frame",{}),n=t(e);n=k.append(n),L=t("#reflowable-content-frame",n),V=t("#epubContentIframe",n),V.css("left",""),V.css("right",""),V.css("position","relative"),V.css("overflow","hidden"),j=new o({$iframe:V,frameDimensionsGetter:p,paginationInfo:se,paginationOffsetsGetter:m,classBlacklist:te,elementBlacklist:ne,idBlacklist:ie})}function y(t){if(M!=t){v(),M&&(e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","reflowable_view.js [ "+M.href+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,V,M)),z.resetCurrentPosition(),se.pageOffset=0,se.currentSpreadIndex=0,se.currentPageIndex=0,M=t,M.paginationInfo=se,$=!0;var n=J.package.resolveRelativeUrl(t.href);e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","reflowable_view.js [ "+t.href+" -- "+n+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,V,t),V.css("opacity","0.01"),K.loadIframe(V[0],n,I,z,{spineItem:t})}}function E(){if(U){var e=Q,t=!d.fonts||!d.fonts.length||e<=0||e-1>=d.fonts.length,n=t?{}:d.fonts[e-1];s.UpdateHtmlFontAttributes(U,Z,n,function(){z.applyStyles()})}}function b(){U&&U.css("column-gap",se.columnGap+"px")}function I(n){if($=!1,F&&F.spineItem!=M)return void y(F.spineItem);if(!n)return V.css("opacity","1"),void(F=void 0);e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","reflowable_view.js [ "+M.href+" ]"),z.emit(e.Events.CONTENT_DOCUMENT_LOADED,V,M);var i=V[0].contentDocument;U=t("html",i),B=t("body",U),G=!1,W=!0,H=void 0;var r=V[0].contentDocument.defaultView||V[0].contentWindow,o=r.getComputedStyle(B[0],null);if(o){W="ltr"===o.direction;var a=void 0;a=o.getPropertyValue?o.getPropertyValue("-webkit-writing-mode")||o.getPropertyValue("-moz-writing-mode")||o.getPropertyValue("-ms-writing-mode")||o.getPropertyValue("-o-writing-mode")||o.getPropertyValue("-epub-writing-mode")||o.getPropertyValue("writing-mode"):o.webkitWritingMode||o.mozWritingMode||o.msWritingMode||o.oWritingMode||o.epubWritingMode||o.writingMode,a&&(H=a.indexOf("-lr")>=0,(a.indexOf("vertical")>=0||a.indexOf("tb-")>=0||a.indexOf("bt-")>=0)&&(G=!0))}W&&("rtl"!==B[0].getAttribute("dir")&&"rtl"!==U[0].getAttribute("dir")||(W=!1)),J.isLeftToRight()||!W||G||(B[0].setAttribute("dir","rtl"),W=!1,H=!1),se.isVerticalWritingMode=G,N(),V.css("opacity","1"),S(),U.css("height",oe.height+"px"),U.css("position","relative"),U.css("margin","0"),U.css("padding","0"),U.css("column-axis",G?"vertical":"horizontal"),z.applyBookStyles(),x(),b(),E()}function T(){if(F){var e=F;F=void 0,z.openPage(e)}}function w(e){if($)return F=e,!1;if(e.spineItem&&e.spineItem!=M)return F=e,y(e.spineItem),!0;var t=void 0;if(void 0!==e.spineItemPageIndex)t=e.spineItemPageIndex;else if(e.elementId)t=se.currentPageIndex+j.getPageIndexDeltaForElementId(e.elementId);else if(e.firstVisibleCfi&&e.lastVisibleCfi){var n,i;try{n=j.getPageIndexDeltaForCfi(e.firstVisibleCfi,te,ne,ie)}catch(e){n=0,console.error(e)}try{i=j.getPageIndexDeltaForCfi(e.lastVisibleCfi,te,ne,ie)}catch(e){i=0,console.error(e)}t=se.currentPageIndex+Math.round((n+i)/2)}else if(e.elementCfi)try{t=se.currentPageIndex+j.getPageIndexDeltaForCfi(e.elementCfi,te,ne,ie)}catch(e){t=0,console.error(e)}else e.firstPage?t=0:e.lastPage?t=se.columnCount-1:(console.debug("No criteria in pageRequest"),t=0);return(t<0||t>se.columnCount)&&(console.log("Illegal pageIndex value: ",t,"column count is ",se.columnCount),t=t<0?0:se.columnCount),se.currentPageIndex=t,se.currentSpreadIndex=Math.floor(t/se.visibleColumnCount),ue(e.initiator,e.spineItem,e.elementId),!0}function _(){var e=-se.pageOffset+"px";if(G)U.css("top",e);else{var t=W||H;U.css("left",t?e:""),U.css("right",t?"":e)}R()}function S(){var e=L.width();e-=e%2;var t=L.height();return(oe.width!==e||oe.height!==t)&&(oe.width=e,oe.height=t,!0)}function O(t,i,r){se.currentPageIndex=se.currentSpreadIndex*se.visibleColumnCount,se.pageOffset=(se.columnWidth+se.columnGap)*se.visibleColumnCount*se.currentSpreadIndex,_(),n.defer(function(){void 0==ee&&z.saveCurrentPosition(),e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","EMIT","reflowable_view.js"),z.emit(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:z.getPaginationInfo(),initiator:t,spineItem:i,elementId:r})})}function C(){var e=se.columnMaxWidth,t=se.columnMinWidth,n=s.deduceSyntheticSpread(q,M,le),i=!1===n||!0===n;if(0===n&&(n=1),se.visibleColumnCount=n?2:1,G&&(e*=2,n=!1,i=!0,se.visibleColumnCount=1),U){N();var r=parseInt(q.css("border-left-width")),o=se.columnGap/2;o=Math.max(0,o-r);var a=parseInt(q.css("border-right-width")),l=se.columnGap/2;l=Math.max(0,l-a);var u=q.width(),c=u-o-l;n&&(c=.5*(c-se.columnGap));var f=0;if(c>e){var d=c-e;f=Math.floor(d*(n?1:.5))}else!i&&c<t&&n&&(n=!1,se.visibleColumnCount=1,(c=u-o-l)>e&&(f=Math.floor(.5*(c-e))));k.css({left:f+o+"px",right:f+l+"px"}),S();var h=k.width();n&&(h=(h-se.columnGap)/2),h=Math.floor(h),h-1>e&&console.debug("resultingColumnWidth > MAXW ! "+h+" > "+e),V.css("width",oe.width+"px"),V.css("height",oe.height+"px"),U.css("height",oe.height+"px"),U.css("min-height",oe.height+"px"),U.css("max-height",oe.height+"px"),U.css("margin",0),U.css("padding",0),U.css("border",0),B.css("position","relative"),B.css("margin",0),B.css("padding",0),se.rightToLeft=J.isRightToLeft(),se.columnWidth=Math.round(((G?oe.height:oe.width)-se.columnGap*(se.visibleColumnCount-1))/se.visibleColumnCount);se.visibleColumnCount>1?(U.css("width",oe.width+"px"),U.css("column-width","auto"),U.css("column-count",se.visibleColumnCount)):(U.css("width",(G?oe.width:se.columnWidth)+"px"),U.css("column-count","auto"),U.css("column-width",se.columnWidth+"px")),U.css("column-fill","auto"),U.css({left:"0",right:"0",top:"0"}),s.triggerLayout(V);var p=G?U[0].scrollHeight:U[0].scrollWidth;0==p&&console.error("Document dimensions zero?!"),se.columnCount=(p+se.columnGap)/(se.columnWidth+se.columnGap),se.columnCount=Math.round(se.columnCount),0==se.columnCount&&console.error("Column count zero?!");var g=(se.columnCount-1)*se.columnGap,m=(p-g)/se.columnCount;m=Math.round(m),m>se.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(se.columnWidth),console.log(m),se.columnWidth=m),se.spreadCount=Math.ceil(se.columnCount/se.visibleColumnCount),se.currentSpreadIndex>=se.spreadCount&&(se.currentSpreadIndex=se.spreadCount-1),F?T():ee?(se.currentPageIndex=0,z.restoreCurrentPosition()):ue(z,M),P()}}function P(){var e=B[0];e.resizeSensor||(ae.width=t(e).width(),ae.height=t(e).height(),e.resizeSensor=new c(e,function(){var n={width:t(e).width(),height:t(e).height()};console.debug("ReflowableView content resized ...",n.width,n.height,M.idref),n.width!=ae.width||n.height!=ae.height?(ae.width=n.width,ae.height=n.height,console.debug("... updating pagination."),ce()):console.debug("... ignored (identical dimensions).")}))}function N(){-1==re&&(re=U[0].style.opacity,U.css("opacity","0"))}function R(){-1!=re&&U.css("opacity",re),re=-1}function D(){for(var e=[],t=se.currentSpreadIndex*se.visibleColumnCount,n=0;n<se.visibleColumnCount&&t+n<se.columnCount;n++)e.push(t+n);return e}function x(){if(U){var e;t("img, svg",U).each(function(){e=t(this),e.css("max-width","98%"),e.css("max-height","98%"),e.css("height")||e.css("height","auto"),e.css("width")||e.css("width","auto")})}}function A(e){return new r(M.idref,e)}t.extend(this,new i);var M,F,L,j,k,V,U,B,G,W,H,z=this,q=t(f.$viewport),J=f.spine,X=f.userStyles,Y=f.bookStyles,K=f.iframeLoader,$=!1,Z=100,Q=0,ee=void 0,te=["cfi-marker","mo-cfi-highlight","resize-sensor","resize-sensor-expand","resize-sensor-shrink","resize-sensor-inner","js-hypothesis-config","js-hypothesis-embed"],ne=["hypothesis-adder"],ie=["MathJax_Message","MathJax_SVG_Hidden"],re=-1,oe={width:void 0,height:void 0},ae={width:void 0,height:void 0},se={visibleColumnCount:2,columnGap:20,columnMaxWidth:550,columnMinWidth:400,spreadCount:0,currentSpreadIndex:0,currentPageIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var e=s.loadTemplate("reflowable_book_frame",{});k=t(e),q.append(k);var n=d.viewerSettings();return n&&void 0!==n.enableGPUHardwareAccelerationCSS3D||(n=new u({})),n.enableGPUHardwareAccelerationCSS3D&&k.css("transform","translateZ(0)"),v(),z},this.remove=function(){k.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){S()&&ce()};var le=void 0;this.setViewSettings=function(e,t){le=e,se.columnGap=e.columnGap,
se.columnMaxWidth=e.columnMaxWidth,se.columnMinWidth=e.columnMinWidth,Z=e.fontSize,Q=e.fontSelection,S(),t||(b(),E())},this.applyStyles=function(){s.setStyles(X.getStyles(),k.parent()),h(s.Margins.fromElement(k).padding),S(),ce()},this.applyBookStyles=function(){U&&s.setStyles(Y.getStyles(),V[0].contentDocument)},this.openPage=function(e){w(e),ee=e},this.resetCurrentPosition=function(){ee=void 0},this.saveCurrentPosition=function(){if(!F){var e=z.getFirstVisibleCfi(),t=z.getLastVisibleCfi();ee=new l(M,z),ee.setFirstAndLastVisibleCfi(e.contentCFI,t.contentCFI)}},this.restoreCurrentPosition=function(){ee&&w(ee)};var ue=n.debounce(O,100);this.openPagePrev=function(e){if(M)if(se.currentSpreadIndex>0)this.resetCurrentPosition(),se.currentSpreadIndex--,ue(e,M);else{var t=J.prevItem(M,!0);if(t){var n=new l(t,e);n.setLastPage(),z.openPage(n)}}},this.openPageNext=function(e){if(M)if(se.currentSpreadIndex<se.spreadCount-1)this.resetCurrentPosition(),se.currentSpreadIndex++,ue(e,M);else{var t=J.nextItem(M,!0);if(t){var n=new l(t,e);n.setFirstPage(),z.openPage(n)}}};var ce=n.debounce(C,100);this.getPaginationInfo=function(){var e=new a(J,!1);if(!M)return e;for(var t=D(),n=0,i=t.length;n<i;n++)e.addOpenPage(t[n],se.columnCount,M.idref,M.index);return e},this.bookmarkCurrentPage=function(){if(M)return z.getFirstVisibleCfi()},this.getLoadedSpineItems=function(){return[M]},this.getElementByCfi=function(e,t,n,i,r){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElementByCfi(t,n,i,r)},this.getElementById=function(e,t){return e!=M.idref?void console.error("spine item is not loaded"):j.getElementById(t)},this.getElement=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){return j.getFirstVisibleMediaOverlayElement()},this.insureElementVisibility=function(e,n,i){var r=t(n);if(!j.isElementVisible(r)){var o=j.getCfiForElement(n);if(o){var a=new l(M,i);a.setElementCfi(o);var s=n.id;s||(s=n.getAttribute("id")),s&&a.setElementId(s),z.openPage(a)}}},this.getVisibleElementsWithFilter=function(e,t){var n=j.getVisibleElementsWithFilter(null,e);return t?[{elements:n,spineItem:M}]:n},this.getVisibleElements=function(e,t){var n=j.getAllVisibleElementsWithSelector(e);return t?[{elements:n,spineItem:M}]:n},this.isElementVisible=function(e){return j.isElementVisible(e)},this.getElements=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getElements(t)},this.isNodeFromRangeCfiVisible=function(e,t){if(M.idref===e)return j.isNodeFromRangeCfiVisible(t)},this.isVisibleSpineItemElementCfi=function(e,t){if(j.isRangeCfi(t))return this.isNodeFromRangeCfiVisible(e,t);var n=this.getElementByCfi(e,t);return n&&this.isElementVisible(n)},this.getNodeRangeInfoFromCfi=function(e,t){return e!=M.idref?void console.warn("spine item is not loaded"):j.getNodeRangeInfoFromCfi(t)},this.getFirstVisibleCfi=function(){return A(j.getFirstVisibleCfi())},this.getLastVisibleCfi=function(){return A(j.getLastVisibleCfi())},this.getStartCfi=function(){return A(j.getStartCfi())},this.getEndCfi=function(){return A(j.getEndCfi())},this.getDomRangeFromRangeCfi=function(e,t,n){return t&&e.idref!==t.idref?void console.error("getDomRangeFromRangeCfi: both CFIs must be scoped under the same spineitem idref"):j.getDomRangeFromRangeCfi(e.contentCFI,t?t.contentCFI:null,n)},this.getRangeCfiFromDomRange=function(e){return A(j.getRangeCfiFromDomRange(e))},this.getVisibleCfiFromPoint=function(e,t,n){return A(j.getVisibleCfiFromPoint(e,t,n))},this.getRangeCfiFromPoints=function(e,t,n,i){return A(j.getRangeCfiFromPoints(e,t,n,i))},this.getCfiForElement=function(e){return A(j.getCfiForElement(e))},this.getElementFromPoint=function(e,t){return j.getElementFromPoint(e,t)},this.getNearestCfiFromElement=function(e){return A(j.getNearestCfiFromElement(e))}}}),define("readium_shared_js/models/style",[],function(){return function(e,t){this.selector=e,this.declarations=t,this.setDeclarations=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.declarations[t]=e[t])}}}),define("readium_shared_js/models/style_collection",["./style"],function(e){return function(){var t=[];this.clear=function(){t.length=0},this.findStyle=function(e){for(var n=t.length,i=0;i<n;i++)if(t[i].selector===e)return t[i]},this.addStyle=function(n,i){var r=this.findStyle(n);return r?r.setDeclarations(i):(r=new e(n,i),t.push(r)),r},this.removeStyle=function(e){for(var n=t.length,i=0;i<n;i++)if(t[i].selector===e)return void t.splice(i,1)},this.getStyles=function(){return t},this.resetStyleValues=function(){for(var e=t.length,n=0;n<e;n++){var i=t[n],r=i.declarations;for(var o in r)r.hasOwnProperty(o)&&(r[o]="")}}}}),define("readium_shared_js/models/switches",["jquery","underscore"],function(e,t){var n=function(){};return n.apply=function(n){function i(e){var n=e.attributes["required-namespace"];if(!n)return console.log("Encountered a case statement with no required-namespace"),!1;var i=["http://www.w3.org/1998/Math/MathML"];return t.include(i,n.value)}var r=window.navigator.userAgent.indexOf("Trident")>0||window.navigator.userAgent.indexOf("Edge")>0?function(e){return"epub\\:"+e}:function(e){return e};t.each(n.querySelectorAll(r("switch")),function(n){var o=!1;t.each(n.querySelectorAll(r("case")),function(t){!o&&i(t)?o=!0:e(t).remove()}),o&&t.each(n.querySelectorAll(r("default")),function(t){e(t).remove()})})},n}),define("readium_shared_js/models/trigger",["jquery","../helpers"],function(e,t){var n=function(t){var n=e(t);this.action=n.attr("action"),this.ref=n.attr("ref"),this.event=n.attr("ev:event"),this.observer=n.attr("ev:observer"),this.ref=n.attr("ref")};return n.register=function(t){e("trigger",t).each(function(){new n(this).subscribe(t)})},n.prototype.subscribe=function(t){var n="#"+this.observer,i=this;e(n,t).on(this.event,function(){return i.execute(t)})},n.prototype.execute=function(n){var i=e("#"+t.escapeJQuerySelector(this.ref),n);switch(this.action){case"show":i.css("visibility","visible");break;case"hide":i.css("visibility","hidden");break;case"play":i[0].currentTime=0,i[0].play();break;case"pause":i[0].pause();break;case"resume":i[0].play();break;case"mute":i[0].muted=!0;break;case"unmute":i[0].muted=!1;break;default:return console.log("do not no how to handle trigger "+this.action),null}return!1},n}),define("readium_shared_js/models/node_range_info",[],function(){var e=function(e,t){this.node=e,this.offset=t};return function(t,n,i){var r=this;this.clientRect=t,this.startInfo=n,this.endInfo=i,this.setStartInfo=function(t){return r.startInfo=new e(t),r},this.setEndInfo=function(t){return r.endInfo=new e(t),r}}}),define("readium_shared_js/views/external_agent_support",["../globals","underscore"],function(e,t){return function(n){function i(e,t,n){var i=e.createElement("meta");i.setAttribute("name",t),i.setAttribute("content",n),e.head.appendChild(i)}function r(e,t){var r=n.metadata().identifier,o=t.idref;r&&o&&(i(e,"dc.relation.ispartof",r),i(e,"dc.identifier",o))}function o(e){if(-1!==Object.keys(e).indexOf("document")&&e.location.search.match(/goto=.*cfi/i))return e.location.href.split("#")[0]}function a(e){var t=e.defaultView;if(t&&(t.parent||t.top)){var n=o(t.parent);return o(t.top)||n}}function s(e,t){if(e.defaultView&&e.defaultView.parent){var n=a(e);if(n){var i=e.createElement("link");i.setAttribute("rel","canonical"),i.setAttribute("href",n),e.head.appendChild(i),c[t.idref].canonicalLinkElement=i}}}function l(e){e.addEventListener("scrolltorange",function(e){e.preventDefault();var t=e.detail;d(t)})}function u(e){e.addEventListener("selectionchange",function(){var t=e.getSelection();t&&t.isCollapsed?e.body.style.position="relative":e.body.style.position=""})}var c={},f={};e.on(e.Events.PLUGINS_LOADED,function(){window.define&&window.define.amd&&delete window.define.amd});var d=t.debounce(function(e){var t=n.getRangeCfiFromDomRange(e),i=c[t.idref];i&&i.isUpdated?n.openSpineItemElementCfi(t.idref,t.contentCFI):i.pendingNavRequest={idref:t.idref,contentCFI:t.contentCFI}},100);this.bindToContentDocument=function(e,t){f[t.idref]=e,c[t.idref]={},r(e,t),s(e,t),l(e),t.isReflowable()&&u(e)},this.updateContentDocument=function(e){var t=f[e.idref],i=c[e.idref];if(t&&i){if(i.canonicalLinkElement){var r=a(t);r&&i.canonicalLinkElement.setAttribute("href",r)}i.isUpdated=!0;var o=i.pendingNavRequest;o&&(n.openSpineItemElementCfi(o.idref,o.contentCFI),i.pendingNavRequest=null)}}}}),define("readium_shared_js/views/reader_view",["../globals","jquery","underscore","eventEmitter","./fixed_view","../helpers","./iframe_loader","./internal_links_support","./media_overlay_data_injector","./media_overlay_player","../models/package","../models/metadata","../models/page_open_request","./reflowable_view","./scroll_view","../models/style_collection","../models/switches","../models/trigger","../models/viewer_settings","../models/bookmark_data","../models/node_range_info","./external_agent_support"],function(e,t,n,i,r,o,a,s,l,u,c,f,d,h,p,g,m,v,y,E,b,I){var T=function(w){function _(e){return"scroll-doc"==W.scroll?T.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==W.scroll?T.VIEW_TYPE_SCROLLED_CONTINUOUS:e.isFixedLayout()?T.VIEW_TYPE_FIXED:e.isFlowScrolledDoc()?T.VIEW_TYPE_SCROLLED_DOC:e.isFlowScrolledContinuous()?T.VIEW_TYPE_SCROLLED_CONTINUOUS:T.VIEW_TYPE_COLUMNIZED}function S(t,i){var r=_(t);if(V){if(k.getCurrentViewType()==r)return void i(!1);O()}var a={$viewport:j,spine:G,userStyles:H,bookStyles:z,iframeLoader:L};V=k.createViewForType(r,a),e.logEvent("READER_VIEW_CREATED","EMIT","reader_view.js"),k.emit(e.Events.READER_VIEW_CREATED,r),V.on(e.Events.CONTENT_DOCUMENT_LOADED,function(t,n){var i=t[0].contentDocument;e.logEvent("CONTENT_DOCUMENT_LOADED","ON","reader_view.js (current view) [ "+n.href+" ]"),o.isIframeAlive(t[0])&&(F.attachMediaOverlayData(t,n,W),q.processLinkElements(t,n),J.bindToContentDocument(i,n),v.register(i),m.apply(i),e.logEvent("CONTENT_DOCUMENT_LOADED","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_LOADED,t,n))}),V.on(e.Events.CONTENT_DOCUMENT_LOAD_START,function(t,n){e.logEvent("CONTENT_DOCUMENT_LOAD_START","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_LOAD_START,t,n)}),V.on(e.Events.CONTENT_DOCUMENT_UNLOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_UNLOADED","EMIT","reader_view.js [ "+n.href+" ]"),k.emit(e.Events.CONTENT_DOCUMENT_UNLOADED,t,n)}),V.on(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(t){e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","ON","reader_view.js"),M.onPageChanged(t),n.defer(function(){e.logEvent("PAGINATION_CHANGED","EMIT","reader_view.js"),k.emit(e.Events.PAGINATION_CHANGED,t),t.spineItem&&n.defer(function(){J.updateContentDocument(t.spineItem)})})}),V.on(e.Events.FXL_VIEW_RESIZED,function(){e.logEvent("FXL_VIEW_RESIZED","EMIT","reader_view.js"),k.emit(e.Events.FXL_VIEW_RESIZED)}),V.render();V.setViewSettings(W,!0),setTimeout(function(){i(!0)},50)}function O(){V&&(e.logEvent("READER_VIEW_DESTROYED","EMIT","reader_view.js"),k.emit(e.Events.READER_VIEW_DESTROYED),e.logEvent("InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED","OFF","reader_view.js"),V.off(e.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),V.remove(),V=void 0)}function C(t){e.logEvent("MEDIA_OVERLAY_STATUS_CHANGED","EMIT","reader_view.js (via MediaOverlayPlayer + AudioPlayer)"),k.emit(e.Events.MEDIA_OVERLAY_STATUS_CHANGED,t)}function P(e){if(!e)return void console.log("idref parameter value missing!");var t=G.getItemById(e);return t||void console.log("Spine item with id "+e+" not found!")}function N(e,t){S(e.spineItem,function(n){if(!n){V.setViewSettings(W,!0)}V.openPage(e,t)})}function R(e){o.setStyles(H.getStyles(),j),M&&M.applyStyles(),e||V&&V.applyStyles()}function D(){Y=null,K=!1,V&&(V.isReflowable&&V.isReflowable()&&(K=k.isPlayingMediaOverlay())&&k.pauseMediaOverlay(),Y=V.bookmarkCurrentPage())}function x(){V&&k.handleViewportResize(Y)}function A(){x(),K&&k.playMediaOverlay()}t.extend(this,new i);var M,F,L,j,k=this,V=void 0,U=void 0,B=void 0,G=void 0,W=new y({}),H=new g,z=new g,q=new s(this),J=new I(this),X=o.extendedThrottle(D,x,A,250,1e3,k);t(window).on("resize.ReadiumSDK.readerView",X),this.fonts=w.fonts,w.el instanceof t?(j=w.el,console.log("** EL is a jQuery selector:"+w.el.attr("id"))):(j=t(w.el),console.log("** EL is a string:"+j.attr("id"))),L=w.iframeLoader?w.iframeLoader:new a({mathJaxUrl:w.mathJaxUrl}),_needsFixedLayoutScalerWorkAround=w.needsFixedLayoutScalerWorkAround,this.needsFixedLayoutScalerWorkAround=function(){return _needsFixedLayoutScalerWorkAround},this.createViewForType=function(e,t){var n;switch(j.css("overflow","hidden"),e){case T.VIEW_TYPE_FIXED:j.css("overflow","auto"),n=new r(t,k);break;case T.VIEW_TYPE_SCROLLED_DOC:n=new p(t,!1,k);break;case T.VIEW_TYPE_SCROLLED_CONTINUOUS:n=new p(t,!0,k);break;default:n=new h(t,k)}return n},this.getCurrentViewType=function(){if(V)return V instanceof h?T.VIEW_TYPE_COLUMNIZED:V instanceof r?T.VIEW_TYPE_FIXED:V instanceof p?V.isContinuousScroll()?T.VIEW_TYPE_SCROLLED_CONTINUOUS:T.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type")},this.getCurrentView=function(){return V},this.getLoadedSpineItems=function(){return V?V.getLoadedSpineItems():[]},this.viewerSettings=function(){return W},this.package=function(){return U},this.metadata=function(){return B},this.spine=function(){return G},this.userStyles=function(){return H},this.openBook=function(e){var n=e.package?e.package:e;U=new c(n),B=new f(n.metadata),G=U.spine,G.handleLinear(!0),M&&M.reset(),M=new u(k,t.proxy(C,k)),M.setAutomaticNextSmil(!!W.mediaOverlaysAutomaticPageTurn),F=new l(U.media_overlay,M),O(),e.settings&&k.updateSettings(e.settings),e.styles&&k.setStyles(e.styles);var i=void 0;e.openPageRequest&&"function"==typeof e.openPageRequest&&(e.openPageRequest=e.openPageRequest()),e.openPageRequest&&(e.openPageRequest.idref||e.openPageRequest.contentRefUrl&&e.openPageRequest.sourceFileHref?i=e.openPageRequest:console.log("Invalid page request data: idref required!"));var r=!1;if(i){i=e.openPageRequest;try{r=i.idref?i.spineItemPageIndex?!k.openSpineItemPage(i.idref,i.spineItemPageIndex,k):i.elementCfi?!k.openSpineItemElementCfi(i.idref,i.elementCfi,k):!k.openSpineItemPage(i.idref,0,k):!k.openContentUrl(i.contentRefUrl,i.sourceFileHref,k)}catch(e){console.error("openPageRequest fail: fallback to first page!"),console.log(e),r=!0}}else r=!0;if(r){var o=G.first();if(o){var a=new d(o,k);a.setFirstPage(),N(a,0)}}},this.openPageLeft=function(){U.spine.isLeftToRight()?k.openPagePrev():k.openPageNext()},this.openPageRight=function(){U.spine.isLeftToRight()?k.openPageNext():k.openPagePrev()},this.isCurrentViewFixedLayout=function(){return V instanceof r},this.setZoom=function(e){k.isCurrentViewFixedLayout()&&V.setZoom(e)},this.getViewScale=function(){return k.isCurrentViewFixedLayout()?100*V.getViewScale():100},this.updateSettings=function(t){if(W.update(t),M&&M.setAutomaticNextSmil(!!W.mediaOverlaysAutomaticPageTurn),V&&!t.doNotUpdateView){var n=V.bookmarkCurrentPage();if(n&&n.idref){var i=!1;V.isReflowable&&V.isReflowable()&&(i=k.isPlayingMediaOverlay())&&k.pauseMediaOverlay();return void S(G.getItemById(n.idref),function(t){if(!t){V.setViewSettings(W,!1)}k.once(ReadiumSDK.Events.PAGINATION_CHANGED,function(e){var t=new E(n.idref,n.contentCFI);k.debugBookmarkData(t)}),k.openSpineItemElementCfi(n.idref,n.contentCFI,k),i&&k.playMediaOverlay(),e.logEvent("SETTINGS_APPLIED 1 (view update)","EMIT","reader_view.js"),k.emit(e.Events.SETTINGS_APPLIED)})}}e.logEvent("SETTINGS_APPLIED 2 (no view update)","EMIT","reader_view.js"),k.emit(e.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(k.getCurrentViewType()===T.VIEW_TYPE_SCROLLED_CONTINUOUS)return void V.openPageNext(k);var e=V.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[e.openPages.length-1];if(t.spineItemPageIndex<t.spineItemPageCount-1)return void V.openPageNext(k);var n=G.getItemById(t.idref),i=G.nextItem(n);if(i){var r=new d(i,k);r.setFirstPage(),N(r,2)}}},this.openPagePrev=function(){if(k.getCurrentViewType()===T.VIEW_TYPE_SCROLLED_CONTINUOUS)return void V.openPagePrev(k);var e=V.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[0];if(t.spineItemPageIndex>0)return void V.openPagePrev(k);var n=G.getItemById(t.idref),i=G.prevItem(n);if(i){var r=new d(i,k);r.setLastPage(),N(r,1)}}},this.openSpineItemElementCfi=function(e,t,n){var i=P(e);if(!i)return!1;var r=new d(i,n);return t&&r.setElementCfi(t),N(r,0),!0},this.openPageIndex=function(e,t){if(!V)return!1;var n;if(U.isFixedLayout()){var i=G.items[e];if(!i)return!1;n=new d(i,t),n.setPageIndex(0)}else{var r=this.getLoadedSpineItems();r.length>0&&(n=new d(r[0],t),n.setPageIndex(e))}return N(n,0),!0},this.openSpineItemPage=function(e,t,n){var i=P(e);if(!i)return!1;var r=new d(i,n);return t&&r.setPageIndex(t),N(r,0),!0},this.setStyles=function(e,t){for(var n=e.length,i=0;i<n;i++)e[i].declarations?H.addStyle(e[i].selector,e[i].declarations):H.removeStyle(e[i].selector);R(t)},this.setBookStyles=function(e){for(var t=e.length,n=0;n<t;n++)e[n].declarations?z.addStyle(e[n].selector,e[n].declarations):z.removeStyle(e[n].selector);V&&V.applyBookStyles()},this.getElement=function(e,t){if(V)return V.getElement(e,t)},this.getElementById=function(e,t){if(V)return V.getElementById(e,t)},this.getElementByCfi=function(e,t,n,i,r){if(V)return V.getElementByCfi(e,t,n,i,r)},this.mediaOverlaysOpenContentUrl=function(e,t,n){M.mediaOverlaysOpenContentUrl(e,t,n)},this.openContentUrl=function(e,t,n){var i,r,a=o.ResolveContentRef(e,t),s=a.indexOf("#");s>=0?(i=a.substr(0,s),r=a.substr(s+1)):(i=a,r=void 0);var l=G.getItemByHref(i);if(!l){console.warn("spineItem "+i+" not found");var u=decodeURIComponent(i);if(!(l=G.getItemByHref(u)))return console.warn("decoded spineItem "+u+" missing as well"),!1}return k.openSpineItemElementId(l.idref,r,n)},this.openSpineItemElementId=function(e,t,n){var i=G.getItemById(e);if(!i)return!1;var r=new d(i,n);return t&&r.setElementId(t),N(r,0),!0},this.debugBookmarkData=function(e){if(ReadiumSDK){if(ReadiumSDK.DEBUG_MODE){var t=this.getPaginationInfo();if(console.log(JSON.stringify(t)),!t.isFixedLayout){try{ReadiumSDK._DEBUG_CfiNavigationLogic.clearDebugOverlays()}catch(e){}try{console.log(e);var n=this.getDomRangeFromRangeCfi(e);console.log(n);var i=ReadiumSDK._DEBUG_CfiNavigationLogic.drawDebugOverlayFromDomRange(n);console.log(i);var r=ReadiumSDK.reader.getFirstVisibleCfi();console.log(r);var o=ReadiumSDK.reader.getLastVisibleCfi();console.log(o)}catch(e){}setTimeout(function(){try{ReadiumSDK._DEBUG_CfiNavigationLogic.clearDebugOverlays()}catch(e){}},2e3)}}}},this.bookmarkCurrentPage=function(){var e=V.bookmarkCurrentPage();return e?e.toString():null},this.clearStyles=function(){H.resetStyleValues(),R(),H.clear()},this.clearBookStyles=function(){V&&(z.resetStyleValues(),V.applyBookStyles()),z.clear()},this.isMediaOverlayAvailable=function(){return!!M&&M.isMediaOverlayAvailable()},this.toggleMediaOverlay=function(){M.toggleMediaOverlay()},this.nextMediaOverlay=function(){M.nextMediaOverlay()},this.previousMediaOverlay=function(){M.previousMediaOverlay()},this.escapeMediaOverlay=function(){M.escape()},this.ttsEndedMediaOverlay=function(){M.onTTSEnd()},this.pauseMediaOverlay=function(){M.pause()},this.playMediaOverlay=function(){M.play()},this.isPlayingMediaOverlay=function(){return M.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){if(V)return V.getFirstVisibleMediaOverlayElement()},this.insureElementVisibility=function(e,t,n){V&&V.insureElementVisibility(e,t,n)};var Y=null,K=!1;this.handleViewportResize=function(e){V&&V.onViewportResize()},this.addIFrameEventListener=function(e,t,n){L.addIFrameEventListener(e,t,n)};var $=function(n){var i={},r=!1,o=void 0;this.setCallback_PlayPause=function(e){o=e};var a=void 0;this.setCallback_IsAvailable=function(e){a=e},this.playPause=function(e){s(e)};var s=function(e){o&&o(e);try{var n=void 0;for(var r in i)if(i.hasOwnProperty(r)){var a=i[r];if(a&&a.active&&(n&&console.error("More than one active iframe?? (pagination)"),n=a.$iframe)){var s=t("audio",n[0].contentDocument);t.each(s,function(){var t=this.getAttribute("epub:type")||this.getAttribute("type");return!t||(t.indexOf("ibooks:soundtrack")<0&&t.indexOf("media:soundtrack")<0&&t.indexOf("media:background")<0||(e&&this.play?this.play():this.pause&&this.pause(),!0))})}}}catch(e){console.error(e)}};this.setPlayState=function(e){r=e},n.on(e.Events.CONTENT_DOCUMENT_LOADED,function(t,n){e.logEvent("CONTENT_DOCUMENT_LOADED","ON","reader_view.js (via BackgroundAudioTrackManager) [ "+n.href+" ]");try{n&&n.idref&&t&&t[0]&&(i[n.idref]={$iframe:t,href:n.href})}catch(e){console.error(e)}}),n.on(e.Events.PAGINATION_CHANGED,function(n){e.logEvent("PAGINATION_CHANGED","ON","reader_view.js (via BackgroundAudioTrackManager)");var o=!1;try{for(var l in i)if(i.hasOwnProperty(l)){var u=n.spineItem&&n.spineItem.idref===l,c=!1;if(n.paginationInfo&&n.paginationInfo.openPages.length){for(var f=!0,d=0;d<n.paginationInfo.openPages.length;d++)n.paginationInfo.openPages[d].idref===l?c=!0:f=!1;!u&&f&&(u=!0)}if(u||c){var h=i[l];if(!h)continue;i[l].active=u;var p=h.$iframe,g=(h.href,t("audio",p[0].contentDocument));t.each(g,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return!e||(e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0||(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),u||this.pause&&this.pause(),o=!0,!0))})}else i[l]&&(i[l].$iframe=void 0),i[l]=void 0}}catch(e){console.error(e)}a&&a(o),s(o?r?!0:!1:!1)}),n.on(e.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(t){if(e.logEvent("MEDIA_OVERLAY_STATUS_CHANGED","ON","reader_view.js (via BackgroundAudioTrackManager)"),t.smilIndex){var o=n.package(),a=o.media_overlay.smilAt(t.smilIndex);if(a&&a.spineItemId){var l=!1;for(var u in i)if(i.hasOwnProperty(u)){var c=i[u];c&&c.active&&u!==a.spineItemId&&(s(!1),c.active=!1,l=!0)}if(l){for(var u in i)if(i.hasOwnProperty(u)){var c=i[u];c&&(c.active||u===a.spineItemId&&(c.active=!0))}r&&s(!0)}}}})};this.backgroundAudioTrackManager=new $(k),this.isVisibleSpineItemElementCfi=function(e,t){if(!P(e))return!1;if(V){if(!t||t&&""===t)for(var n=V.getLoadedSpineItems(),i=0,r=n.length;i<r;i++)if(n[i].idref==e)return!0;return V.isVisibleSpineItemElementCfi(e,t)}return!1},this.getElements=function(e,t){if(V)return V.getElements(e,t)},this.isElementVisible=function(e){return V.isElementVisible(t(e))},this.getNodeRangeInfoFromCfi=function(e,t){if(V&&e&&t){var n=V.getNodeRangeInfoFromCfi(e,t);if(n)return new b(n.clientRect).setStartInfo(n.startInfo).setEndInfo(n.endInfo)}},this.getPaginationInfo=function(){return V.getPaginationInfo()},this.getFirstVisibleCfi=function(){if(V)return V.getFirstVisibleCfi()},this.getLastVisibleCfi=function(){if(V)return V.getLastVisibleCfi()},this.getStartCfi=function(){if(V)return V.getStartCfi()},this.getEndCfi=function(){if(V)return V.getEndCfi()},this.getDomRangesFromRangeCfi=function(e,t,n){if(V)return V.getDomRangesFromRangeCfi?V.getDomRangesFromRangeCfi(e,t,n):[V.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangesFromRangeCfi=function(e,t,n){if(V)return V.getDomRangesFromRangeCfi?V.getDomRangesFromRangeCfi(e,t,n):[V.getDomRangeFromRangeCfi(e,t,n)]},this.getDomRangeFromRangeCfi=function(e,t,n){if(V)return V.getDomRangeFromRangeCfi(e,t,n)},this.getRangeCfiFromDomRange=function(e){if(V)return V.getRangeCfiFromDomRange(e)},this.getVisibleCfiFromPoint=function(e,t,n,i){if(V)return V.getVisibleCfiFromPoint(e,t,n,i)},this.getRangeCfiFromPoints=function(e,t,n,i,r){if(V)return V.getRangeCfiFromPoints(e,t,n,i,r)},this.getCfiForElement=function(e){if(V)return V.getCfiForElement(e)},this.getNearestCfiFromElement=function(e){if(V)return V.getNearestCfiFromElement(e)}};return T.VIEW_TYPE_COLUMNIZED=1,T.VIEW_TYPE_FIXED=2,T.VIEW_TYPE_SCROLLED_DOC=3,T.VIEW_TYPE_SCROLLED_CONTINUOUS=4,T}),define("readium-shared-js",function(){}),require(["readium_shared_js/globalsSetup"]);
//# sourceMappingURL=readium-shared-js.js.map